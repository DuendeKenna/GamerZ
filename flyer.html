<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creador de Flyers Digitales</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Inter font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Saira:wght@400;700;900&family=VT323&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-link: #60a5fa;
            --brand-green-333: #42d232;
            --brand-green-222: #95ef81;
            --brand-blueish: #0098e9;
            --brand-orange: #fb923c;
            --brand-violet: #8b5cf6;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #e5e7eb;
            overflow: hidden;
            display: flex;
        }
        
        .font-saira { font-family: 'Saira', sans-serif; }
        .font-vt323 { font-family: 'VT323', monospace; }
        .font-inter { font-family: 'Inter', sans-serif; }

        .section-card-style {
            background-color: rgba(31, 41, 55, 0.9);
            border: 1px solid rgba(75, 85, 99, 0.5);
            border-radius: 0.75rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            padding: 1.5rem;
        }

        .cta-button {
            background: linear-gradient(to right, var(--brand-green-333), var(--brand-green-222));
            border: 2px solid var(--brand-green-333);
            transition: all 0.3s ease;
        }

        .cta-button:hover {
            background: linear-gradient(to right, var(--brand-green-222), var(--brand-green-333));
            transform: scale(1.05);
        }

        #herramientas {
            width: 30%;
            min-width: 350px;
            max-height: 100vh;
            overflow-y: auto;
            padding: 1rem;
            flex-shrink: 0;
        }

        #flyer-section-container {
            flex-grow: 1;
            max-height: 100vh;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }
        
        /* Estilo para las scrollbars */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1f2937;
        }

        ::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 4px;
            border: 2px solid #1f2937;
        }

        ::-webkit-scrollbar-thumb:hover {
            background-color: #6b7280;
        }

        /* Contenedor est√©tico alrededor del flyer */
        #cuadro {
            position: relative;
            padding: 2rem;
            background-color: #1f2937;
            box-shadow: 0 4px 25px rgba(0, 0, 0, 0.6);
            transform-origin: top center;
            transform: scale(0.5);
            transition: transform 0.2s ease-in-out;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            
            /* The dimensions are now set by JavaScript */
        }
        
        /* Estilo base para el flyer */
        #flyer {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            border-radius: 0.75rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            background-color: #13161b;
        }
        
        .flyer-template.droppable {
            border: 2px dashed var(--brand-green-333);
        }

        .flyer-item {
            position: absolute;
            cursor: grab;
            transition: transform 0.2s ease;
        }
        
        .flyer-item.dragging {
            cursor: grabbing;
            z-index: 100;
        }
        
        .flyer-item.active {
            border: 2px dashed var(--brand-blueish);
            box-shadow: 0 0 10px rgba(0, 152, 233, 0.5);
        }

        .flyer-item .item-info {
            position: absolute;
            bottom: -2rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            border-radius: 0.25rem;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .flyer-item:hover .item-info {
            opacity: 1;
        }

        /* Estilos de los selectores */
        .selector-item {
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border-radius: 0.5rem;
            border: 2px solid transparent;
        }

        .selector-item.selected {
            border-color: var(--brand-green-333);
            background-color: rgba(66, 210, 50, 0.1);
        }
        
        .selector-item:hover {
            transform: scale(1.05);
            background-color: rgba(66, 210, 50, 0.05);
        }

        /* Estilo para la tabla de resumen dentro del flyer */
        #component-summary-table-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 600px;
        }

        #component-summary-table-container .resize-handle {
            position: absolute;
            width: 20px;
            height: 20px;
            background: rgba(0, 152, 233, 0.7);
            border-radius: 50%;
            bottom: -10px;
            right: -10px;
            cursor: nwse-resize;
            z-index: 101;
        }
        
        /* Estilo para el bloque de precio final */
        #final-price-value-container {
            position: absolute;
            top: 25%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #e5e7eb;
            white-space: nowrap;
            z-index: 9999;
        }

        #final-price-info-container {
            position: absolute;
            top: 25%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #e5e7eb;
            white-space: nowrap;
            z-index: 9998;
        }

        /* Estilos para el precio final, replicados de index.html */
        .lucas-price {
            font-family: 'Saira', sans-serif;
            font-size: 4rem;
            line-height: 1;
            font-weight: bold;
            color: #22d3ee;
            text-shadow: 2px 2px 55px rgba(0, 0, 0, 0.5), 0 0 20px rgba(118, 18, 143, 0.801), 0 0 55px rgba(34, 211, 238, 0.2), 0 0 25px rgba(34, 211, 238, 0.2);
            animation: price-glow 3s ease-in-out infinite;
        }

        @keyframes price-glow {
            0%, 100% {
                text-shadow: 2px 2px 55px rgba(0, 0, 0, 0.5), 0 0 20px rgba(118, 18, 143, 0.801), 0 0 55px rgba(34, 211, 238, 0.2), 0 0 25px rgba(34, 211, 238, 0.2);
            }
            50% {
                text-shadow: 2px 2px 55px rgba(0, 0, 0, 0.5), 0 0 12px rgba(34, 211, 238, 0.35), 0 0 25px rgba(34, 211, 238, 0.25);
            }
        }
        
        /* Estilo para el texto "La Costa" con sombra */
        .la-costa-shadow {
            text-shadow: 2px 2px 3px black;
        }
        
        .delivery-info {
            color: var(--brand-green-333);
            font-weight: bold;
            text-shadow: 2px 2px 3px black;
        }

        .delivery-city {
            font-size: 1.25rem;
            font-weight: bold;
            color: white;
        }

        .payment-info {
            color: #9ca3af;
            text-shadow: 2px 2px 3px black;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }

        .custom-select-wrapper {
            position: relative;
            width: 100%;
        }

        .custom-select-wrapper::after {
            content: '\f078'; /* Chevron down icon */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            pointer-events: none;
        }

        .custom-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 100%;
            background-color: #374151;
            border: 1px solid #4b5563;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
        }

        /* Estilos para el Modal de administraci√≥n */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }

        .modal-content {
            background-color: #1f2937;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #4b5563;
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }

        .modal-body {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .template-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #374151;
        }

        .template-item:last-child {
            border-bottom: none;
        }

        .template-name {
            cursor: pointer;
            font-weight: bold;
            color: #fff;
            transition: color 0.2s;
        }

        .template-name:hover {
            color: #8b5cf6;
        }
        
        .component-label, .component-price {
            position: absolute;
            padding: 0.5rem;
            font-size: 1.5rem;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
            white-space: nowrap;
            z-index: 10;
        }

        .component-label {
            color: white;
        }
        
        .component-price {
            color: var(--brand-green-333);
        }
        
        .category-row {
            padding: 0.5rem;
            background-color: rgba(31, 41, 55, 0.5);
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: var(--brand-violet);
        }

        .component-row {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
            border-bottom: 1px solid rgba(75, 85, 99, 0.2);
        }
        
        /* Estilos de la barra flotante */
        #flyer-toolbar {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 50;
            background-color: rgba(31, 41, 55, 0.9);
            border: 1px solid rgba(75, 85, 99, 0.5);
            border-radius: 0.75rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            cursor: default;
        }
        
        #flyer-toolbar .drag-handle {
            display: none;
        }

        .resumenPrecio {
            font-size: 1rem;
            font-weight: bold;
            color: #7fd9ff;
            font-family: Saira;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.484);
        }
    </style>
</head>

<body>
    <div class="container mx-auto max-w-7xl flex h-screen">
        <!-- Columna de Herramientas -->
        <aside id="herramientas" class="section-card-style p-6 flex-shrink-0">
            <h2 class="text-3xl font-bold mb-6 text-center text-white font-saira">Herramientas</h2>

            <!-- Selector de Cuadros -->
            <div class="mb-4 flex items-center space-x-2">
                <select id="cuadro-selector" class="w-full custom-select">
                    <!-- Options will be populated by JS -->
                </select>
                <button id="add-cuadro-btn" class="p-2 rounded-md bg-green-600 hover:bg-green-700 transition" title="Agregar Cuadro">
                    <i class="fas fa-plus"></i>
                </button>
                <button id="delete-cuadro-btn" class="p-2 rounded-md bg-red-600 hover:bg-red-700 transition" title="Eliminar Cuadro">
                    <i class="fas fa-trash-alt"></i>
                </button>
                <button id="rename-cuadro-btn" class="p-2 rounded-md bg-yellow-500 hover:bg-yellow-600 transition" title="Renombrar Cuadro">
                    <i class="fas fa-i-cursor"></i>
                </button>
            </div>
            
            <hr class="border-gray-700 my-8">

            <!-- Selector de Categor√≠a de Componentes -->
            <div id="category-section">
                <h3 class="text-xl font-bold text-violet-400 font-saira mb-2">1. Selecciona Categor√≠a</h3>
                <div class="custom-select-wrapper mb-4">
                    <select id="category-selector" class="custom-select">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
            </div>
            
            <!-- Listado de Componentes (Im√°genes) -->
            <div id="image-selector-section">
                <h3 class="text-xl font-bold resumenPrecio font-saira mb-2">2. Arrastra Elementos</h3>
                <div id="image-selector" class="grid grid-cols-3 gap-4">
                    <!-- Componentes filtrados se insertar√°n aqu√≠ -->
                </div>
            </div>

            <hr class="border-gray-700 my-8">

            <!-- Propiedades de Elemento Seleccionado -->
            <div id="properties-section" class="hidden">
                 <h3 class="text-xl font-bold text-orange-400 font-saira mb-2">3. Propiedades</h3>
                <div id="properties-panel" class="space-y-4">
                     <div>
                        <label for="element-name" class="block text-sm font-medium">Elemento:</label>
                        <input type="text" id="element-name" class="w-full p-2 rounded-md bg-gray-800 border border-gray-600 text-gray-200" disabled>
                    </div>
                    <div id="markup-properties" class="hidden">
                        <label for="markup-content" class="block text-sm font-medium">Markup (HTML):</label>
                        <textarea id="markup-content" class="w-full p-2 rounded-md bg-gray-800 border border-gray-600 text-gray-200 h-32" placeholder="Inserta HTML aqu√≠"></textarea>
                        <div class="flex gap-2 mt-2">
                            <button id="open-markup-editor-btn" class="flex-1 py-2 rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Editar Markup</button>
                            <button id="apply-markup-btn" class="flex-1 py-2 rounded-md text-white bg-green-600 hover:bg-green-700">Aplicar Markup</button>
                        </div>
                    </div>
                    <div id="final-price-info-properties" class="hidden">
                        <label for="final-info-1" class="block text-sm font-medium">Informaci√≥n de Entrega - L√≠nea 1</label>
                        <input type="text" id="final-info-1" class="w-full p-2 rounded-md bg-gray-800 border border-gray-600 text-gray-200" />
                        <label for="final-info-2" class="block text-sm font-medium mt-2">Informaci√≥n de Entrega - L√≠nea 2</label>
                        <input type="text" id="final-info-2" class="w-full p-2 rounded-md bg-gray-800 border border-gray-600 text-gray-200" />
                        <label for="final-info-3" class="block text-sm font-medium mt-2">Informaci√≥n de Entrega - L√≠nea 3</label>
                        <input type="text" id="final-info-3" class="w-full p-2 rounded-md bg-gray-800 border border-gray-600 text-gray-200" />
                        <div class="mt-2 text-right">
                            <button id="apply-final-info" class="px-3 py-2 bg-green-600 rounded text-white">Aplicar</button>
                        </div>
                    </div>
                    <div id="h2-properties" class="hidden">
                        <label for="h2-text" class="block text-sm font-medium">Texto Amarillo (Shift+Enter inserta &lt;br&gt;):</label>
                        <textarea id="h2-text" rows="3" class="w-full p-2 rounded-md bg-gray-800 border border-gray-600 text-gray-200" placeholder="¬°ARM√Å TU NAVE!"></textarea>
                        <label for="h2-align" class="block text-sm font-medium mt-2">Alineaci√≥n:</label>
                        <select id="h2-align" class="w-full p-2 rounded-md bg-gray-800 border border-gray-600 text-gray-200">
                            <option value="left">Izquierda</option>
                            <option value="center">Centrada</option>
                            <option value="right">Derecha</option>
                        </select>
                    </div>
                    <div>
                        <label for="pos-x" class="block text-sm font-medium">Posici√≥n X:</label>
                        <input type="number" id="pos-x" class="w-full p-2 rounded-md bg-gray-800 border border-gray-600 text-gray-200">
                    </div>
                    <div>
                        <label for="pos-y" class="block text-sm font-medium">Posici√≥n Y:</label>
                        <input type="number" id="pos-y" class="w-full p-2 rounded-md bg-gray-800 border border-gray-600 text-gray-200">
                    </div>
                    <div id="scale-container">
                        <label for="scale" class="block text-sm font-medium">Tama√±o (0.1 - 8):</label>
                        <input type="number" step="0.1" min="0.1" max="8" id="scale" class="w-full p-2 rounded-md bg-gray-800 border border-gray-600 text-gray-200">
                    </div>
                    <div id="width-container" class="hidden">
                        <label for="width" class="block text-sm font-medium">Ancho del Contenedor (%):</label>
                        <input type="number" step="1" min="10" max="100" id="width" class="w-full p-2 rounded-md bg-gray-800 border border-gray-600 text-gray-200">
                    </div>
                    <div>
                        <label for="z-index" class="block text-sm font-medium">Orden de Capas (Z-Index):</label>
                        <input type="number" id="z-index" class="w-full p-2 rounded-md bg-gray-800 border border-gray-600 text-gray-200">
                    </div>
                    <div class="flex gap-4">
                        <button id="toggle-visibility-btn" class="w-full py-2 rounded-md text-white bg-blue-600 hover:bg-blue-700 transition">
                            <i class="fas fa-eye"></i> Ocultar
                        </button>
                        <button id="delete-btn" class="w-full py-2 rounded-md text-white bg-red-600 hover:bg-red-700 transition">
                            <i class="fas fa-trash"></i> Eliminar
                        </button>
                    </div>
                    <div id="text-options" class="flex flex-col space-y-2">
                        <h4 class="text-lg font-medium text-gray-300">Opciones de Texto</h4>
                        <div class="flex gap-2">
                            <button id="toggle-name-btn" class="flex-1 py-2 rounded-md text-white bg-gray-600 hover:bg-gray-700 transition">
                                <i class="fas fa-tag"></i> Nombre
                            </button>
                            <button id="toggle-price-btn" class="flex-1 py-2 rounded-md text-white bg-gray-600 hover:bg-gray-700 transition">
                                <i class="fas fa-dollar-sign"></i> Precio
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <hr class="border-gray-700 my-8">
            
            <div id="zoom-section">
                <h3 class="text-xl font-bold text-blue-400 font-saira mb-2">Zoom</h3>
                <input type="range" id="zoom-slider" min="0.1" max="1" step="0.05" value="0.75" class="w-full">
            </div>

            <hr class="border-gray-700 my-8">

            <!-- Secci√≥n de Guardar y Cargar actualizada -->
            <div id="save-section" class="text-center space-y-4">
                <h3 class="text-xl font-bold text-violet-400 font-saira mb-2">Guardar y Cargar</h3>
                <div class="flex gap-2">
                    <button id="save-btn" class="w-1/2 py-3 rounded-md text-white bg-violet-600 hover:bg-violet-700 transition font-bold">
                        <i class="fas fa-code"></i> Guardar JSON
                    </button>
                    <button id="load-btn" class="w-1/2 py-3 rounded-md text-white bg-blue-600 hover:bg-blue-700 transition font-bold">
                        <i class="fas fa-clipboard-paste"></i> Cargar JSON
                    </button>
                </div>
            </div>
            
            <hr class="border-gray-700 my-8">
            
             <div id="download-section" class="text-center space-y-4">
                <h3 class="text-xl font-bold text-cyan-400 font-saira mb-2">¬°Descarga!</h3>
                <button id="download-btn" class="w-full cta-button text-white font-bold py-4 rounded-md transition">
                    <i class="fas fa-download"></i> Descargar Imagen
                </button>
                <p class="text-sm text-gray-500 mt-2">La descarga puede tardar unos segundos.</p>
            </div>
        </aside>

        <!-- √Årea de Edici√≥n del Flyer -->
        <section id="flyer-section-container" class="lg:col-span-2 p-6 flex justify-center items-start overflow-y-auto">
            
            <!-- El contenedor principal de cuadros -->
            <div id="cuadros-container"></div> 
                <!-- Los cuadros se renderizar√°n aqu√≠ -->
            </div>
            
        </section>
    </div>

    <!-- Toolbar flotante y oculta por defecto para cada cuadro -->
    <div id="flyer-toolbar" class="flex-col items-center p-4">
        <div class="drag-handle absolute top-0 left-0 w-full h-8 cursor-grab flex justify-end p-2 text-gray-500 hover:text-white transition">
            <i class="fas fa-grip-lines"></i>
        </div>
        
        <!-- Selectores y botones de la toolbar -->
        <div class="flex flex-col items-center space-y-2 mt-4">
            <div class="flex items-center space-x-2">
                <button id="add-summary-btn" class="p-2 rounded-md text-white bg-blue-600 hover:bg-blue-700 transition" title="Agregar Resumen">
                    <i class="fas fa-list-ul"></i>
                </button>
                <button id="add-price-btn" class="p-2 rounded-md text-white bg-blue-600 hover:bg-blue-700 transition" title="Agregar Precio Final">
                    <i class="fas fa-dollar-sign"></i>
                </button>
                <button id="add-info-btn" class="p-2 rounded-md text-white bg-blue-600 hover:bg-blue-700 transition" title="Agregar Info de Entrega">
                    <i class="fas fa-info-circle"></i>
                </button>
                <button id="clear-flyer-btn" class="p-2 rounded-md text-white bg-gray-600 hover:bg-gray-700 transition" title="Limpiar Cuadro">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            <div id="flyer-size-selector-wrapper" class="mt-4">
                 <select id="flyer-size-selector" class="w-full custom-select">
                    <option value="1080x1080">1080x1080</option>
                    <option value="1080x1350">1080x1350</option>
                    <option value="1080x1920">1080x1920</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Placeholder para mensajes de estado -->
    <div id="status-message" class="fixed bottom-4 left-1/2 -translate-x-1/2 p-4 bg-gray-800 rounded-lg shadow-lg text-white text-center hidden z-50"></div>
    

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html-to-image@1.10.3/dist/html-to-image.umd.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const categorySelector = document.getElementById('category-selector');
            const imageSelector = document.getElementById('image-selector');
            const cuadrosContainer = document.getElementById('cuadros-container');
            const downloadBtn = document.getElementById('download-btn');
            const statusMessageEl = document.getElementById('status-message');
            const propertiesPanel = document.getElementById('properties-panel');
            const elementNameInput = document.getElementById('element-name');
            const posXInput = document.getElementById('pos-x');
            const posYInput = document.getElementById('pos-y');
            const scaleInput = document.getElementById('scale');
            const widthInput = document.getElementById('width');
            const zIndexInput = document.getElementById('z-index');
            const toggleVisibilityBtn = document.getElementById('toggle-visibility-btn');
            const deleteBtn = document.getElementById('delete-btn');
            const zoomSlider = document.getElementById('zoom-slider');
            const saveBtn = document.getElementById('save-btn');
            const loadBtn = document.getElementById('load-btn');
            const cuadroSelector = document.getElementById('cuadro-selector');
            const addCuadroBtn = document.getElementById('add-cuadro-btn');
            const deleteCuadroBtn = document.getElementById('delete-cuadro-btn');
            const flyerToolbar = document.getElementById('flyer-toolbar');
            let cuadroEl; // Declare cuadroEl here

            
            // Toolbar elements
            const toolbarAddSummaryBtn = document.getElementById('add-summary-btn');
            const toolbarAddPriceBtn = document.getElementById('add-price-btn');
            const toolbarAddInfoBtn = document.getElementById('add-info-btn');
            const toolbarClearFlyerBtn = document.getElementById('clear-flyer-btn');
            const toolbarAddMarkupBtn = document.createElement('button');
            toolbarAddMarkupBtn.id = 'add-markup-btn';
            toolbarAddMarkupBtn.className = 'p-2 rounded-md text-white bg-blue-600 hover:bg-blue-700 transition';
            toolbarAddMarkupBtn.title = 'Agregar Markup';
            toolbarAddMarkupBtn.innerHTML = '<i class="fas fa-code"></i>';
            const toolbarSizeSelector = document.getElementById('flyer-size-selector');
            const toggleNameBtn = document.getElementById('toggle-name-btn');
            const togglePriceBtn = document.getElementById('toggle-price-btn');
            const toolbarAddH2Btn = document.createElement('button');
            toolbarAddH2Btn.id = 'add-h2-btn';
            toolbarAddH2Btn.className = 'p-2 rounded-md text-white bg-blue-600 hover:bg-blue-700 transition';
            toolbarAddH2Btn.title = 'Agregar H2';
            toolbarAddH2Btn.innerHTML = '<i class="fas fa-heading"></i>';
            const toolbarAddMemeBtn = document.createElement('button');
            toolbarAddMemeBtn.id = 'add-meme-btn';
            toolbarAddMemeBtn.className = 'p-2 rounded-md text-white bg-blue-600 hover:bg-blue-700 transition';
            toolbarAddMemeBtn.title = 'Agregar Meme';
            toolbarAddMemeBtn.innerHTML = '<i class="fas fa-image"></i>';

            const toolbarAddFechaBtn = document.createElement('button');
            toolbarAddFechaBtn.id = 'add-fecha-btn';
            toolbarAddFechaBtn.className = 'p-2 rounded-md text-white bg-blue-600 hover:bg-blue-700 transition';
            toolbarAddFechaBtn.title = 'Agregar Fecha';
            toolbarAddFechaBtn.innerHTML = '<i class="fas fa-calendar-day"></i>';

            let data = null;
            let currentDesign = null;
            let selectedFlyerItem = null;
            let currentCuadroId = null;
            let allCuadros = [];
            let addedComponents = []; 
            const MIN_SCALE = 0.1;
            const MAX_SCALE = 8;
            const INITIAL_IMAGE_SCALE = 1.33;
            const BASE_SERVICE_PRICE = 110000;
            let memeFilenamesCache = null;
            // Exact filenames discovered in the workspace `memes/` folder.
            const MEME_FILES = [
                'PAS09790_OP.webp','PAS09793_OP.webp','PAS09795_OP.webp','PAS09796_OP.webp','PAS09798_OP.webp','PAS09800_OP.webp','PAS09804_OP.webp','PAS09805_OP.webp','PAS09806_OP.webp','PAS09807_OP.webp','PAS09810_OP.webp','PAS09811_OP.webp','PAS09813_OP.webp','PAS09814_OP.webp','PAS09815_OP.webp','PAS09816_OP.webp','PAS09818_OP.webp','PAS09828_OP.webp','PAS09832_OP.webp','PAS09834_OP.webp','PAS09837_OP.webp','PAS09839_OP.webp','PAS09840_OP.webp','PAS09845_OP.webp','PAS09846_OP.webp','PAS09847_OP.webp','PAS09849_OP.webp','PAS09854_OP.webp','PAS09856_OP.webp','PAS09857_OP.webp','PAS09861_OP.webp','PAS09863_OP.webp','PAS09865_OP.webp','PAS09867_OP.webp','PAS09869_OP.webp','PAS09872_OP.webp','PAS09873_OP.webp','PAS09874_OP.webp','PAS09877_OP.webp','PAS09878_OP.webp','PAS09886_OP.webp','PAS09888_OP.webp','PAS09889_OP.webp','PAS09891_OP.webp','PAS09892_OP.webp','PAS09893_OP.webp','PAS09895_OP.webp','PAS09903_OP.webp','PAS09904_OP.webp','PAS09908_OP.webp','PAS09909_OP.webp','PAS09912_OP.webp','PAS09916_OP.webp','PAS09917_OP.webp','PAS09918_OP.webp','PAS09919_OP.webp','PAS09921_OP.webp','PAS09933_OP.webp','PAS09937_OP.webp','PAS09938_OP.webp','PAS09941_OP.webp','PAS09943_OP.webp','PAS09949_OP.webp','PAS09950_OP.webp','PAS09953_OP.webp','PAS09954_OP.webp','PAS09955_OP.webp','PAS09963_OP.webp','PAS09964_OP.webp','PAS09965_OP.webp','PAS09966_OP.webp','PAS09970_OP.webp','PAS09973_OP.webp','PAS09974_OP.webp','PAS09975_OP.webp','PAS09976_OP.webp','PAS09977_OP.webp','PAS09978_OP.webp','PAS09979_OP.webp','PAS09980_OP.webp','PAS09986_OP.webp','PAS09987_OP.webp','PAS09990_OP.webp','PAS09991_OP.webp','PAS09992_OP.webp','PAS09993_OP.webp','PAS09995_OP.webp'
            ];

            // Default placeholder for empty markup elements
            const DEFAULT_MARKUP_PLACEHOLDER = `<p class="markup-placeholder" style="color:#9ca3af;margin:0;">Haz clic en \"Editar Markup\" para agregar contenido.</p>`;

            // Collection of base elements used in the editor
            const baseElementData = {
                'summary-table': {
                    id: 'summary-table',
                    name: 'Resumen de Componentes',
                    html: `
                        <h3 class="text-2xl font-bold mb-4 text-center font-saira cursor-text" contenteditable="true">Resumen de Componentes</h3>
                        <table class="w-full text-left table-auto">
                            <thead class="border-b-2 border-gray-600">
                                <tr>
                                    <th class="py-2 text-violet-400 font-saira">Componente</th>
                                    <th class="py-2 text-right resumenPrecio font-saira">Precio (ARS)</th>
                                </tr>
                            </thead>
                            <tbody class="component-table-body">
                                <!-- Filas de componentes se insertar√°n aqu√≠ din√°micamente -->
                            </tbody>
                        </table>
                    `
                },
                'final-price-value': {
                    id: 'final-price-value',
                    name: 'Precio Final',
                    html: `<div><p class="lucas-price text-center">$0</p></div>`,
                    js: `
                      const lucas = document.querySelector('#final-price-value');
                      if (lucas) {
                        lucas.classList.add('lucas-price');
                      }
                    `
                },
                'final-price-info': {
                    id: 'final-price-info',
                    name: 'Informaci√≥n de Entrega',
                    html: `
                        <p class="delivery-info text-center mt-4 font-inter text-base">
                            Entrega Personal a Domicilio
                        </p>
                        <p class="delivery-city text-center mt-1 font-inter text-base">
                            en toda <strong class="text-white la-costa-shadow">La Costa üåä</strong>
                        </p>
                        <p class="payment-info text-center mt-4 font-inter text-xs">
                            Consultar opciones en cuotas x MP
                        </p>
                    `
                },
                'meme': {
                    id: 'meme',
                    name: 'Meme',
                    html: `<div><img src="memes/PAS09795_OP.webp" alt="Meme" class="meme-image w-full h-full object-contain"></div>`,
                    js: `
                        const memeElement = document.querySelector('#meme');
                        if (memeElement) {
                            memeElement.style.width = '600px';
                            memeElement.style.height = '600px';
                        }
                    `
                }
                ,
                'fecha': {
                    id: 'fecha',
                    name: 'Fecha',
                    html: `<div class="fecha-text font-saira" style="font-size:1.25rem;">Fecha</div>`,
                    js: `
                        (function(){
                            const dias = ['Domingo','Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado'];
                            function setFecha(){
                                const el = document.querySelector('#fecha');
                                if (!el) return;
                                const now = new Date();
                                const diaNombre = dias[now.getDay()];
                                const d = now.getDate();
                                const m = now.getMonth() + 1;
                                const textEl = el.querySelector('.fecha-text') || el;
                                // Format: 'Lunes 4/5' (day D/M without leading zeros)
                                textEl.textContent = diaNombre + ' ' + d + '/' + m;
                                textEl.style.color = '#ffffff';
                                el.style.background = 'transparent';
                                el.style.opacity = '0.5';
                            }
                            try { setFecha(); } catch(e){}
                            document.addEventListener('DOMContentLoaded', setFecha);
                        })();
                    `
                },
                'markup': {
                    id: 'markup',
                    name: 'Markup',
                    html: `<div class="markup-content" style="width:100%;height:100%;">${DEFAULT_MARKUP_PLACEHOLDER}</div>`,
                    js: `
                        (function(){
                            // placeholder for markup initialization
                        })();
                    `
                }
                ,
                'h2': {
                    id: 'h2',
                    name: 'Amarillo',
                    html: `<h2 class="relative z-40 font-saira font-bold text-center text-4xl lg:text-5xl" style="color: #FFD700; text-shadow: 0 2px 12px #000a; letter-spacing: 1px;">¬°ARM√Å TU NAVE!</h2>`,
                    js: `
                        (function(){
                            // H2 base element initialization if needed
                        })();
                    `
                }
            };

            // Map of category keys to readable names used by the selector and dataset.itemType
            const categoryMap = {
                baseOptions: { name: 'Bases' },
                armadasOptions: { name: 'Armadas' },
                miniPcOptions: { name: 'MiniPCs' },
                towersOptions: { name: 'Torres' },
                comboOptions: { name: 'Combos' },
                cpuOptions: { name: 'CPU' },
                motherboardOptions: { name: 'Mother' },
                ramOptions: { name: 'RAM' },
                gpuOptions: { name: 'GPU' },
                ssdOptions: { name: 'SSD' },
                psuOptions: { name: 'PSU' },
                monitorOptions: { name: 'Monitores' },
                mouseOptions: { name: 'Mouse' },
                joystickOptions: { name: 'Joysticks' },
                keyboardOptions: { name: 'Teclados' },
                comboMouseTecladoOptions: { name: 'M+T' },
                auricularesOptions: { name: 'Auris' },
                parlantesOptions: { name: 'Parlantes' },
                webcamOptions: { name: 'Webcams' },
                microfonosOptions: { name: 'Mics' },
                wifiOptions: { name: 'WiFi' },
                arosDeLuzOptions: { name: 'Luz' }
            };

            // Helper: build meme filenames or fetch a manifest if available
            async function getMemeFilenames() {
                if (memeFilenamesCache && Array.isArray(memeFilenamesCache) && memeFilenamesCache.length) return memeFilenamesCache;
                memeFilenamesCache = MEME_FILES.slice();
                return memeFilenamesCache;
            }

            // Popup selector for meme images
            async function setupMemePopup(memeElement) {
                // Avoid attaching multiple listeners
                if (memeElement._memePopupAttached) return;
                memeElement._memePopupAttached = true;

                memeElement.addEventListener('dblclick', async (e) => {
                    e.stopPropagation();
                    const filenames = await getMemeFilenames();

                    // Modal background
                    const modal = document.createElement('div');
                    modal.className = 'fixed inset-0 z-50 flex items-center justify-center';
                    modal.style.background = 'rgba(0,0,0,0.7)';

                    // Content box matching dark theme
                    const box = document.createElement('div');
                    box.style.background = '#111827';
                    box.style.color = '#e5e7eb';
                    box.style.border = '1px solid rgba(75,85,99,0.5)';
                    box.style.borderRadius = '8px';
                    box.style.padding = '16px';
                    box.style.maxWidth = '900px';
                    box.style.width = '95%';
                    box.style.maxHeight = '80vh';
                    box.style.overflow = 'hidden';

                    const header = document.createElement('div');
                    header.style.display = 'flex';
                    header.style.justifyContent = 'space-between';
                    header.style.alignItems = 'center';
                    header.style.marginBottom = '8px';
                    const title = document.createElement('h3');
                    title.textContent = 'Seleccionar Meme';
                    title.style.margin = '0';
                    title.style.fontSize = '1.1rem';
                    title.style.fontWeight = '700';
                    const closeBtn = document.createElement('button');
                    closeBtn.textContent = 'Cerrar';
                    closeBtn.style.background = 'linear-gradient(to right, #42d232, #95ef81)';
                    closeBtn.style.border = 'none';
                    closeBtn.style.color = '#081018';
                    closeBtn.style.padding = '6px 10px';
                    closeBtn.style.borderRadius = '6px';
                    closeBtn.addEventListener('click', () => document.body.removeChild(modal));
                    header.appendChild(title);
                    header.appendChild(closeBtn);

                    const listWrap = document.createElement('div');
                    listWrap.style.overflow = 'auto';
                    listWrap.style.maxHeight = '60vh';

                    // Diagnostics area
                    const diag = document.createElement('div');
                    diag.style.display = 'flex';
                    diag.style.justifyContent = 'space-between';
                    diag.style.alignItems = 'center';
                    diag.style.marginBottom = '10px';

                    const diagInfo = document.createElement('div');
                    diagInfo.style.color = '#9ca3af';
                    diagInfo.style.fontSize = '13px';
                    diagInfo.textContent = 'Cargando miniaturas...';

                    const recheckBtn = document.createElement('button');
                    recheckBtn.textContent = 'Revisar faltantes';
                    recheckBtn.style.background = 'transparent';
                    recheckBtn.style.color = '#9be7a6';
                    recheckBtn.style.border = '1px solid rgba(156,163,175,0.12)';
                    recheckBtn.style.padding = '6px 8px';
                    recheckBtn.style.borderRadius = '6px';
                    recheckBtn.style.cursor = 'pointer';

                    diag.appendChild(diagInfo);
                    diag.appendChild(recheckBtn);

                    const grid = document.createElement('div');
                    grid.style.display = 'grid';
                    grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(140px, 1fr))';
                    grid.style.gap = '12px';

                    const failedSet = new Set();

                    // Helper to check a URL quickly
                    async function checkUrl(url) {
                        try {
                            const resp = await fetch(url, { method: 'GET' });
                            return resp.ok;
                        } catch (err) {
                            return false;
                        }
                    }

                    filenames.forEach(name => {
                        const tile = document.createElement('div');
                        tile.style.background = '#0b1220';
                        tile.style.border = '1px solid rgba(255,255,255,0.04)';
                        tile.style.borderRadius = '6px';
                        tile.style.padding = '8px';
                        tile.style.cursor = 'pointer';
                        tile.style.display = 'flex';
                        tile.style.flexDirection = 'column';
                        tile.style.alignItems = 'center';
                        tile.style.justifyContent = 'center';

                        const thumb = document.createElement('div');
                        thumb.style.width = '100%';
                        thumb.style.height = '110px';
                        thumb.style.display = 'flex';
                        thumb.style.alignItems = 'center';
                        thumb.style.justifyContent = 'center';
                        thumb.style.background = '#0f1724';
                        thumb.style.borderRadius = '4px';

                        const img = document.createElement('img');
                        img.style.maxWidth = '100%';
                        img.style.maxHeight = '100%';
                        img.style.objectFit = 'contain';
                        img.alt = name;
                        // Preload image and detect failure
                        const imgUrl = `memes/${name}`;
                        img.src = imgUrl;
                        img.onload = () => { /* loaded */ };
                        img.onerror = () => {
                            // Show N/A placeholder
                            img.src = '';
                            thumb.textContent = 'N/A';
                            thumb.style.color = '#e5e7eb';
                            thumb.style.fontWeight = '700';
                            failedSet.add(name);
                            diagInfo.textContent = `${failedSet.size} faltantes`; 
                        };

                        thumb.appendChild(img);
                        const label = document.createElement('div');
                        label.textContent = name;
                        label.style.fontSize = '11px';
                        label.style.color = '#9ca3af';
                        label.style.marginTop = '8px';
                        label.style.wordBreak = 'break-all';
                        label.style.textAlign = 'center';

                        tile.appendChild(thumb);
                        tile.appendChild(label);

                        tile.addEventListener('click', () => {
                            const memeImage = memeElement.querySelector('.meme-image');
                            if (memeImage) {
                                memeElement.dataset.imageName = name;
                                memeImage.src = `memes/${name}`;
                                memeImage.onerror = () => { memeImage.src = 'https://placehold.co/600x600/374151/ffffff?text=Image+Not+Found'; };
                            }
                            document.body.removeChild(modal);
                            if (selectedFlyerItem === memeElement) updatePropertiesPanel();
                            saveCurrentDesign();
                        });

                        grid.appendChild(tile);
                    });

                    listWrap.appendChild(diag);
                    listWrap.appendChild(grid);

                    // Create missing list area (hidden until needed)
                    const missingList = document.createElement('div');
                    missingList.style.color = '#fca5a5';
                    missingList.style.marginTop = '8px';
                    missingList.style.display = 'none';
                    box.appendChild(missingList);

                    // Recheck button handler: verify failed filenames and update list
                    recheckBtn.addEventListener('click', async () => {
                        diagInfo.textContent = 'Revisando...';
                        const failed = [];
                        // Check each failed or all filenames (prefer failed set)
                        const namesToCheck = failedSet.size ? Array.from(failedSet) : filenames.slice(0, 99);
                        for (const n of namesToCheck) {
                            const ok = await checkUrl(`memes/${n}`);
                            if (!ok) failed.push(n);
                        }
                        if (failed.length) {
                            missingList.style.display = 'block';
                            missingList.textContent = `Archivos faltantes (${failed.length}): ` + failed.join(', ');
                            diagInfo.textContent = `${failed.length} faltantes`;
                        } else {
                            missingList.style.display = 'block';
                            missingList.style.color = '#86efac';
                            missingList.textContent = 'Todos los archivos existen (OK).';
                            diagInfo.textContent = 'Todos cargados';
                        }
                    });
                    box.appendChild(header);
                    box.appendChild(listWrap);
                    modal.appendChild(box);
                    document.body.appendChild(modal);
                });
            }


            // --- Funciones de Utilidad ---
            function getPrice(item) {
                // FIX: Check for the `total` field first for "Bases", otherwise use the first element of the `prices` array.
                if (item.total) {
                    return item.total;
                }
                return (item.prices && item.prices.length > 0) ? item.prices[0].value : 0;
            }
            
            function showMessage(message, duration = 3000) {
                statusMessageEl.textContent = message;
                statusMessageEl.classList.remove('hidden');
                if (duration > 0) {
                    setTimeout(() => statusMessageEl.classList.add('hidden'), duration);
                }
            }
            
            function setupDraggableElement(element) {
                let isDragging = false;
                let startX, startY, startTop, startLeft;
                
                element.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('.flyer-item').forEach(item => item.classList.remove('active'));
                    element.classList.add('active');
                    selectedFlyerItem = element;
                    updatePropertiesPanel();
                    isDragging = true;
                    element.classList.add('dragging');
                    startX = e.clientX;
                    startY = e.clientY;
                    startTop = element.offsetTop;
                    startLeft = element.offsetLeft;
                });
                
                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    const deltaX = e.clientX - startX;
                    const deltaY = e.clientY - startY;
                    element.style.top = `${startTop + deltaY}px`;
                    element.style.left = `${startLeft + deltaX}px`;
                    updatePropertiesPanel();
                });

                document.addEventListener('mouseup', () => {
                    if (isDragging) {
                        isDragging = false;
                        element.classList.remove('dragging');
                    }
                });
            }

            // --- L√≥gica del Sistema de Cuadros (multi-cuadro) ---
            function createNewCuadro(name, width = 1080, height = 1080) {
                const id = `cuadro-${Date.now()}`;
                const newCuadro = {
                    id: id,
                    name: name,
                    width: width,
                    height: height,
                    elements: [],
                };
                allCuadros.push(newCuadro);
                renderCuadrosSelector();
                switchCuadro(id);
                showMessage(`Nuevo cuadro "${name}" creado.`, 3000);
            }

            function deleteCurrentCuadro() {
                if (allCuadros.length <= 1) {
                    showMessage("No puedes eliminar el √∫ltimo cuadro.", 3000);
                    return;
                }
                const currentCuadroIndex = allCuadros.findIndex(c => c.id === currentCuadroId);
                if (currentCuadroIndex !== -1) {
                    allCuadros.splice(currentCuadroIndex, 1);
                    renderCuadrosSelector();
                    switchCuadro(allCuadros[0].id);
                    showMessage(`Cuadro eliminado.`, 3000);
                }
            }

            function renderCuadrosSelector() {
                cuadroSelector.innerHTML = '';
                allCuadros.forEach(cuadro => {
                    const option = document.createElement('option');
                    option.value = cuadro.id;
                    option.textContent = cuadro.name;
                    cuadroSelector.appendChild(option);
                });
                if (currentCuadroId) {
                    cuadroSelector.value = currentCuadroId;
                }
            }
            
            function switchCuadro(cuadroId) {
                const selectedCuadro = allCuadros.find(c => c.id === cuadroId);
                if (!selectedCuadro) return;
                
                // Save current state before switching
                if (currentDesign) {
                    saveCurrentDesign();
                }

                currentCuadroId = cuadroId;
                currentDesign = selectedCuadro;
                
                renderCuadro(selectedCuadro);
                updatePropertiesPanel();
            }

            function renderCuadro(cuadro) {
                // Update cuadroEl reference
                cuadroEl = document.getElementById('cuadro');
                if (!cuadroEl) {
                    cuadroEl = document.createElement('div');
                    cuadroEl.id = 'cuadro';
                    cuadrosContainer.appendChild(cuadroEl);
                }
                
                // Clear previous elements
                let flyerEl = cuadroEl.querySelector('#flyer');
                if (flyerEl) {
                    flyerEl.remove();
                }

                flyerEl = document.createElement('div');
                flyerEl.id = 'flyer';
                flyerEl.className = "relative overflow-hidden rounded-lg shadow-2xl bg-[#13161b] cursor-default";
                cuadroEl.appendChild(flyerEl);
                
                // Set precise dimensions
                cuadroEl.style.width = `${cuadro.width}px`;
                cuadroEl.style.height = `${cuadro.height}px`;

                flyerEl.addEventListener('dragover', handleDragOver);
                flyerEl.addEventListener('dragleave', handleDragLeave);
                flyerEl.addEventListener('drop', handleDrop);
                flyerEl.addEventListener('click', handleDeselect);
                flyerEl.addEventListener('wheel', handleWheel);

                addedComponents = [];
                if (cuadro.elements) {
                    cuadro.elements.forEach(elData => loadElement(elData));
                }
                
                updateBaseElements();
                
                // Set the toolbar position to fixed bottom-right
                flyerToolbar.style.top = '';
                flyerToolbar.style.left = '';
                flyerToolbar.style.bottom = '1rem';
                flyerToolbar.style.right = '1rem';
                flyerToolbar.style.transform = '';
                
                if (cuadro.width && cuadro.height) {
                    toolbarSizeSelector.value = `${cuadro.width}x${cuadro.height}`;
                }
                
                flyerToolbar.classList.remove('hidden');
            }

            // Execute optional JS snippets defined in `baseElementData[*].js`
            function executeBaseElementScripts() {
                Object.keys(baseElementData).forEach(key => {
                    const js = baseElementData[key].js;
                    if (!js) return;
                    try {
                        const fn = new Function(js);
                        fn();
                    } catch (err) {
                        console.error('Error executing base element script for', key, err);
                    }
                });
            }
            
            function saveCurrentDesign() {
                if (!currentDesign) return;
                currentDesign.elements = [];
                const flyerItems = document.querySelectorAll('#flyer .flyer-item');
                flyerItems.forEach(item => {
                    const component = addedComponents.find(c => c.element === item);
                    if (!component) {
                        return;
                    }

                    const isBaseElement = component.isBaseElement;
                    const itemData = {
                        id: item.dataset.itemId,
                        name: item.dataset.itemName,
                        type: isBaseElement ? 'base' : item.dataset.itemType,
                        price: component.price, 
                        summaryTitle: (item.dataset.itemId === "summary-table") ? item.querySelector('h3').textContent : null,
                        style: item.style.cssText,
                        nameElementState: component.nameElement ? component.nameElement.style.cssText : null,
                        priceElementState: component.priceElement ? component.priceElement.style.cssText : null,
                        imageName: item.dataset.imageName || null,
                        markup: item.dataset.markup || null,
                        h2Text: item.dataset.itemId === 'h2' ? (item.querySelector('h2') ? item.querySelector('h2').innerHTML : null) : null
                    };
                    // Persist the three paragraph texts for final-price-info base element
                    if (item.dataset.itemId === 'final-price-info') {
                        try {
                            const pEls = item.querySelectorAll('p');
                            itemData.finalInfo1 = pEls[0] ? pEls[0].innerHTML : null;
                            itemData.finalInfo2 = pEls[1] ? pEls[1].innerHTML : null;
                            itemData.finalInfo3 = pEls[2] ? pEls[2].innerHTML : null;
                        } catch (e) {
                            itemData.finalInfo1 = itemData.finalInfo2 = itemData.finalInfo3 = null;
                        }
                    }
                    // Persist H2 alignment
                    if (item.dataset.itemId === 'h2') {
                        try {
                            const h2El = item.querySelector('h2') || item;
                            itemData.h2Align = h2El ? (h2El.style.textAlign || null) : null;
                        } catch(e) { itemData.h2Align = null; }
                    }
                    currentDesign.elements.push(itemData);
                });
                const cuadroEl = document.getElementById('cuadro');
                if (cuadroEl) {
                    currentDesign.width = parseInt(cuadroEl.style.width);
                    currentDesign.height = parseInt(cuadroEl.style.height);
                }
            }

            // --- L√≥gica de Manejo de Propiedades ---
            function updatePropertiesPanel() {
                if (selectedFlyerItem) {
                    document.getElementById('properties-section').classList.remove('hidden');
                    elementNameInput.value = selectedFlyerItem.dataset.itemName;
                    posXInput.value = parseInt(selectedFlyerItem.offsetLeft);
                    posYInput.value = parseInt(selectedFlyerItem.offsetTop);
                    
                    const isSummary = selectedFlyerItem.dataset.itemId === 'summary-table';
                    if (isSummary) {
                        // Enable editing the name for the summary title
                        elementNameInput.disabled = false;
                        elementNameInput.value = selectedFlyerItem.querySelector('h3') ? selectedFlyerItem.querySelector('h3').textContent : selectedFlyerItem.dataset.itemName;

                        document.getElementById('scale-container').classList.add('hidden');
                        document.getElementById('width-container').classList.remove('hidden');
                        widthInput.value = parseFloat(selectedFlyerItem.style.width);
                        document.getElementById('text-options').classList.add('hidden');
                    } else {
                        // Non-summary elements: keep name input disabled
                        elementNameInput.disabled = true;
                        document.getElementById('scale-container').classList.remove('hidden');
                        document.getElementById('width-container').classList.add('hidden');
                        const scaleMatch = selectedFlyerItem.style.transform.match(/scale\((.*?)\)/);
                        const scale = scaleMatch ? parseFloat(scaleMatch[1]) : 1;
                        scaleInput.value = scale;
                        document.getElementById('text-options').classList.remove('hidden');
                    }
                    zIndexInput.value = selectedFlyerItem.style.zIndex || 10;
                    const isVisible = selectedFlyerItem.style.opacity !== '0';
                    toggleVisibilityBtn.innerHTML = isVisible ? '<i class="fas fa-eye-slash"></i> Ocultar' : '<i class="fas fa-eye"></i> Mostrar';
                        // Show markup properties when selecting a markup base element
                        const markupProps = document.getElementById('markup-properties');
                        if (markupProps) {
                            if (selectedFlyerItem.dataset.itemId === 'markup') {
                                markupProps.classList.remove('hidden');
                                const ta = document.getElementById('markup-content');
                                ta.value = selectedFlyerItem.dataset.markup || '';
                            } else {
                                markupProps.classList.add('hidden');
                            }
                        }
                        // Show final-price-info properties
                        const finalInfoProps = document.getElementById('final-price-info-properties');
                        if (finalInfoProps) {
                            if (selectedFlyerItem.dataset.itemId === 'final-price-info') {
                                finalInfoProps.classList.remove('hidden');
                                const f1 = document.getElementById('final-info-1');
                                const f2 = document.getElementById('final-info-2');
                                const f3 = document.getElementById('final-info-3');
                                const pEls = selectedFlyerItem.querySelectorAll('p');
                                f1.value = pEls[0] ? pEls[0].innerHTML : '';
                                f2.value = pEls[1] ? pEls[1].innerHTML : '';
                                f3.value = pEls[2] ? pEls[2].innerHTML : '';
                            } else {
                                finalInfoProps.classList.add('hidden');
                            }
                        }
                        // Show H2 properties
                        const h2Props = document.getElementById('h2-properties');
                        if (h2Props) {
                            if (selectedFlyerItem.dataset.itemId === 'h2') {
                                h2Props.classList.remove('hidden');
                                const h2Input = document.getElementById('h2-text');
                                const h2El = selectedFlyerItem.querySelector('h2') || selectedFlyerItem;
                                h2Input.value = h2El ? h2El.innerHTML : '';
                                const h2AlignSelect = document.getElementById('h2-align');
                                if (h2AlignSelect && h2El) {
                                    h2AlignSelect.value = h2El.style.textAlign || 'center';
                                }
                            } else {
                                h2Props.classList.add('hidden');
                            }
                        }
                } else {
                    document.getElementById('properties-section').classList.add('hidden');
                }

                // Meme image is changed with Left/Right arrows or double-click popup
                // Remove any old meme input remnants if present
                const existingInput = document.getElementById('meme-image-input');
                const existingLabel = document.querySelector('label[for="meme-image-input"]');
                if (existingInput) existingInput.remove();
                if (existingLabel) existingLabel.remove();
                
                // Wire elementNameInput change for summary table
                elementNameInput.removeEventListener('input', elementNameInput._onInputHandler || (()=>{}));
                elementNameInput._onInputHandler = function () {
                    if (!selectedFlyerItem) return;
                    if (selectedFlyerItem.dataset.itemId !== 'summary-table') return;
                    const h3 = selectedFlyerItem.querySelector('h3');
                    if (h3) h3.textContent = elementNameInput.value;
                    // update saved data
                    saveCurrentDesign();
                };
                elementNameInput.addEventListener('input', elementNameInput._onInputHandler);
            }

            // --- Event Listeners para Propiedades ---
            posXInput.addEventListener('input', () => { if (selectedFlyerItem) selectedFlyerItem.style.left = `${posXInput.value}px`; });
            posYInput.addEventListener('input', () => { if (selectedFlyerItem) selectedFlyerItem.style.top = `${posYInput.value}px`; });
            scaleInput.addEventListener('input', () => { if (selectedFlyerItem) selectedFlyerItem.style.transform = `scale(${Math.max(MIN_SCALE, Math.min(MAX_SCALE, parseFloat(scaleInput.value)))})`; });
            widthInput.addEventListener('input', () => { if (selectedFlyerItem && selectedFlyerItem.dataset.itemId === 'summary-table') selectedFlyerItem.style.width = `${Math.max(10, Math.min(100, parseFloat(widthInput.value)))}%`; });
            zIndexInput.addEventListener('input', () => { if (selectedFlyerItem) selectedFlyerItem.style.zIndex = zIndexInput.value; });
            // H2 text change
            const h2TextInput = document.getElementById('h2-text');
            if (h2TextInput) {
                // When user presses Shift+Enter, insert a literal <br> at the cursor position
                h2TextInput.addEventListener('keydown', (ev) => {
                    if (ev.key === 'Enter' && ev.shiftKey) {
                        ev.preventDefault();
                        const el = ev.target;
                        const start = el.selectionStart;
                        const end = el.selectionEnd;
                        const value = el.value;
                        // Insert a placeholder for <br> which we'll convert when applying
                        const insertText = '\\n';
                        el.value = value.slice(0, start) + insertText + value.slice(end);
                        el.selectionStart = el.selectionEnd = start + insertText.length;
                        // Trigger input event handler
                        el.dispatchEvent(new Event('input'));
                    }
                });

                h2TextInput.addEventListener('input', () => {
                    if (!selectedFlyerItem || selectedFlyerItem.dataset.itemId !== 'h2') return;
                    const h2El = selectedFlyerItem.querySelector('h2') || selectedFlyerItem;
                    if (h2El) {
                        // Convert newline placeholders to <br> and preserve other text
                        // We convert actual newlines as well for safety
                        const raw = h2TextInput.value || '';
                        const html = raw.replace(/\r\n|\r|\n/g, '<br>');
                        h2El.innerHTML = html;
                    }
                    // Persist
                    saveCurrentDesign();
                });
            }

            // H2 alignment control
            const h2AlignSelect = document.getElementById('h2-align');
            if (h2AlignSelect) {
                h2AlignSelect.addEventListener('change', () => {
                    if (!selectedFlyerItem || selectedFlyerItem.dataset.itemId !== 'h2') return;
                    const h2El = selectedFlyerItem.querySelector('h2') || selectedFlyerItem;
                    if (h2El) {
                        h2El.style.textAlign = h2AlignSelect.value;
                    }
                    saveCurrentDesign();
                });
            }

            // Final-price-info apply handler
            const applyFinalBtn = document.getElementById('apply-final-info');
            if (applyFinalBtn) {
                applyFinalBtn.addEventListener('click', () => {
                    if (!selectedFlyerItem || selectedFlyerItem.dataset.itemId !== 'final-price-info') return;
                    const f1 = document.getElementById('final-info-1');
                    const f2 = document.getElementById('final-info-2');
                    const f3 = document.getElementById('final-info-3');
                    const pEls = selectedFlyerItem.querySelectorAll('p');
                    try {
                        if (pEls[0]) pEls[0].innerHTML = f1.value;
                        if (pEls[1]) pEls[1].innerHTML = f2.value;
                        if (pEls[2]) pEls[2].innerHTML = f3.value;
                    } catch (e) {
                        console.error('Failed to apply final-price-info texts', e);
                    }
                    saveCurrentDesign();
                });
            }
            
            toggleNameBtn.addEventListener('click', () => {
                const component = addedComponents.find(c => c.element === selectedFlyerItem);
                if (component && component.nameElement) {
                    component.nameElement.style.display = component.nameElement.style.display === 'none' ? 'block' : 'none';
                }
            });
            togglePriceBtn.addEventListener('click', () => {
                const component = addedComponents.find(c => c.element === selectedFlyerItem);
                if (component && component.priceElement) {
                    component.priceElement.style.display = component.priceElement.style.display === 'none' ? 'block' : 'none';
                }
            });
            toggleVisibilityBtn.addEventListener('click', () => {
                if (selectedFlyerItem) {
                    const isVisible = selectedFlyerItem.style.opacity !== '0';
                    selectedFlyerItem.style.opacity = isVisible ? '0' : '1';
                    toggleVisibilityBtn.innerHTML = isVisible ? '<i class="fas fa-eye"></i> Mostrar' : '<i class="fas fa-eye-slash"></i> Ocultar';
                }
            });
            deleteBtn.addEventListener('click', () => {
                if (!selectedFlyerItem) return;
                const componentIndex = addedComponents.findIndex(c => c.element === selectedFlyerItem);
                if (componentIndex !== -1) {
                    const component = addedComponents[componentIndex];
                    component.element.remove();
                    if (component.nameElement) component.nameElement.remove();
                    if (component.priceElement) component.priceElement.remove();
                    addedComponents.splice(componentIndex, 1);
                }
                selectedFlyerItem = null;
                updateBaseElements();
                updatePropertiesPanel();
            });

            // --- L√≥gica de Creaci√≥n y Actualizaci√≥n ---
            async function createComponentElement(itemData, x, y) {
                const existingComp = addedComponents.find(c => c.id == itemData.id);
                if (existingComp) {
                    showMessage("Este componente ya fue agregado.", 3000);
                    return;
                }
                document.querySelectorAll('.flyer-item').forEach(item => item.classList.remove('active'));
                
                let compEl;
                const isBase = Object.keys(baseElementData).includes(itemData.id);

                if (isBase) {
                    compEl = document.createElement('div');
                    compEl.id = itemData.id;
                    compEl.dataset.itemId = itemData.id;
                    compEl.dataset.itemName = itemData.name;
                    compEl.className = 'flyer-item active';
                    compEl.style.cssText = `
                        position: absolute;
                        top: ${y}px;
                        left: ${x}px;
                        transform: translate(-50%, -50%);
                        text-align: center;
                        color: #e5e7eb;
                        white-space: nowrap;
                        z-index: 9999;
                        padding: 1.5rem;
                        width: 80%;
                        max-width: 600px;
                        ${itemData.id === 'summary-table' ? 'width: 80%; max-width: 600px; background-color: rgba(31, 41, 55, 0.9); backdrop-filter: blur(4px);' : ''}
                    `;
                    compEl.innerHTML = baseElementData[itemData.id].html;

                    // If markup base, initialize dataset.markup and content
                    if (itemData.id === 'markup') {
                        compEl.dataset.markup = itemData.markup || '';
                        const contentEl = compEl.querySelector('.markup-content') || compEl;
                        try {
                            if (!compEl.dataset.markup || compEl.dataset.markup.trim() === '') {
                                contentEl.innerHTML = DEFAULT_MARKUP_PLACEHOLDER;
                            } else {
                                contentEl.innerHTML = compEl.dataset.markup;
                            }
                        } catch(e) { console.error('Failed to set markup innerHTML', e); }
                    }
                    

                    if (itemData.id === 'summary-table') {
                        compEl.addEventListener('selectstart', e => e.preventDefault());
                        compEl.addEventListener('dblclick', e => { e.stopPropagation(); compEl.classList.toggle('show-categories'); updateBaseElements(); });
                    }
                } else if (itemData.id === 'meme') {
                    compEl = document.createElement('div');
                    compEl.id = itemData.id;
                    compEl.dataset.itemId = itemData.id;
                    compEl.dataset.itemName = itemData.name;
                    compEl.className = 'flyer-item active';
                    compEl.style.cssText = `
                        position: absolute;
                        top: ${y}px;
                        left: ${x}px;
                        transform: translate(-50%, -50%);
                        text-align: center;
                        color: #e5e7eb;
                        white-space: nowrap;
                        z-index: 9999;
                        width: 600px;
                        height: 600px;
                    `;

                    // Use first available filename as default
                    const defaultName = (await getMemeFilenames())[0] || 'PAS09795_OP.webp';
                    compEl.dataset.imageName = defaultName;
                    compEl.innerHTML = `<img src="memes/${defaultName}" alt="Meme" class="meme-image w-full h-full object-contain">`;

                    // Attach popup selector and image fallback
                    setupMemePopup(compEl);

                    const memeImage = compEl.querySelector('.meme-image');
                    if (memeImage) {
                        memeImage.onerror = () => { memeImage.src = 'https://placehold.co/600x600/374151/ffffff?text=Image+Not+Found'; };
                    }

                    setupDraggableElement(compEl);
                    addedComponents.push({ id: itemData.id, name: itemData.name, element: compEl, isBaseElement: true });
                    document.getElementById('flyer').appendChild(compEl);
                    selectedFlyerItem = compEl;
                    updateBaseElements();
                    updatePropertiesPanel();
                    return;
                } else {
                    const componentId = `comp-${itemData.id}`;
                    compEl = document.createElement('div');
                    compEl.className = `flyer-item p-2 active`;
                    compEl.id = componentId;
                    compEl.dataset.itemId = itemData.id;
                    compEl.dataset.itemName = itemData.name;
                    compEl.dataset.itemPrice = itemData.price;
                    compEl.dataset.itemType = itemData.type;
                    compEl.style.top = `${y}px`;
                    compEl.style.left = `${x}px`;
                    compEl.style.width = '200px';
                    compEl.style.height = '200px';
                    compEl.style.transform = `scale(${INITIAL_IMAGE_SCALE})`;
                    compEl.style.zIndex = '10';
                    
                    compEl.innerHTML = `
                        <img src="comps/${itemData.id}.webp" alt="${itemData.name}" class="w-full h-full object-contain" onerror="this.onerror=null;this.src='https://placehold.co/200x200/374151/ffffff?text=${itemData.name.replace(/\s/g, '+')}';">
                    `;
                    const nameEl = document.createElement('div');
                    nameEl.className = 'flyer-item component-label';
                    nameEl.textContent = itemData.name;
                    nameEl.style.zIndex = '11';
                    nameEl.style.display = 'none';
                    nameEl.dataset.parent = componentId;
                    const priceEl = document.createElement('div');
                    priceEl.className = 'flyer-item component-price';
                    priceEl.textContent = `$${parseFloat(itemData.price).toLocaleString('es-AR')}`;
                    priceEl.style.zIndex = '11';
                    priceEl.style.display = 'none';
                    priceEl.dataset.parent = componentId;

                    document.getElementById('flyer').appendChild(nameEl);
                    document.getElementById('flyer').appendChild(priceEl);
                    setupDraggableElement(nameEl);
                    setupDraggableElement(priceEl);

                    addedComponents.push({
                        id: itemData.id,
                        name: itemData.name,
                        price: parseFloat(itemData.price),
                        type: itemData.type,
                        element: compEl,
                        nameElement: nameEl,
                        priceElement: priceEl
                    });
                }
                
                document.getElementById('flyer').appendChild(compEl);
                setupDraggableElement(compEl);
                // Execute any base element script for this specific element (e.g., fecha sets current date)
                try {
                    const js = baseElementData[itemData.id] && baseElementData[itemData.id].js;
                    if (js) {
                        const fn = new Function(js);
                        fn();
                    }
                } catch (err) {
                    console.error('Error executing base element script for', itemData.id, err);
                }
                if (isBase) {
                    addedComponents.push({ id: itemData.id, name: itemData.name, element: compEl, isBaseElement: true });
                }
                selectedFlyerItem = compEl;
                updateBaseElements();
                updatePropertiesPanel();
            }

            function loadElement(elData) {
                const isBase = Object.keys(baseElementData).includes(elData.id);
                let compEl;

                if (isBase) {
                    compEl = document.createElement('div');
                    compEl.id = elData.id;
                    compEl.dataset.itemId = elData.id;
                    compEl.dataset.itemName = elData.name;
                    
                    const innerWrapper = document.createElement('div');
                    innerWrapper.innerHTML = baseElementData[elData.id].html;
                    
                    compEl.classList.add(`flyer-item`);
                    compEl.innerHTML = innerWrapper.innerHTML;
                    
                    compEl.style.cssText = elData.style;
                    
                    if (elData.id === 'summary-table') {
                        compEl.style.width = elData.style.width;
                        compEl.querySelector('h3').textContent = elData.summaryTitle;
                        compEl.addEventListener('selectstart', e => e.preventDefault());
                        compEl.addEventListener('dblclick', e => { e.stopPropagation(); compEl.classList.toggle('show-categories'); updateBaseElements(); });
                    }
                    addedComponents.push({ id: elData.id, name: elData.name, element: compEl, isBaseElement: true });
                    document.getElementById('flyer').appendChild(compEl);
                    setupDraggableElement(compEl);
                    // Execute base element script after loading so dynamic content (e.g., fecha) is initialized
                    try {
                        const js = baseElementData[elData.id] && baseElementData[elData.id].js;
                        if (js) {
                            const fn = new Function(js);
                            fn();
                        }
                    } catch (err) {
                        console.error('Error executing base element script for', elData.id, err);
                    }
                    // If this base is a meme, restore imageName and handler
                    if (elData.id === 'meme') {
                        const memeImage = compEl.querySelector('.meme-image');
                        if (elData.imageName) {
                            compEl.dataset.imageName = elData.imageName;
                            if (memeImage) memeImage.src = `memes/${elData.imageName}`;
                        }
                        setupMemePopup(compEl);
                        const img = compEl.querySelector('.meme-image');
                        if (img) img.onerror = () => { img.src = 'https://placehold.co/600x600/374151/ffffff?text=Image+Not+Found'; };
                    }
                    // If this base is a markup element, restore stored HTML
                    if (elData.id === 'markup') {
                        compEl.dataset.markup = elData.markup || '';
                        const contentEl = compEl.querySelector('.markup-content') || compEl;
                        try {
                            if (!compEl.dataset.markup || compEl.dataset.markup.trim() === '') {
                                contentEl.innerHTML = DEFAULT_MARKUP_PLACEHOLDER;
                            } else {
                                contentEl.innerHTML = compEl.dataset.markup;
                            }
                        } catch(e) { console.error('Failed to set markup innerHTML', e); }
                    }
                    // If this base is an h2 element, restore text
                    if (elData.id === 'h2') {
                        const h2El = compEl.querySelector('h2') || compEl;
                        if (h2El) {
                            if (elData.h2Text) {
                                h2El.innerHTML = elData.h2Text;
                            }
                            if (elData.h2Align) {
                                try { h2El.style.textAlign = elData.h2Align; } catch(e){}
                            }
                        }
                    }
                    // If this base is final-price-info, restore its three paragraph lines
                    if (elData.id === 'final-price-info') {
                        try {
                            const pEls = compEl.querySelectorAll('p');
                            if (elData.finalInfo1 && pEls[0]) pEls[0].innerHTML = elData.finalInfo1;
                            if (elData.finalInfo2 && pEls[1]) pEls[1].innerHTML = elData.finalInfo2;
                            if (elData.finalInfo3 && pEls[2]) pEls[2].innerHTML = elData.finalInfo3;
                        } catch (e) { console.error('Failed restoring final-price-info texts', e); }
                    }
                } else {
                    const allProducts = data ? Object.values(data).flat() : [];
                    const currentProduct = allProducts.find(p => p.id === parseInt(elData.id));
                    const currentPrice = currentProduct ? getPrice(currentProduct) : parseFloat(elData.price);
                    compEl = document.createElement('div');
                    compEl.className = `flyer-item p-2`;
                    compEl.id = `comp-${elData.id}`;
                    compEl.dataset.itemId = elData.id;
                    compEl.dataset.itemName = elData.name;
                    compEl.dataset.itemPrice = currentPrice;
                    compEl.dataset.itemType = elData.type;
                    compEl.style.cssText = elData.style;
                    compEl.innerHTML = `<img src="comps/${elData.id}.webp" alt="${elData.name}" class="w-full h-full object-contain" onerror="this.onerror=null;this.src='https://placehold.co/200x200/374151/ffffff?text=${elData.name.replace(/\s/g, '+')}';">`;

                    const nameEl = document.createElement('div');
                    nameEl.className = 'flyer-item component-label';
                    nameEl.textContent = elData.name;
                    nameEl.style.cssText = elData.nameElementState;
                    nameEl.style.zIndex = parseInt(compEl.style.zIndex) + 1;
                    nameEl.dataset.parent = compEl.id;

                    const priceEl = document.createElement('div');
                    priceEl.className = 'flyer-item component-price';
                    priceEl.textContent = `$${currentPrice.toLocaleString('es-AR')}`;
                    priceEl.style.cssText = elData.priceElementState;
                    priceEl.style.zIndex = parseInt(compEl.style.zIndex) + 1;
                    priceEl.dataset.parent = compEl.id;
                    
                    document.getElementById('flyer').appendChild(compEl);
                    document.getElementById('flyer').appendChild(nameEl);
                    document.getElementById('flyer').appendChild(priceEl);
                    setupDraggableElement(compEl);
                    setupDraggableElement(nameEl);
                    setupDraggableElement(priceEl);

                    addedComponents.push({
                        id: elData.id,
                        name: elData.name,
                        price: currentPrice,
                        type: elData.type,
                        element: compEl,
                        nameElement: nameEl,
                        priceElement: priceEl
                    });
                }
                
                selectedFlyerItem = compEl;
            }
            
            function updateBaseElements() {
                const componentsWithoutBase = addedComponents.filter(c => !c.isBaseElement);
                // FIX: Check if comp.price is a number to prevent NaN from propagating
                const totalServicePrice = componentsWithoutBase.reduce((sum, comp) => sum + (typeof comp.price === 'number' ? comp.price : 0), 0) + BASE_SERVICE_PRICE;
                const priceEl = document.querySelector(`#final-price-value`);
                if (priceEl) {
                    const priceTextEl = priceEl.querySelector('p');
                    if (priceTextEl) {
                        priceTextEl.textContent = `$${totalServicePrice.toLocaleString('es-AR')}`;
                    }
                }

                const summaryTableContainer = document.querySelector(`#summary-table`);
                if (summaryTableContainer) {
                    const tableBody = summaryTableContainer.querySelector('.component-table-body');
                    tableBody.innerHTML = '';
                    
                    const showCategories = summaryTableContainer.classList.contains('show-categories');
                    let currentCategory = '';
                    
                    componentsWithoutBase.forEach(comp => {
                        if (showCategories && comp.type !== currentCategory) {
                            const categoryRow = document.createElement('tr');
                            categoryRow.innerHTML = `<td colspan="2" class="category-row">${comp.type}</td>`;
                            tableBody.appendChild(categoryRow);
                            currentCategory = comp.type;
                        }
                        
                        const row = document.createElement('tr');
                        row.className = 'border-t border-gray-700/50';
                        row.innerHTML = `<td class="py-2 text-white flex flex-col"><span class="text-base">${comp.name}</span></td>
                            <td class="py-2 text-right resumenPrecio">$${(comp.price).toLocaleString('es-AR')}</td>`;
                        tableBody.appendChild(row);
                    });

                    const serviceRow = document.createElement('tr');
                    serviceRow.className = 'border-t border-gray-700/50';
                    serviceRow.innerHTML = `
                        <td class="py-2 text-white">Instalaci√≥n & Servicio T√©cnico<br><span class="text-sm text-gray-400">[Personal y via Web]</span></td>
                        <td class="py-2 text-right resumenPrecio">$${(BASE_SERVICE_PRICE).toLocaleString('es-AR')}</td>
                    `;
                    tableBody.appendChild(serviceRow);
                }
            }


            // --- Handlers de Eventos de Drag & Drop ---
            function handleDragOver(e) { e.preventDefault(); e.target.classList.add('droppable'); }
            function handleDragLeave(e) { e.target.classList.remove('droppable'); }
            function handleDrop(e) {
                e.preventDefault();
                e.target.classList.remove('droppable');
                try {
                    const data = e.dataTransfer.getData('text/plain');
                    if (!data) return;
                    const parsedData = JSON.parse(data);
                    const flyerRect = e.currentTarget.getBoundingClientRect();
                    const x = e.clientX - flyerRect.left;
                    const y = e.clientY - flyerRect.top;
                    createComponentElement(parsedData, x, y);
                } catch (error) { console.error('Failed to parse dropped data:', error); }
            }
            function handleDeselect(e) {
                if (!e.target.closest('.flyer-item')) {
                    if (selectedFlyerItem) selectedFlyerItem.classList.remove('active');
                    selectedFlyerItem = null;
                    updatePropertiesPanel();
                }
            }
            function handleWheel(e) {
                if (selectedFlyerItem) {
                    e.preventDefault();
                    let currentScale = parseFloat(selectedFlyerItem.style.transform.replace('scale(', '')) || 1;
                    if (selectedFlyerItem.dataset.itemId === 'summary-table') {
                        let newWidth = parseFloat(selectedFlyerItem.style.width) + (e.deltaY < 0 ? 10 : -10); // Reduced step size for smoother scaling
                        selectedFlyerItem.style.width = `${Math.min(Math.max(newWidth, 200), 1000)}px`;
                    } else {
                        let newScale = currentScale + (e.deltaY < 0 ? 0.05 : -0.05); // Reduced step size for smoother scaling
                        selectedFlyerItem.style.transform = `scale(${Math.min(Math.max(newScale, MIN_SCALE), MAX_SCALE)})`;
                    }
                    updatePropertiesPanel();
                }
            }
            
            // --- Carga Inicial de Datos ---
            async function initializeApp() {
                 try {
                    // FIX: Changed the JSON file to 'productsH.json'
                    const productsResponse = await fetch('productsH.json');
                    data = await productsResponse.json();
                    console.log('initializeApp: productsH.json loaded, keys=', Object.keys(data || {}));
                    populateCategorySelector();
                } catch (error) {
                    showMessage("Error al cargar los datos de productos.", 4000);
                }

                try {
                    const flyersResponse = await fetch('flyers.json');
                    if (flyersResponse.ok) {
                        const responseData = await flyersResponse.json();
                        if (Array.isArray(responseData) && responseData.length > 0) {
                            allCuadros = responseData;
                            renderCuadrosSelector();
                            switchCuadro(allCuadros[0].id);
                        } else {
                            createNewCuadro("Cuadro 1");
                        }
                    } else {
                        createNewCuadro("Cuadro 1");
                    }
                } catch (error) {
                    console.error("Error al cargar flyers.json:", error);
                    createNewCuadro("Cuadro 1");
                }
                executeBaseElementScripts();
            }
            
            async function loadDesignsFromJson() {
                try {
                    const clipboardText = await navigator.clipboard.readText();
                    const parsedData = JSON.parse(clipboardText);

                    if (Array.isArray(parsedData) && parsedData.length > 0) {
                        allCuadros = parsedData;
                        renderCuadrosSelector();
                        switchCuadro(allCuadros[0].id);
                        showMessage("Dise√±os cargados desde el portapapeles.", 3000);
                    } else {
                        showMessage("El JSON del portapapeles no es v√°lido o est√° vac√≠o.", 5000);
                    }
                } catch (e) {
                    console.error("Error al cargar desde el portapapeles:", e);
                    showMessage("Error: El contenido del portapapeles no es un JSON v√°lido.", 5000);
                }
            }

            // --- Event Listeners Globales ---
            addCuadroBtn.addEventListener('click', () => {
                const newCuadroName = prompt("Ingresa el nombre del nuevo cuadro:", `Cuadro ${allCuadros.length + 1}`);
                if (newCuadroName) createNewCuadro(newCuadroName);
            });
            // Rename selected cuadro
            const renameBtn = document.getElementById('rename-cuadro-btn');
            if (renameBtn) {
                renameBtn.addEventListener('click', () => {
                    const current = allCuadros.find(c => c.id === currentCuadroId);
                    if (!current) { showMessage('No hay cuadro seleccionado.', 3000); return; }
                    const newName = prompt('Nuevo nombre para el cuadro:', current.name || '');
                    if (newName && newName.trim()) {
                        current.name = newName.trim();
                        renderCuadrosSelector();
                        showMessage(`Cuadro renombrado a "${current.name}"`, 2000);
                    }
                });
            }
            deleteCuadroBtn.addEventListener('click', () => {
                if (allCuadros.length > 1 && confirm(`¬øEst√°s seguro de que quieres eliminar el cuadro "${currentDesign.name}"?`)) {
                    allCuadros = allCuadros.filter(c => c.id !== currentCuadroId);
                    renderCuadrosSelector();
                    switchCuadro(allCuadros[0].id);
                } else if (allCuadros.length <= 1) {
                    showMessage("No puedes eliminar el √∫ltimo cuadro.", 3000);
                }
            });
            cuadroSelector.addEventListener('change', (e) => switchCuadro(e.target.value));
            // Register category selector change handler once
            categorySelector.addEventListener('change', () => populateImageSelector(categorySelector.value));
            saveBtn.addEventListener('click', () => {
                saveCurrentDesign();
                const jsonString = JSON.stringify(allCuadros, null, 2);
                navigator.clipboard.writeText(jsonString);
                showMessage("JSON de cuadros copiado al portapapeles. ¬°P√©galo en tu archivo flyers.json!", 5000);
            });
            loadBtn.addEventListener('click', loadDesignsFromJson);

            // Export using local `js/html-to-image.js` only (minimal flow)
            downloadBtn.addEventListener('click', async () => {
                const cuadro = document.getElementById('cuadro');
                if (!cuadro) { showMessage('No hay cuadro para exportar.', 3000); return; }
                showMessage('Generando imagen...', 0);

                async function ensureHtmlToImageLoaded() {
                    if (typeof htmlToImage !== 'undefined') return htmlToImage;
                    if (window && window.htmlToImage) return window.htmlToImage;
                    return new Promise((resolve, reject) => {
                        const src = 'js/html-to-image.js';
                        const existing = document.querySelector('script[src="' + src + '"]');
                        if (existing) {
                            let waited = 0;
                            const poll = setInterval(() => {
                                const lib = (typeof htmlToImage !== 'undefined') ? htmlToImage : (window && window.htmlToImage ? window.htmlToImage : null);
                                if (lib) { clearInterval(poll); return resolve(lib); }
                                waited += 50;
                                if (waited > 3000) { clearInterval(poll); return reject(new Error('html-to-image global not available after waiting')); }
                            }, 50);
                            return;
                        }

                        const s = document.createElement('script');
                        s.src = src;
                        s.async = true;
                        s.onload = () => {
                            let waited = 0;
                            const poll = setInterval(() => {
                                const lib = (typeof htmlToImage !== 'undefined') ? htmlToImage : (window && window.htmlToImage ? window.htmlToImage : null);
                                if (lib) { clearInterval(poll); return resolve(lib); }
                                waited += 50;
                                if (waited > 3000) { clearInterval(poll); return reject(new Error('html-to-image not available after loading ' + src)); }
                            }, 50);
                        };
                        s.onerror = () => reject(new Error('Failed to load script: ' + src));
                        document.head.appendChild(s);
                    });
                }

                try {
                    // Try rasterizeHTML first (local file js/rasterizehtml.js)
                    async function ensureRasterizeLoaded() {
                        if (typeof rasterizeHTML !== 'undefined') return rasterizeHTML;
                        if (window && window.rasterizeHTML) return window.rasterizeHTML;
                        return new Promise((resolve, reject) => {
                            const src = 'js/rasterizehtml.js';
                            const existing = document.querySelector('script[src="' + src + '"]');
                            if (existing) {
                                let waited = 0;
                                const poll = setInterval(() => {
                                    const lib = (typeof rasterizeHTML !== 'undefined') ? rasterizeHTML : (window && window.rasterizeHTML ? window.rasterizeHTML : null);
                                    if (lib) { clearInterval(poll); return resolve(lib); }
                                    waited += 50;
                                    if (waited > 3000) { clearInterval(poll); return reject(new Error('rasterizeHTML global not available after waiting')); }
                                }, 50);
                                return;
                            }
                            const s = document.createElement('script');
                            s.src = src;
                            s.async = true;
                            s.onload = () => {
                                let waited = 0;
                                const poll = setInterval(() => {
                                    const lib = (typeof rasterizeHTML !== 'undefined') ? rasterizeHTML : (window && window.rasterizeHTML ? window.rasterizeHTML : null);
                                    if (lib) { clearInterval(poll); return resolve(lib); }
                                    waited += 50;
                                    if (waited > 3000) { clearInterval(poll); return reject(new Error('rasterizeHTML not available after loading ' + src)); }
                                }, 50);
                            };
                            s.onerror = () => reject(new Error('Failed to load script: ' + src));
                            document.head.appendChild(s);
                        });
                    }

                    // Determine exact pixel dimensions to render (prefer currentDesign if available)
                    const desiredWidth = (currentDesign && currentDesign.width) ? parseInt(currentDesign.width, 10) : Math.round(cuadro.getBoundingClientRect().width);
                    const desiredHeight = (currentDesign && currentDesign.height) ? parseInt(currentDesign.height, 10) : Math.round(cuadro.getBoundingClientRect().height);

                    // Helper: replace FontAwesome <i> tags with inline SVGs for export
                    function replaceFaWithSvg(root) {
                        const map = {
                            'fa-chevron-left': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" width="24" height="24"><path fill="currentColor" d="M34.52 239.03L228.87 44.69c9.37-9.37 24.57-9.37 33.94 0l22.63 22.63c9.37 9.37 9.37 24.57 0 33.94L131.21 256l154.24 154.73c9.37 9.37 9.37 24.57 0 33.94l-22.63 22.63c-9.37 9.37-24.57 9.37-33.94 0L34.52 272.97c-9.37-9.37-9.37-24.56 0-33.94z"></path></svg>',
                            'fa-chevron-right': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" width="24" height="24"><path fill="currentColor" d="M285.48 272.97L91.13 467.31c-9.37 9.37-24.57 9.37-33.94 0L34.56 444.68c-9.37-9.37-9.37-24.57 0-33.94L188.8 256 34.56 101.27c-9.37-9.37-9.37-24.57 0-33.94L57.19 44.7c9.37-9.37 24.57-9.37 33.94 0l194.35 194.34c9.37 9.37 9.37 24.56 0 33.93z"></path></svg>',
                            'fa-gift': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="24" height="24"><path fill="currentColor" d="M0 192v192c0 35.35 28.65 64 64 64h320c35.35 0 64-28.65 64-64V192H0zm224-160c22.09 0 40 17.91 40 40v24h120c13.25 0 24 10.75 24 24v40H40v-40c0-13.25 10.75-24 24-24h120V72c0-22.09 17.91-40 40-40z"></path></svg>',
                            'fa-house-circle-check': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" width="24" height="24"><path fill="currentColor" d="M..."/></svg>'
                        };
                        const icons = root.querySelectorAll('i[class*=\"fa-\"]');
                        icons.forEach(i => {
                            const classes = Array.from(i.classList);
                            let replaced = false;
                            for (const c of classes) {
                                if (map[c]) {
                                    const span = document.createElement('span');
                                    span.innerHTML = map[c];
                                    // preserve font-size/color
                                    span.style.color = getComputedStyle(i).color || 'inherit';
                                    span.style.display = 'inline-block';
                                    span.style.verticalAlign = 'middle';
                                    i.replaceWith(span);
                                    replaced = true;
                                    break;
                                }
                            }
                            if (!replaced) {
                                // fallback: remove the element to avoid missing glyph boxes
                                i.remove();
                            }
                        });
                    }

                    let dataUrl;
                    try {
                        // Prepare a cloned node and replace FontAwesome icons with inline SVGs
                        const cloneForRender = cuadro.cloneNode(true);
                        replaceFaWithSvg(cloneForRender);

                        const rlib = await ensureRasterizeLoaded();
                        // Create a canvas with exact dimensions and pass it to rasterizeHTML
                        const canvas = document.createElement('canvas');
                        canvas.width = desiredWidth;
                        canvas.height = desiredHeight;

                        // Pass canvas and options to drawHTML so output matches desired pixels
                        const result = await rlib.drawHTML(cloneForRender.outerHTML, canvas, { width: desiredWidth, height: desiredHeight });

                        // Prefer returned image or the canvas we provided
                        if (result && result.image && result.image.toDataURL) {
                            dataUrl = result.image.toDataURL('image/png');
                        } else if (canvas && canvas.toDataURL) {
                            dataUrl = canvas.toDataURL('image/png');
                        } else if (result && result.svg) {
                            // Rasterize SVG fallback to canvas
                            const blobUrl = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(result.svg);
                            const img = await new Promise((res, rej) => { const i = new Image(); i.onload = () => res(i); i.onerror = rej; i.src = blobUrl; });
                            const c = document.createElement('canvas'); c.width = desiredWidth; c.height = desiredHeight; c.getContext('2d').drawImage(img,0,0, desiredWidth, desiredHeight); dataUrl = c.toDataURL('image/png');
                        }
                    } catch (rerr) {
                        console.warn('rasterizeHTML failed or not available, falling back to html-to-image', rerr);
                    }

                    if (!dataUrl) {
                        const lib = await ensureHtmlToImageLoaded();
                        // Use the cloned node with SVG replacements if available
                        const renderTarget = (typeof cloneForRender !== 'undefined') ? cloneForRender : cuadro;
                        const options = { width: desiredWidth, height: desiredHeight, pixelRatio: 1, cacheBust: true, backgroundColor: null, skipFonts: true };
                        dataUrl = await lib.toPng(renderTarget, options);
                    }

                    const a = document.createElement('a');
                    const filename = (currentDesign && currentDesign.name) ? currentDesign.name.replace(/\s+/g, '_') : 'flyer';
                    a.href = dataUrl;
                    a.download = `${filename}.png`;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    showMessage('Imagen lista. Descargando...', 3000);
                } catch (err) {
                    console.error('Export error:', err);
                    showMessage('Error al generar la imagen. Revisa la consola.', 5000);
                }
            });

            // Arrow-key meme navigation removed. Meme selection is via double-click popup.

            // --- Event Listeners para la Toolbar de Cuadro ---
            toolbarSizeSelector.addEventListener('change', (e) => {
                const [width, height] = e.target.value.split('x').map(Number);
                if (cuadroEl) {
                    cuadroEl.style.width = `${width}px`;
                    cuadroEl.style.height = `${height}px`;
                    currentDesign.width = width;
                    currentDesign.height = height;
                }
            });

            toolbarAddSummaryBtn.addEventListener('click', () => {
                const flyerEl = document.getElementById('flyer');
                const existingElement = addedComponents.find(c => c.isBaseElement && c.id === 'summary-table');
                if (existingElement) {
                    // Toggle visibility instead of showing an alert
                    const el = existingElement.element;
                    const isHidden = window.getComputedStyle(el).display === 'none' || el.style.opacity === '0';
                    if (isHidden) {
                        el.style.display = '';
                        el.style.opacity = el.style.opacity === '0' ? '1' : el.style.opacity;
                    } else {
                        el.style.display = 'none';
                        // if it was the selected item, deselect
                        if (selectedFlyerItem === el) {
                            selectedFlyerItem.classList.remove('active');
                            selectedFlyerItem = null;
                            updatePropertiesPanel();
                        }
                    }
                    updateBaseElements();
                    return;
                }
                const flyerRect = flyerEl.getBoundingClientRect();
                createComponentElement(baseElementData['summary-table'], flyerRect.width / 2, flyerRect.height / 2);
            });
            toolbarAddPriceBtn.addEventListener('click', () => {
                const flyerEl = document.getElementById('flyer');
                 const existingElement = addedComponents.find(c => c.isBaseElement && c.id === 'final-price-value');
                 if (existingElement) {
                    const el = existingElement.element;
                    const isHidden = window.getComputedStyle(el).display === 'none' || el.style.opacity === '0';
                    if (isHidden) { el.style.display = ''; el.style.opacity = el.style.opacity === '0' ? '1' : el.style.opacity; }
                    else { el.style.display = 'none'; if (selectedFlyerItem === el) { selectedFlyerItem.classList.remove('active'); selectedFlyerItem = null; updatePropertiesPanel(); } }
                    updateBaseElements();
                    return;
                }
                const flyerRect = flyerEl.getBoundingClientRect();
                createComponentElement(baseElementData['final-price-value'], flyerRect.width / 2, flyerRect.height / 2);
            });
            toolbarAddInfoBtn.addEventListener('click', () => {
                const flyerEl = document.getElementById('flyer');
                const existingElement = addedComponents.find(c => c.isBaseElement && c.id === 'final-price-info');
                if (existingElement) {
                    const el = existingElement.element;
                    const isHidden = window.getComputedStyle(el).display === 'none' || el.style.opacity === '0';
                    if (isHidden) { el.style.display = ''; el.style.opacity = el.style.opacity === '0' ? '1' : el.style.opacity; }
                    else { el.style.display = 'none'; if (selectedFlyerItem === el) { selectedFlyerItem.classList.remove('active'); selectedFlyerItem = null; updatePropertiesPanel(); } }
                    updateBaseElements();
                    return;
                }
                const flyerRect = flyerEl.getBoundingClientRect();
                createComponentElement(baseElementData['final-price-info'], flyerRect.width / 2, flyerRect.height / 2);
            });
            toolbarClearFlyerBtn.addEventListener('click', () => {
                const flyerEl = document.getElementById('flyer');
                if (!flyerEl) return;
                const componentElements = flyerEl.querySelectorAll('.flyer-item');
                componentElements.forEach(item => {
                    const componentIndex = addedComponents.findIndex(c => c.element === item);
                    if (componentIndex !== -1) {
                        addedComponents.splice(componentIndex, 1);
                    }
                    item.remove();
                });
                selectedFlyerItem = null;
                updateBaseElements();
                updatePropertiesPanel();
                showMessage("Cuadro de dise√±o limpiado.", 3000);
            });
            toolbarAddMemeBtn.addEventListener('click', () => {
                const flyerEl = document.getElementById('flyer');
                const existingElement = addedComponents.find(c => c.isBaseElement && c.id === 'meme');
                if (existingElement) {
                    const el = existingElement.element;
                    const isHidden = window.getComputedStyle(el).display === 'none' || el.style.opacity === '0';
                    if (isHidden) { el.style.display = ''; el.style.opacity = el.style.opacity === '0' ? '1' : el.style.opacity; }
                    else { el.style.display = 'none'; if (selectedFlyerItem === el) { selectedFlyerItem.classList.remove('active'); selectedFlyerItem = null; updatePropertiesPanel(); } }
                    updateBaseElements();
                    return;
                }
                const flyerRect = flyerEl.getBoundingClientRect();
                createComponentElement(baseElementData['meme'], flyerRect.width / 2, flyerRect.height / 2);
            });
            toolbarAddFechaBtn.addEventListener('click', () => {
                const flyerEl = document.getElementById('flyer');
                const existingElement = addedComponents.find(c => c.isBaseElement && c.id === 'fecha');
                if (existingElement) {
                    const el = existingElement.element;
                    const isHidden = window.getComputedStyle(el).display === 'none' || el.style.opacity === '0';
                    if (isHidden) { el.style.display = ''; el.style.opacity = el.style.opacity === '0' ? '1' : el.style.opacity; }
                    else { el.style.display = 'none'; if (selectedFlyerItem === el) { selectedFlyerItem.classList.remove('active'); selectedFlyerItem = null; updatePropertiesPanel(); } }
                    updateBaseElements();
                    return;
                }
                const flyerRect = flyerEl.getBoundingClientRect();
                createComponentElement(baseElementData['fecha'], flyerRect.width / 2, flyerRect.height / 2);
            });
            
            const toolbarContainer = document.querySelector('#flyer-toolbar .flex.items-center.space-x-2');
            // Add markup, H2, meme and fecha buttons
            toolbarContainer.appendChild(toolbarAddMarkupBtn);
            toolbarContainer.appendChild(toolbarAddH2Btn);
            toolbarContainer.appendChild(toolbarAddMemeBtn);
            toolbarContainer.appendChild(toolbarAddFechaBtn);
            // Ensure clear button stays at the end of the toolbar
            toolbarContainer.appendChild(toolbarClearFlyerBtn);

            // Wire markup toolbar button (toggle if exists)
            toolbarAddMarkupBtn.addEventListener('click', () => {
                const flyerEl = document.getElementById('flyer');
                const existingElement = addedComponents.find(c => c.isBaseElement && c.id === 'markup');
                if (existingElement) {
                    const el = existingElement.element;
                    const isHidden = window.getComputedStyle(el).display === 'none' || el.style.opacity === '0';
                    if (isHidden) { el.style.display = ''; el.style.opacity = el.style.opacity === '0' ? '1' : el.style.opacity; }
                    else { el.style.display = 'none'; if (selectedFlyerItem === el) { selectedFlyerItem.classList.remove('active'); selectedFlyerItem = null; updatePropertiesPanel(); } }
                    updateBaseElements();
                    return;
                }
                const flyerRect = flyerEl.getBoundingClientRect();
                createComponentElement(baseElementData['markup'], flyerRect.width / 2, flyerRect.height / 2);
            });
            // Wire H2 toolbar button
            toolbarAddH2Btn.addEventListener('click', () => {
                const flyerEl = document.getElementById('flyer');
                const existingElement = addedComponents.find(c => c.isBaseElement && c.id === 'h2');
                if (existingElement) {
                    const el = existingElement.element;
                    const isHidden = window.getComputedStyle(el).display === 'none' || el.style.opacity === '0';
                    if (isHidden) { el.style.display = ''; el.style.opacity = el.style.opacity === '0' ? '1' : el.style.opacity; }
                    else { el.style.display = 'none'; if (selectedFlyerItem === el) { selectedFlyerItem.classList.remove('active'); selectedFlyerItem = null; updatePropertiesPanel(); } }
                    updateBaseElements();
                    return;
                }
                const flyerRect = flyerEl.getBoundingClientRect();
                createComponentElement(baseElementData['h2'], flyerRect.width / 2, flyerRect.height / 2);
            });

            // Wire apply markup button
            const applyMarkupBtn = document.getElementById('apply-markup-btn');
            if (applyMarkupBtn) {
                applyMarkupBtn.addEventListener('click', () => {
                    if (!selectedFlyerItem || selectedFlyerItem.dataset.itemId !== 'markup') return;
                    const ta = document.getElementById('markup-content');
                    if (!ta) return;
                    selectedFlyerItem.dataset.markup = ta.value;
                    const contentEl = selectedFlyerItem.querySelector('.markup-content') || selectedFlyerItem;
                    try { contentEl.innerHTML = ta.value; } catch(e) { console.error('Failed to set markup innerHTML', e); }
                    saveCurrentDesign();
                    showMessage('Markup aplicado.', 2000);
                });
            }

            // L√≥gica de Selectores
            function populateCategorySelector() {
                console.log('populateCategorySelector called, data=', data ? Object.keys(data) : data);
                if (!data) return;
                categorySelector.innerHTML = '';
                const categories = [{ key: '', name: 'Selecciona una categor√≠a' }];
                for (const key in categoryMap) {
                    if (data[key] && data[key].length > 0) {
                        categories.push({ key: key, name: categoryMap[key].name });
                    }
                }
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.key;
                    option.textContent = cat.name;
                    categorySelector.appendChild(option);
                });
                console.log('populateCategorySelector: categories added =', categories);
                console.log('populateCategorySelector: option count =', categorySelector.options.length);
                // Ensure selector is enabled and visible
                categorySelector.disabled = false;
                categorySelector.style.display = '';
                // If there's at least one real category, select it and populate images immediately
                if (categories.length > 1) {
                    const firstKey = categories[1].key;
                    categorySelector.value = firstKey;
                    populateImageSelector(firstKey);
                }
                // listener is registered once outside the function to avoid duplicates
            }

            function populateImageSelector(categoryKey) {
                if (!data || !categoryKey) { imageSelector.innerHTML = ''; return; }
                imageSelector.innerHTML = '';
                const items = data[categoryKey].filter(item => item.visible !== 0);
                items.forEach(item => {
                    const imgContainer = document.createElement('div');
                    imgContainer.className = 'selector-item p-2 text-center flex flex-col items-center justify-center';
                    imgContainer.draggable = true;
                    imgContainer.dataset.itemId = item.id;
                    imgContainer.dataset.itemName = item.name;
                    imgContainer.dataset.itemPrice = getPrice(item);
                    imgContainer.dataset.itemType = categoryMap[categoryKey].name;
                    imgContainer.innerHTML = `<img src="comps/${item.id}.webp" alt="${item.name}" class="w-16 h-16 object-contain mb-2" onerror="this.onerror=null;this.src='https://placehold.co/64x64/374151/ffffff?text=IMG'">
                        <span class="text-xs text-gray-400">${item.name}</span>
                        <span class="text-xs resumenPrecio font-bold">$${getPrice(item).toLocaleString('es-AR')}</span>`;
                    imageSelector.appendChild(imgContainer);
                    imgContainer.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/plain', JSON.stringify({ id: item.id, name: item.name, price: getPrice(item), type: categoryMap[categoryKey].name })); });
                });
            }

            initializeApp();
        });
    </script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const flyerSizeSelector = document.getElementById('flyer-size-selector');
        const cuadro = document.getElementById('cuadro');

        const updateCuadroSize = () => {
          const selectedSize = flyerSizeSelector.value;
          const [width, height] = selectedSize.split('x').map(Number);
          if (cuadro) {
            cuadro.style.width = `${width}px`;
            cuadro.style.height = `${height}px`;
          }
        };

        flyerSizeSelector.addEventListener('change', updateCuadroSize);
      });
    </script>
    <!-- Markup WYSIWYG Editor Modal -->
    <div id="markup-editor-modal" class="fixed inset-0 z-60 flex items-center justify-center hidden">
        <div id="markup-editor-backdrop" class="absolute inset-0 bg-black opacity-60"></div>
        <div id="markup-editor" class="relative bg-gray-900 text-white rounded shadow-lg" style="width:400px;height:300px;resize:both;overflow:auto;z-index:99999;">
            <div id="markup-editor-header" class="p-2 flex items-center justify-between border-b border-gray-700">
                <div class="flex items-center gap-2">
                    <strong>Editor de Markup</strong>
                </div>
                <div class="flex items-center gap-2">
                    <button id="markup-editor-close" class="px-2 py-1 bg-red-600 rounded">Cerrar</button>
                </div>
            </div>
            <div id="markup-editor-toolbar" class="p-2 flex flex-wrap gap-2 border-b border-gray-800">
                <select id="markup-font-select" class="bg-gray-800 text-white p-1 rounded">
                    <option value="Saira">Saira</option>
                    <option value="Inter">Inter</option>
                    <option value="VT323">VT323</option>
                </select>
                <select id="markup-fontsize-select" class="bg-gray-800 text-white p-1 rounded">
                    <option value="12px">12</option>
                    <option value="14px">14</option>
                    <option value="16px" selected>16</option>
                    <option value="18px">18</option>
                    <option value="24px">24</option>
                    <option value="32px">32</option>
                </select>
                <input id="markup-color-input" type="color" value="#ffffff" class="w-10 h-8 p-0 border-0 rounded" />
                <button id="markup-bold" class="px-2 py-1 bg-gray-800 rounded">B</button>
                <button id="markup-italic" class="px-2 py-1 bg-gray-800 rounded">I</button>
                <button id="markup-underline" class="px-2 py-1 bg-gray-800 rounded">U</button>
                <button id="markup-align-left" class="px-2 py-1 bg-gray-800 rounded">L</button>
                <button id="markup-align-center" class="px-2 py-1 bg-gray-800 rounded">C</button>
                <button id="markup-align-right" class="px-2 py-1 bg-gray-800 rounded">R</button>
            </div>
            <div id="markup-editor-body" class="p-2" style="height:calc(100% - 96px); overflow:auto;">
                <div id="markup-editor-content" contenteditable="true" class="w-full h-full p-2 bg-white text-black" style="min-height:140px; font-family: Inter; font-size:16px;"></div>
            </div>
            <div class="p-2 border-t border-gray-800 flex gap-2">
                <button id="markup-editor-save" class="flex-1 py-2 bg-green-600 rounded">Guardar</button>
                <button id="markup-editor-cancel" class="flex-1 py-2 bg-gray-700 rounded">Cancelar</button>
            </div>
        </div>
    </div>
    <script>
        (function(){
            // Editor DOM refs
            const modal = document.getElementById('markup-editor-modal');
            const editor = document.getElementById('markup-editor');
            const content = document.getElementById('markup-editor-content');
            const openBtn = document.getElementById('open-markup-editor-btn');
            const closeBtn = document.getElementById('markup-editor-close');
            const cancelBtn = document.getElementById('markup-editor-cancel');
            const saveBtn = document.getElementById('markup-editor-save');
            const fontSelect = document.getElementById('markup-font-select');
            const sizeSelect = document.getElementById('markup-fontsize-select');
            const colorInput = document.getElementById('markup-color-input');
            const boldBtn = document.getElementById('markup-bold');
            const italicBtn = document.getElementById('markup-italic');
            const underlineBtn = document.getElementById('markup-underline');
            const alignLeftBtn = document.getElementById('markup-align-left');
            const alignCenterBtn = document.getElementById('markup-align-center');
            const alignRightBtn = document.getElementById('markup-align-right');

            function getSelectedFlyerItem() {
                // Prefer window-level variable if available, otherwise find active item in DOM
                if (typeof selectedFlyerItem !== 'undefined' && selectedFlyerItem) return selectedFlyerItem;
                return document.querySelector('#flyer .flyer-item.active') || document.querySelector('.flyer-item.active');
            }

            function showMessageLocal(message, duration = 3000) {
                const el = document.getElementById('status-message');
                if (!el) return;
                el.textContent = message;
                el.classList.remove('hidden');
                if (duration > 0) setTimeout(() => el.classList.add('hidden'), duration);
            }

            function openMarkupEditor(initialHtml) {
                content.innerHTML = initialHtml || '';
                // set default styles
                content.style.fontFamily = fontSelect.value;
                content.style.fontSize = sizeSelect.value;
                content.style.color = colorInput.value;
                modal.classList.remove('hidden');
            }

            function closeMarkupEditor() {
                modal.classList.add('hidden');
            }

            // Exec formatting commands
            boldBtn.addEventListener('click', () => document.execCommand('bold'));
            italicBtn.addEventListener('click', () => document.execCommand('italic'));
            underlineBtn.addEventListener('click', () => document.execCommand('underline'));
            alignLeftBtn.addEventListener('click', () => document.execCommand('justifyLeft'));
            alignCenterBtn.addEventListener('click', () => document.execCommand('justifyCenter'));
            alignRightBtn.addEventListener('click', () => document.execCommand('justifyRight'));

            // Apply font and size by wrapping selection or applying to whole content
            fontSelect.addEventListener('change', () => {
                content.style.fontFamily = fontSelect.value;
            });
            sizeSelect.addEventListener('change', () => {
                content.style.fontSize = sizeSelect.value;
            });
            colorInput.addEventListener('change', () => {
                document.execCommand('foreColor', false, colorInput.value);
            });

            // Open modal from properties button
            if (openBtn) {
                openBtn.addEventListener('click', () => {
                    const sel = getSelectedFlyerItem();
                    if (!sel || sel.dataset.itemId !== 'markup') {
                        showMessageLocal('Selecciona primero un elemento Markup.', 3000);
                        return;
                    }
                    const initial = sel.dataset.markup || (sel.querySelector('.markup-content') ? sel.querySelector('.markup-content').innerHTML : '');
                    openMarkupEditor(initial);
                });
            }

            // Close handlers
            if (closeBtn) closeBtn.addEventListener('click', closeMarkupEditor);
            if (cancelBtn) cancelBtn.addEventListener('click', closeMarkupEditor);

            // Save handler: commit HTML back to selected element and persist
            if (saveBtn) {
                saveBtn.addEventListener('click', () => {
                    const sel = getSelectedFlyerItem();
                    if (!sel || sel.dataset.itemId !== 'markup') {
                        closeMarkupEditor();
                        return;
                    }
                    const html = content.innerHTML;
                    sel.dataset.markup = html;
                    const contentEl = sel.querySelector('.markup-content') || sel;
                    try { contentEl.innerHTML = html; } catch(e) { console.error('Failed to set markup innerHTML', e); }
                    // Try calling saveCurrentDesign if available in outer scope; if not, persist minimal state
                    try { if (typeof saveCurrentDesign === 'function') saveCurrentDesign(); } catch(e) { /* ignore */ }
                    closeMarkupEditor();
                    showMessageLocal('Markup guardado.', 2000);
                });
            }

            // Make the modal draggable by header
            (function makeDraggable() {
                const header = document.getElementById('markup-editor-header');
                let isDown = false; let startX=0, startY=0, startLeft=0, startTop=0;
                header.addEventListener('mousedown', (e)=>{ isDown=true; startX=e.clientX; startY=e.clientY; const rect=editor.getBoundingClientRect(); startLeft=rect.left; startTop=rect.top; document.body.style.userSelect='none'; });
                document.addEventListener('mousemove',(e)=>{ if(!isDown) return; const dx=e.clientX-startX, dy=e.clientY-startY; editor.style.left=(startLeft+dx)+'px'; editor.style.top=(startTop+dy)+'px'; editor.style.position='fixed'; });
                document.addEventListener('mouseup',()=>{ if(isDown){ isDown=false; document.body.style.userSelect='auto'; } });
            })();

            // Ensure fonts in select use page fonts (no-op here, selects list them)
        })();
    </script>
</body>

</html>
