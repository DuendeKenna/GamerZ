<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creador de Flyers Digitales</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Inter font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Saira:wght@400;700;900&family=VT323&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-link: #60a5fa;
            --brand-green-333: #42d232;
            --brand-green-222: #95ef81;
            --brand-blueish: #0098e9;
            --brand-orange: #fb923c;
            --brand-violet: #8b5cf6;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #e5e7eb;
            overflow: hidden;
            display: flex;
        }
        
        .font-saira { font-family: 'Saira', sans-serif; }
        .font-vt323 { font-family: 'VT323', monospace; }
        .font-inter { font-family: 'Inter', sans-serif; }

        .section-card-style {
            background-color: rgba(31, 41, 55, 0.9);
            border: 1px solid rgba(75, 85, 99, 0.5);
            border-radius: 0.75rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            padding: 1.5rem;
        }

        .cta-button {
            background: linear-gradient(to right, var(--brand-green-333), var(--brand-green-222));
            border: 2px solid var(--brand-green-333);
            transition: all 0.3s ease;
        }

        .cta-button:hover {
            background: linear-gradient(to right, var(--brand-green-222), var(--brand-green-333));
            transform: scale(1.05);
        }

        #herramientas {
            width: 30%;
            min-width: 350px;
            max-height: 100vh;
            overflow-y: auto;
            padding: 1rem;
            flex-shrink: 0;
        }

        #flyer-section-container {
            flex-grow: 1;
            max-height: 100vh;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }
        
        /* Estilo para las scrollbars */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1f2937;
        }

        ::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 4px;
            border: 2px solid #1f2937;
        }

        ::-webkit-scrollbar-thumb:hover {
            background-color: #6b7280;
        }

        /* Contenedor estético alrededor del flyer */
        #cuadro {
            position: relative;
            padding: 2rem;
            background-color: #1f2937;
            box-shadow: 0 4px 25px rgba(0, 0, 0, 0.6);
            transform-origin: top center;
            transform: scale(0.5);
            transition: transform 0.2s ease-in-out;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            
            /* The dimensions are now set by JavaScript */
        }
        
        /* Estilo base para el flyer */
        #flyer {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            border-radius: 0.75rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            background-color: #13161b;
        }
        
        .flyer-template.droppable {
            border: 2px dashed var(--brand-green-333);
        }

        .flyer-item {
            position: absolute;
            cursor: grab;
            transition: transform 0.2s ease;
        }
        
        .flyer-item.dragging {
            cursor: grabbing;
            z-index: 100;
        }
        
        .flyer-item.active {
            border: 2px dashed var(--brand-blueish);
            box-shadow: 0 0 10px rgba(0, 152, 233, 0.5);
        }

        .flyer-item .item-info {
            position: absolute;
            bottom: -2rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            border-radius: 0.25rem;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .flyer-item:hover .item-info {
            opacity: 1;
        }

        /* Estilos de los selectores */
        .selector-item {
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border-radius: 0.5rem;
            border: 2px solid transparent;
        }

        .selector-item.selected {
            border-color: var(--brand-green-333);
            background-color: rgba(66, 210, 50, 0.1);
        }
        
        .selector-item:hover {
            transform: scale(1.05);
            background-color: rgba(66, 210, 50, 0.05);
        }

        /* Estilo para la tabla de resumen dentro del flyer */
        #component-summary-table-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 600px;
        }

        #component-summary-table-container .resize-handle {
            position: absolute;
            width: 20px;
            height: 20px;
            background: rgba(0, 152, 233, 0.7);
            border-radius: 50%;
            bottom: -10px;
            right: -10px;
            cursor: nwse-resize;
            z-index: 101;
        }
        
        /* Estilo para el bloque de precio final */
        #final-price-value-container {
            position: absolute;
            top: 25%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #e5e7eb;
            white-space: nowrap;
            z-index: 9999;
        }

        #final-price-info-container {
            position: absolute;
            top: 25%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #e5e7eb;
            white-space: nowrap;
            z-index: 9998;
        }

        /* Estilos para el precio final, replicados de index.html */
        .lucas-price {
            font-family: 'Saira', sans-serif;
            font-size: 4rem;
            line-height: 1;
            font-weight: bold;
            color: #22d3ee;
            text-shadow: 2px 2px 55px rgba(0, 0, 0, 0.5), 0 0 20px rgba(118, 18, 143, 0.801), 0 0 55px rgba(34, 211, 238, 0.2), 0 0 25px rgba(34, 211, 238, 0.2);
            animation: price-glow 3s ease-in-out infinite;
        }

        @keyframes price-glow {
            0%, 100% {
                text-shadow: 2px 2px 55px rgba(0, 0, 0, 0.5), 0 0 20px rgba(118, 18, 143, 0.801), 0 0 55px rgba(34, 211, 238, 0.2), 0 0 25px rgba(34, 211, 238, 0.2);
            }
            50% {
                text-shadow: 2px 2px 55px rgba(0, 0, 0, 0.5), 0 0 12px rgba(34, 211, 238, 0.35), 0 0 25px rgba(34, 211, 238, 0.25);
            }
        }
        
        /* Estilo para el texto "La Costa" con sombra */
        .la-costa-shadow {
            text-shadow: 2px 2px 3px black;
        }
        
        .delivery-info {
            color: var(--brand-green-333);
            font-weight: bold;
            text-shadow: 2px 2px 3px black;
        }

        .delivery-city {
            font-size: 1.25rem;
            font-weight: bold;
            color: white;
        }

        .payment-info {
            color: #9ca3af;
            text-shadow: 2px 2px 3px black;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }

        .custom-select-wrapper {
            position: relative;
            width: 100%;
        }

        .custom-select-wrapper::after {
            content: '\f078'; /* Chevron down icon */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            pointer-events: none;
        }

        .custom-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 100%;
            background-color: #374151;
            border: 1px solid #4b5563;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
        }

        /* Estilos para el Modal de administración */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }

        .modal-content {
            background-color: #1f2937;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #4b5563;
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }

        .modal-body {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .template-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #374151;
        }

        .template-item:last-child {
            border-bottom: none;
        }

        .template-name {
            cursor: pointer;
            font-weight: bold;
            color: #fff;
            transition: color 0.2s;
        }

        .template-name:hover {
            color: #8b5cf6;
        }
        
        .component-label, .component-price {
            position: absolute;
            padding: 0.5rem;
            font-size: 1.5rem;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
            white-space: nowrap;
            z-index: 10;
        }

        .component-label {
            color: white;
        }
        
        .component-price {
            color: var(--brand-green-333);
        }
        
        .category-row {
            padding: 0.5rem;
            background-color: rgba(31, 41, 55, 0.5);
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: var(--brand-violet);
        }

        .component-row {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
            border-bottom: 1px solid rgba(75, 85, 99, 0.2);
        }
        
        /* Estilos de la barra flotante */
        #flyer-toolbar {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 50;
            background-color: rgba(31, 41, 55, 0.9);
            border: 1px solid rgba(75, 85, 99, 0.5);
            border-radius: 0.75rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            cursor: default;
        }
        
        #flyer-toolbar .drag-handle {
            display: none;
        }
    </style>
</head>

<body>
    <div class="container mx-auto max-w-7xl flex h-screen">
        <!-- Columna de Herramientas -->
        <aside id="herramientas" class="section-card-style p-6 flex-shrink-0">
            <h2 class="text-3xl font-bold mb-6 text-center text-white font-saira">Herramientas</h2>

            <!-- Selector de Cuadros -->
            <div class="mb-4 flex items-center space-x-2">
                <select id="cuadro-selector" class="w-full custom-select">
                    <!-- Options will be populated by JS -->
                </select>
                <button id="add-cuadro-btn" class="p-2 rounded-md bg-green-600 hover:bg-green-700 transition" title="Agregar Cuadro">
                    <i class="fas fa-plus"></i>
                </button>
                <button id="delete-cuadro-btn" class="p-2 rounded-md bg-red-600 hover:bg-red-700 transition" title="Eliminar Cuadro">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
            
            <hr class="border-gray-700 my-8">

            <!-- Selector de Categoría de Componentes -->
            <div id="category-section">
                <h3 class="text-xl font-bold text-violet-400 font-saira mb-2">1. Selecciona Categoría</h3>
                <div class="custom-select-wrapper mb-4">
                    <select id="category-selector" class="custom-select">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
            </div>
            
            <!-- Listado de Componentes (Imágenes) -->
            <div id="image-selector-section">
                <h3 class="text-xl font-bold text-green-400 font-saira mb-2">2. Arrastra Elementos</h3>
                <div id="image-selector" class="grid grid-cols-3 gap-4">
                    <!-- Componentes filtrados se insertarán aquí -->
                </div>
            </div>

            <hr class="border-gray-700 my-8">

            <!-- Propiedades de Elemento Seleccionado -->
            <div id="properties-section" class="hidden">
                 <h3 class="text-xl font-bold text-orange-400 font-saira mb-2">3. Propiedades</h3>
                <div id="properties-panel" class="space-y-4">
                     <div>
                        <label for="element-name" class="block text-sm font-medium">Elemento:</label>
                        <input type="text" id="element-name" class="w-full p-2 rounded-md bg-gray-800 border border-gray-600 text-gray-200" disabled>
                    </div>
                    <div>
                        <label for="pos-x" class="block text-sm font-medium">Posición X:</label>
                        <input type="number" id="pos-x" class="w-full p-2 rounded-md bg-gray-800 border border-gray-600 text-gray-200">
                    </div>
                    <div>
                        <label for="pos-y" class="block text-sm font-medium">Posición Y:</label>
                        <input type="number" id="pos-y" class="w-full p-2 rounded-md bg-gray-800 border border-gray-600 text-gray-200">
                    </div>
                    <div id="scale-container">
                        <label for="scale" class="block text-sm font-medium">Tamaño (0.1 - 8):</label>
                        <input type="number" step="0.1" min="0.1" max="8" id="scale" class="w-full p-2 rounded-md bg-gray-800 border border-gray-600 text-gray-200">
                    </div>
                    <div id="width-container" class="hidden">
                        <label for="width" class="block text-sm font-medium">Ancho del Contenedor (%):</label>
                        <input type="number" step="1" min="10" max="100" id="width" class="w-full p-2 rounded-md bg-gray-800 border border-gray-600 text-gray-200">
                    </div>
                    <div>
                        <label for="z-index" class="block text-sm font-medium">Orden de Capas (Z-Index):</label>
                        <input type="number" id="z-index" class="w-full p-2 rounded-md bg-gray-800 border border-gray-600 text-gray-200">
                    </div>
                    <div class="flex gap-4">
                        <button id="toggle-visibility-btn" class="w-full py-2 rounded-md text-white bg-blue-600 hover:bg-blue-700 transition">
                            <i class="fas fa-eye"></i> Ocultar
                        </button>
                        <button id="delete-btn" class="w-full py-2 rounded-md text-white bg-red-600 hover:bg-red-700 transition">
                            <i class="fas fa-trash"></i> Eliminar
                        </button>
                    </div>
                    <div id="text-options" class="flex flex-col space-y-2">
                        <h4 class="text-lg font-medium text-gray-300">Opciones de Texto</h4>
                        <div class="flex gap-2">
                            <button id="toggle-name-btn" class="flex-1 py-2 rounded-md text-white bg-gray-600 hover:bg-gray-700 transition">
                                <i class="fas fa-tag"></i> Nombre
                            </button>
                            <button id="toggle-price-btn" class="flex-1 py-2 rounded-md text-white bg-gray-600 hover:bg-gray-700 transition">
                                <i class="fas fa-dollar-sign"></i> Precio
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <hr class="border-gray-700 my-8">
            
            <div id="zoom-section">
                <h3 class="text-xl font-bold text-blue-400 font-saira mb-2">Zoom</h3>
                <input type="range" id="zoom-slider" min="0.1" max="1" step="0.05" value="0.75" class="w-full">
            </div>

            <hr class="border-gray-700 my-8">

            <!-- Sección de Guardar y Cargar actualizada -->
            <div id="save-section" class="text-center space-y-4">
                <h3 class="text-xl font-bold text-violet-400 font-saira mb-2">Guardar y Cargar</h3>
                <div class="flex gap-2">
                    <button id="save-btn" class="w-1/2 py-3 rounded-md text-white bg-violet-600 hover:bg-violet-700 transition font-bold">
                        <i class="fas fa-code"></i> Guardar JSON
                    </button>
                    <button id="load-btn" class="w-1/2 py-3 rounded-md text-white bg-blue-600 hover:bg-blue-700 transition font-bold">
                        <i class="fas fa-clipboard-paste"></i> Cargar JSON
                    </button>
                </div>
            </div>
            
            <hr class="border-gray-700 my-8">
            
             <div id="download-section" class="text-center space-y-4">
                <h3 class="text-xl font-bold text-cyan-400 font-saira mb-2">¡Descarga!</h3>
                <button id="download-btn" class="w-full cta-button text-white font-bold py-4 rounded-md transition">
                    <i class="fas fa-download"></i> Descargar Imagen
                </button>
                <p class="text-sm text-gray-500 mt-2">La descarga puede tardar unos segundos.</p>
            </div>
        </aside>

        <!-- Área de Edición del Flyer -->
        <section id="flyer-section-container" class="lg:col-span-2 p-6 flex justify-center items-start overflow-y-auto">
            
            <!-- El contenedor principal de cuadros -->
            <div id="cuadros-container"></div> 
                <!-- Los cuadros se renderizarán aquí -->
            </div>
            
        </section>
    </div>

    <!-- Toolbar flotante y oculta por defecto para cada cuadro -->
    <div id="flyer-toolbar" class="flex-col items-center p-4">
        <div class="drag-handle absolute top-0 left-0 w-full h-8 cursor-grab flex justify-end p-2 text-gray-500 hover:text-white transition">
            <i class="fas fa-grip-lines"></i>
        </div>
        
        <!-- Selectores y botones de la toolbar -->
        <div class="flex flex-col items-center space-y-2 mt-4">
            <div class="flex items-center space-x-2">
                <button id="add-summary-btn" class="p-2 rounded-md text-white bg-blue-600 hover:bg-blue-700 transition" title="Agregar Resumen">
                    <i class="fas fa-list-ul"></i>
                </button>
                <button id="add-price-btn" class="p-2 rounded-md text-white bg-blue-600 hover:bg-blue-700 transition" title="Agregar Precio Final">
                    <i class="fas fa-dollar-sign"></i>
                </button>
                <button id="add-info-btn" class="p-2 rounded-md text-white bg-blue-600 hover:bg-blue-700 transition" title="Agregar Info de Entrega">
                    <i class="fas fa-info-circle"></i>
                </button>
                <button id="clear-flyer-btn" class="p-2 rounded-md text-white bg-blue-600 hover:bg-blue-700 transition" title="Limpiar Cuadro">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            <div id="flyer-size-selector-wrapper" class="mt-4">
                 <select id="flyer-size-selector" class="w-full custom-select">
                    <option value="1080x1080">1080x1080</option>
                    <option value="1080x1350">1080x1350</option>
                    <option value="1080x1920">1080x1920</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Placeholder para mensajes de estado -->
    <div id="status-message" class="fixed bottom-4 left-1/2 -translate-x-1/2 p-4 bg-gray-800 rounded-lg shadow-lg text-white text-center hidden z-50"></div>
    

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const categorySelector = document.getElementById('category-selector');
            const imageSelector = document.getElementById('image-selector');
            const cuadrosContainer = document.getElementById('cuadros-container');
            const downloadBtn = document.getElementById('download-btn');
            const statusMessageEl = document.getElementById('status-message');
            const propertiesPanel = document.getElementById('properties-panel');
            const elementNameInput = document.getElementById('element-name');
            const posXInput = document.getElementById('pos-x');
            const posYInput = document.getElementById('pos-y');
            const scaleInput = document.getElementById('scale');
            const widthInput = document.getElementById('width');
            const zIndexInput = document.getElementById('z-index');
            const toggleVisibilityBtn = document.getElementById('toggle-visibility-btn');
            const deleteBtn = document.getElementById('delete-btn');
            const zoomSlider = document.getElementById('zoom-slider');
            const saveBtn = document.getElementById('save-btn');
            const loadBtn = document.getElementById('load-btn');
            const cuadroSelector = document.getElementById('cuadro-selector');
            const addCuadroBtn = document.getElementById('add-cuadro-btn');
            const deleteCuadroBtn = document.getElementById('delete-cuadro-btn');
            const flyerToolbar = document.getElementById('flyer-toolbar');
            let cuadroEl; // Declare cuadroEl here

            
            // Toolbar elements
            const toolbarAddSummaryBtn = document.getElementById('add-summary-btn');
            const toolbarAddPriceBtn = document.getElementById('add-price-btn');
            const toolbarAddInfoBtn = document.getElementById('add-info-btn');
            const toolbarClearFlyerBtn = document.getElementById('clear-flyer-btn');
            const toolbarSizeSelector = document.getElementById('flyer-size-selector');
            const toggleNameBtn = document.getElementById('toggle-name-btn');
            const togglePriceBtn = document.getElementById('toggle-price-btn');

            let data = null;
            let currentDesign = null;
            let selectedFlyerItem = null;
            let currentCuadroId = null;
            let allCuadros = [];
            let addedComponents = []; 
            const MIN_SCALE = 0.1;
            const MAX_SCALE = 8;
            const INITIAL_IMAGE_SCALE = 1.33;
            const BASE_SERVICE_PRICE = 110000;
            
            // Mapping for data and categories
            const categoryMap = {
                'towersOptions': { name: 'Gabinetes' },
                'baseOptions': { name: 'Bases' },
                'cpuOptions': { name: 'CPUs' },
                'ramOptions': { name: 'RAM' },
                'motherboardOptions': { name: 'Motherboards' },
                'gpuOptions': { name: 'Gráficas' },
                'ssdOptions': { name: 'Almacenamiento' },
                'psuOptions': { name: 'Fuentes' },
                'monitorOptions': { name: 'Monitores' },
                'keyboardOptions': { name: 'Teclados' },
                'mouseOptions': { name: 'Mouses' },
                'joystickOptions': { name: 'Joysticks' },
                'auricularesOptions': { name: 'Auriculares' },
                'parlantesOptions': { name: 'Parlantes' },
                'webcamOptions': { name: 'Webcams' },
                'microfonosOptions': { name: 'Micrófonos' },
                'arosDeLuzOptions': { name: 'Aros de Luz' },
                'wifiOptions': { name: 'WiFi' },
            };

            // Colección de elementos base
            const baseElementData = {
                'summary-table': {
                    id: 'summary-table',
                    name: 'Resumen de Componentes',
                    html: `
                        <h3 class="text-2xl font-bold mb-4 text-center font-saira cursor-text" contenteditable="true">Resumen de Componentes</h3>
                        <table class="w-full text-left table-auto">
                            <thead class="border-b-2 border-gray-600">
                                <tr>
                                    <th class="py-2 text-violet-400 font-saira">Componente</th>
                                    <th class="py-2 text-right text-green-400 font-saira">Precio (ARS)</th>
                                </tr>
                            </thead>
                            <tbody class="component-table-body">
                                <!-- Filas de componentes se insertarán aquí dinámicamente -->
                            </tbody>
                        </table>
                    `
                },
                'final-price-value': {
                    id: 'final-price-value',
                    name: 'Precio Final',
                    html: `<p class="lucas-price text-center">$0</p>`
                },
                'final-price-info': {
                    id: 'final-price-info',
                    name: 'Información de Entrega',
                    html: `
                        <p class="delivery-info text-center mt-4 font-inter text-base">
                            <i class="fas fa-truck mr-1"></i>Entrega Personal a Domicilio
                        </p>
                        <p class="delivery-city text-center mt-1 font-inter text-base">
                            en toda <strong class="text-white la-costa-shadow">La Costa 🌊</strong>
                        </p>
                        <p class="payment-info text-center mt-4 font-inter text-xs">
                            <i class="fas fa-credit-card"></i> Consultar opciones en cuotas x MP
                        </p>
                    `
                }
            };

            // --- Funciones de Utilidad ---
            function getPrice(item) {
                // FIX: Check for the `total` field first for "Bases", otherwise use the first element of the `prices` array.
                if (item.total) {
                    return item.total;
                }
                return (item.prices && item.prices.length > 0) ? item.prices[0].value : 0;
            }
            
            function showMessage(message, duration = 3000) {
                statusMessageEl.textContent = message;
                statusMessageEl.classList.remove('hidden');
                if (duration > 0) {
                    setTimeout(() => statusMessageEl.classList.add('hidden'), duration);
                }
            }
            
            function setupDraggableElement(element) {
                let isDragging = false;
                let startX, startY, startTop, startLeft;
                
                element.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('.flyer-item').forEach(item => item.classList.remove('active'));
                    element.classList.add('active');
                    selectedFlyerItem = element;
                    updatePropertiesPanel();
                    isDragging = true;
                    element.classList.add('dragging');
                    startX = e.clientX;
                    startY = e.clientY;
                    startTop = element.offsetTop;
                    startLeft = element.offsetLeft;
                });
                
                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    const deltaX = e.clientX - startX;
                    const deltaY = e.clientY - startY;
                    element.style.top = `${startTop + deltaY}px`;
                    element.style.left = `${startLeft + deltaX}px`;
                    updatePropertiesPanel();
                });

                document.addEventListener('mouseup', () => {
                    if (isDragging) {
                        isDragging = false;
                        element.classList.remove('dragging');
                    }
                });
            }

            // --- Lógica del Sistema de Cuadros (multi-cuadro) ---
            function createNewCuadro(name, width = 1080, height = 1080) {
                const id = `cuadro-${Date.now()}`;
                const newCuadro = {
                    id: id,
                    name: name,
                    width: width,
                    height: height,
                    elements: [],
                };
                allCuadros.push(newCuadro);
                renderCuadrosSelector();
                switchCuadro(id);
                showMessage(`Nuevo cuadro "${name}" creado.`, 3000);
            }

            function deleteCurrentCuadro() {
                if (allCuadros.length <= 1) {
                    showMessage("No puedes eliminar el último cuadro.", 3000);
                    return;
                }
                const currentCuadroIndex = allCuadros.findIndex(c => c.id === currentCuadroId);
                if (currentCuadroIndex !== -1) {
                    allCuadros.splice(currentCuadroIndex, 1);
                    renderCuadrosSelector();
                    switchCuadro(allCuadros[0].id);
                    showMessage(`Cuadro eliminado.`, 3000);
                }
            }

            function renderCuadrosSelector() {
                cuadroSelector.innerHTML = '';
                allCuadros.forEach(cuadro => {
                    const option = document.createElement('option');
                    option.value = cuadro.id;
                    option.textContent = cuadro.name;
                    cuadroSelector.appendChild(option);
                });
                if (currentCuadroId) {
                    cuadroSelector.value = currentCuadroId;
                }
            }
            
            function switchCuadro(cuadroId) {
                const selectedCuadro = allCuadros.find(c => c.id === cuadroId);
                if (!selectedCuadro) return;
                
                // Save current state before switching
                if (currentDesign) {
                    saveCurrentDesign();
                }

                currentCuadroId = cuadroId;
                currentDesign = selectedCuadro;
                
                renderCuadro(selectedCuadro);
                updatePropertiesPanel();
            }

            function renderCuadro(cuadro) {
                // Update cuadroEl reference
                cuadroEl = document.getElementById('cuadro');
                if (!cuadroEl) {
                    cuadroEl = document.createElement('div');
                    cuadroEl.id = 'cuadro';
                    cuadrosContainer.appendChild(cuadroEl);
                }
                
                // Clear previous elements
                let flyerEl = cuadroEl.querySelector('#flyer');
                if (flyerEl) {
                    flyerEl.remove();
                }

                flyerEl = document.createElement('div');
                flyerEl.id = 'flyer';
                flyerEl.className = "relative overflow-hidden rounded-lg shadow-2xl bg-[#13161b] cursor-default";
                cuadroEl.appendChild(flyerEl);
                
                // Set precise dimensions
                cuadroEl.style.width = `${cuadro.width}px`;
                cuadroEl.style.height = `${cuadro.height}px`;

                flyerEl.addEventListener('dragover', handleDragOver);
                flyerEl.addEventListener('dragleave', handleDragLeave);
                flyerEl.addEventListener('drop', handleDrop);
                flyerEl.addEventListener('click', handleDeselect);
                flyerEl.addEventListener('wheel', handleWheel);

                addedComponents = [];
                if (cuadro.elements) {
                    cuadro.elements.forEach(elData => loadElement(elData));
                }
                
                updateBaseElements();
                
                // Set the toolbar position to fixed bottom-right
                flyerToolbar.style.top = '';
                flyerToolbar.style.left = '';
                flyerToolbar.style.bottom = '1rem';
                flyerToolbar.style.right = '1rem';
                flyerToolbar.style.transform = '';
                
                if (cuadro.width && cuadro.height) {
                    toolbarSizeSelector.value = `${cuadro.width}x${cuadro.height}`;
                }
                
                flyerToolbar.classList.remove('hidden');
            }
            
            function saveCurrentDesign() {
                if (!currentDesign) return;
                currentDesign.elements = [];
                const flyerItems = document.querySelectorAll('#flyer .flyer-item');
                flyerItems.forEach(item => {
                    const component = addedComponents.find(c => c.element === item);
                    if (!component) {
                        return;
                    }

                    const isBaseElement = component.isBaseElement;
                    const itemData = {
                        id: item.dataset.itemId,
                        name: item.dataset.itemName,
                        type: isBaseElement ? 'base' : item.dataset.itemType,
                        price: component.price, 
                        summaryTitle: (item.dataset.itemId === "summary-table") ? item.querySelector('h3').textContent : null,
                        style: item.style.cssText,
                        nameElementState: component.nameElement ? component.nameElement.style.cssText : null,
                        priceElementState: component.priceElement ? component.priceElement.style.cssText : null
                    };
                    currentDesign.elements.push(itemData);
                });
                const cuadroEl = document.getElementById('cuadro');
                if (cuadroEl) {
                    currentDesign.width = parseInt(cuadroEl.style.width);
                    currentDesign.height = parseInt(cuadroEl.style.height);
                }
            }

            // --- Lógica de Manejo de Propiedades ---
            function updatePropertiesPanel() {
                if (selectedFlyerItem) {
                    document.getElementById('properties-section').classList.remove('hidden');
                    elementNameInput.value = selectedFlyerItem.dataset.itemName;
                    posXInput.value = parseInt(selectedFlyerItem.offsetLeft);
                    posYInput.value = parseInt(selectedFlyerItem.offsetTop);
                    
                    const isSummary = selectedFlyerItem.dataset.itemId === 'summary-table';
                    if (isSummary) {
                        document.getElementById('scale-container').classList.add('hidden');
                        document.getElementById('width-container').classList.remove('hidden');
                        widthInput.value = parseFloat(selectedFlyerItem.style.width);
                        document.getElementById('text-options').classList.add('hidden');
                    } else {
                        document.getElementById('scale-container').classList.remove('hidden');
                        document.getElementById('width-container').classList.add('hidden');
                        const scaleMatch = selectedFlyerItem.style.transform.match(/scale\((.*?)\)/);
                        const scale = scaleMatch ? parseFloat(scaleMatch[1]) : 1;
                        scaleInput.value = scale;
                        document.getElementById('text-options').classList.remove('hidden');
                    }
                    zIndexInput.value = selectedFlyerItem.style.zIndex || 10;
                    const isVisible = selectedFlyerItem.style.opacity !== '0';
                    toggleVisibilityBtn.innerHTML = isVisible ? '<i class="fas fa-eye-slash"></i> Ocultar' : '<i class="fas fa-eye"></i> Mostrar';
                } else {
                    document.getElementById('properties-section').classList.add('hidden');
                }
            }

            // --- Event Listeners para Propiedades ---
            posXInput.addEventListener('input', () => { if (selectedFlyerItem) selectedFlyerItem.style.left = `${posXInput.value}px`; });
            posYInput.addEventListener('input', () => { if (selectedFlyerItem) selectedFlyerItem.style.top = `${posYInput.value}px`; });
            scaleInput.addEventListener('input', () => { if (selectedFlyerItem) selectedFlyerItem.style.transform = `scale(${Math.max(MIN_SCALE, Math.min(MAX_SCALE, parseFloat(scaleInput.value)))})`; });
            widthInput.addEventListener('input', () => { if (selectedFlyerItem && selectedFlyerItem.dataset.itemId === 'summary-table') selectedFlyerItem.style.width = `${Math.max(10, Math.min(100, parseFloat(widthInput.value)))}%`; });
            zIndexInput.addEventListener('input', () => { if (selectedFlyerItem) selectedFlyerItem.style.zIndex = zIndexInput.value; });
            
            toggleNameBtn.addEventListener('click', () => {
                const component = addedComponents.find(c => c.element === selectedFlyerItem);
                if (component && component.nameElement) {
                    component.nameElement.style.display = component.nameElement.style.display === 'none' ? 'block' : 'none';
                }
            });
            togglePriceBtn.addEventListener('click', () => {
                const component = addedComponents.find(c => c.element === selectedFlyerItem);
                if (component && component.priceElement) {
                    component.priceElement.style.display = component.priceElement.style.display === 'none' ? 'block' : 'none';
                }
            });
            toggleVisibilityBtn.addEventListener('click', () => {
                if (selectedFlyerItem) {
                    const isVisible = selectedFlyerItem.style.opacity !== '0';
                    selectedFlyerItem.style.opacity = isVisible ? '0' : '1';
                    toggleVisibilityBtn.innerHTML = isVisible ? '<i class="fas fa-eye"></i> Mostrar' : '<i class="fas fa-eye-slash"></i> Ocultar';
                }
            });
            deleteBtn.addEventListener('click', () => {
                if (!selectedFlyerItem) return;
                const componentIndex = addedComponents.findIndex(c => c.element === selectedFlyerItem);
                if (componentIndex !== -1) {
                    const component = addedComponents[componentIndex];
                    component.element.remove();
                    if (component.nameElement) component.nameElement.remove();
                    if (component.priceElement) component.priceElement.remove();
                    addedComponents.splice(componentIndex, 1);
                }
                selectedFlyerItem = null;
                updateBaseElements();
                updatePropertiesPanel();
            });

            // --- Lógica de Creación y Actualización ---
            function createComponentElement(itemData, x, y) {
                const existingComp = addedComponents.find(c => c.id == itemData.id);
                if (existingComp) {
                    showMessage("Este componente ya fue agregado.", 3000);
                    return;
                }
                document.querySelectorAll('.flyer-item').forEach(item => item.classList.remove('active'));
                
                let compEl;
                const isBase = Object.keys(baseElementData).includes(itemData.id);

                if (isBase) {
                    compEl = document.createElement('div');
                    compEl.id = itemData.id;
                    compEl.dataset.itemId = itemData.id;
                    compEl.dataset.itemName = itemData.name;
                    compEl.className = 'flyer-item active';
                    compEl.style.cssText = `
                        position: absolute;
                        top: ${y}px;
                        left: ${x}px;
                        transform: translate(-50%, -50%);
                        text-align: center;
                        color: #e5e7eb;
                        white-space: nowrap;
                        z-index: 9999;
                        padding: 1.5rem;
                        width: 80%;
                        max-width: 600px;
                        ${itemData.id === 'summary-table' ? 'width: 80%; max-width: 600px; background-color: rgba(31, 41, 55, 0.9); backdrop-filter: blur(4px);' : ''}
                    `;
                    compEl.innerHTML = baseElementData[itemData.id].html;
                    
                    if (itemData.id === 'summary-table') {
                        compEl.addEventListener('selectstart', e => e.preventDefault());
                        compEl.addEventListener('dblclick', e => { e.stopPropagation(); compEl.classList.toggle('show-categories'); updateBaseElements(); });
                    }
                } else {
                    const componentId = `comp-${itemData.id}`;
                    compEl = document.createElement('div');
                    compEl.className = `flyer-item p-2 active`;
                    compEl.id = componentId;
                    compEl.dataset.itemId = itemData.id;
                    compEl.dataset.itemName = itemData.name;
                    compEl.dataset.itemPrice = itemData.price;
                    compEl.dataset.itemType = itemData.type;
                    compEl.style.top = `${y}px`;
                    compEl.style.left = `${x}px`;
                    compEl.style.width = '200px';
                    compEl.style.height = '200px';
                    compEl.style.transform = `scale(${INITIAL_IMAGE_SCALE})`;
                    compEl.style.zIndex = '10';
                    
                    compEl.innerHTML = `
                        <img src="comps/${itemData.id}.webp" alt="${itemData.name}" class="w-full h-full object-contain" onerror="this.onerror=null;this.src='https://placehold.co/200x200/374151/ffffff?text=${itemData.name.replace(/\s/g, '+')}';">
                    `;
                    const nameEl = document.createElement('div');
                    nameEl.className = 'flyer-item component-label';
                    nameEl.textContent = itemData.name;
                    nameEl.style.zIndex = '11';
                    nameEl.style.display = 'none';
                    nameEl.dataset.parent = componentId;
                    const priceEl = document.createElement('div');
                    priceEl.className = 'flyer-item component-price';
                    priceEl.textContent = `$${parseFloat(itemData.price).toLocaleString('es-AR')}`;
                    priceEl.style.zIndex = '11';
                    priceEl.style.display = 'none';
                    priceEl.dataset.parent = componentId;

                    document.getElementById('flyer').appendChild(nameEl);
                    document.getElementById('flyer').appendChild(priceEl);
                    setupDraggableElement(nameEl);
                    setupDraggableElement(priceEl);

                    addedComponents.push({
                        id: itemData.id,
                        name: itemData.name,
                        price: parseFloat(itemData.price),
                        type: itemData.type,
                        element: compEl,
                        nameElement: nameEl,
                        priceElement: priceEl
                    });
                }
                
                document.getElementById('flyer').appendChild(compEl);
                setupDraggableElement(compEl);
                if (isBase) {
                    addedComponents.push({ id: itemData.id, name: itemData.name, element: compEl, isBaseElement: true });
                }
                selectedFlyerItem = compEl;
                updateBaseElements();
                updatePropertiesPanel();
            }

            function loadElement(elData) {
                const isBase = Object.keys(baseElementData).includes(elData.id);
                let compEl;

                if (isBase) {
                    compEl = document.createElement('div');
                    compEl.id = elData.id;
                    compEl.dataset.itemId = elData.id;
                    compEl.dataset.itemName = elData.name;
                    
                    const innerWrapper = document.createElement('div');
                    innerWrapper.innerHTML = baseElementData[elData.id].html;
                    
                    compEl.className = `flyer-item`;
                    compEl.innerHTML = innerWrapper.innerHTML;
                    
                    compEl.style.cssText = elData.style;
                    
                    if (elData.id === 'summary-table') {
                        compEl.style.width = elData.style.width;
                        compEl.querySelector('h3').textContent = elData.summaryTitle;
                        compEl.addEventListener('selectstart', e => e.preventDefault());
                        compEl.addEventListener('dblclick', e => { e.stopPropagation(); compEl.classList.toggle('show-categories'); updateBaseElements(); });
                    }
                    addedComponents.push({ id: elData.id, name: elData.name, element: compEl, isBaseElement: true });
                    document.getElementById('flyer').appendChild(compEl);
                    setupDraggableElement(compEl);
                } else {
                    const allProducts = data ? Object.values(data).flat() : [];
                    const currentProduct = allProducts.find(p => p.id === parseInt(elData.id));
                    const currentPrice = currentProduct ? getPrice(currentProduct) : parseFloat(elData.price);
                    compEl = document.createElement('div');
                    compEl.className = `flyer-item p-2`;
                    compEl.id = `comp-${elData.id}`;
                    compEl.dataset.itemId = elData.id;
                    compEl.dataset.itemName = elData.name;
                    compEl.dataset.itemPrice = currentPrice;
                    compEl.dataset.itemType = elData.type;
                    compEl.style.cssText = elData.style;
                    compEl.innerHTML = `<img src="comps/${elData.id}.webp" alt="${elData.name}" class="w-full h-full object-contain" onerror="this.onerror=null;this.src='https://placehold.co/200x200/374151/ffffff?text=${elData.name.replace(/\s/g, '+')}';">`;

                    const nameEl = document.createElement('div');
                    nameEl.className = 'flyer-item component-label';
                    nameEl.textContent = elData.name;
                    nameEl.style.cssText = elData.nameElementState;
                    nameEl.style.zIndex = parseInt(compEl.style.zIndex) + 1;
                    nameEl.dataset.parent = compEl.id;

                    const priceEl = document.createElement('div');
                    priceEl.className = 'flyer-item component-price';
                    priceEl.textContent = `$${currentPrice.toLocaleString('es-AR')}`;
                    priceEl.style.cssText = elData.priceElementState;
                    priceEl.style.zIndex = parseInt(compEl.style.zIndex) + 1;
                    priceEl.dataset.parent = compEl.id;
                    
                    document.getElementById('flyer').appendChild(compEl);
                    document.getElementById('flyer').appendChild(nameEl);
                    document.getElementById('flyer').appendChild(priceEl);
                    setupDraggableElement(compEl);
                    setupDraggableElement(nameEl);
                    setupDraggableElement(priceEl);

                    addedComponents.push({
                        id: elData.id,
                        name: elData.name,
                        price: currentPrice,
                        type: elData.type,
                        element: compEl,
                        nameElement: nameEl,
                        priceElement: priceEl
                    });
                }
                
                selectedFlyerItem = compEl;
            }
            
            function updateBaseElements() {
                const componentsWithoutBase = addedComponents.filter(c => !c.isBaseElement);
                // FIX: Check if comp.price is a number to prevent NaN from propagating
                const totalServicePrice = componentsWithoutBase.reduce((sum, comp) => sum + (typeof comp.price === 'number' ? comp.price : 0), 0) + BASE_SERVICE_PRICE;
                const priceEl = document.querySelector(`#final-price-value`);
                if (priceEl) {
                    priceEl.textContent = `$${totalServicePrice.toLocaleString('es-AR')}`;
                }

                const summaryTableContainer = document.querySelector(`#summary-table`);
                if (summaryTableContainer) {
                    const tableBody = summaryTableContainer.querySelector('.component-table-body');
                    tableBody.innerHTML = '';
                    
                    const showCategories = summaryTableContainer.classList.contains('show-categories');
                    let currentCategory = '';
                    
                    componentsWithoutBase.forEach(comp => {
                        if (showCategories && comp.type !== currentCategory) {
                            const categoryRow = document.createElement('tr');
                            categoryRow.innerHTML = `<td colspan="2" class="category-row">${comp.type}</td>`;
                            tableBody.appendChild(categoryRow);
                            currentCategory = comp.type;
                        }
                        
                        const row = document.createElement('tr');
                        row.className = 'border-t border-gray-700/50';
                        row.innerHTML = `<td class="py-2 text-white flex flex-col"><span class="text-base">${comp.name}</span></td>
                            <td class="py-2 text-right text-green-400">$${(comp.price).toLocaleString('es-AR')}</td>`;
                        tableBody.appendChild(row);
                    });

                    const serviceRow = document.createElement('tr');
                    serviceRow.className = 'border-t border-gray-700/50';
                    serviceRow.innerHTML = `
                        <td class="py-2 text-white">Servicio Técnico<br><span class="text-sm text-gray-400">[Personal y via Web]</span></td>
                        <td class="py-2 text-right text-green-400">$${(BASE_SERVICE_PRICE).toLocaleString('es-AR')}</td>
                    `;
                    tableBody.appendChild(serviceRow);
                }
            }


            // --- Handlers de Eventos de Drag & Drop ---
            function handleDragOver(e) { e.preventDefault(); e.target.classList.add('droppable'); }
            function handleDragLeave(e) { e.target.classList.remove('droppable'); }
            function handleDrop(e) {
                e.preventDefault();
                e.target.classList.remove('droppable');
                try {
                    const data = e.dataTransfer.getData('text/plain');
                    if (!data) return;
                    const parsedData = JSON.parse(data);
                    const flyerRect = e.currentTarget.getBoundingClientRect();
                    const x = e.clientX - flyerRect.left;
                    const y = e.clientY - flyerRect.top;
                    createComponentElement(parsedData, x, y);
                } catch (error) { console.error('Failed to parse dropped data:', error); }
            }
            function handleDeselect(e) {
                if (!e.target.closest('.flyer-item')) {
                    if (selectedFlyerItem) selectedFlyerItem.classList.remove('active');
                    selectedFlyerItem = null;
                    updatePropertiesPanel();
                }
            }
            function handleWheel(e) {
                if (selectedFlyerItem) {
                    e.preventDefault();
                    let currentScale = parseFloat(selectedFlyerItem.style.transform.replace('scale(', '')) || 1;
                    if (selectedFlyerItem.dataset.itemId === 'summary-table') {
                        let newWidth = parseFloat(selectedFlyerItem.style.width) + (e.deltaY < 0 ? 20 : -20);
                        selectedFlyerItem.style.width = `${Math.min(Math.max(newWidth, 200), 1000)}px`;
                    } else {
                        let newScale = currentScale + (e.deltaY < 0 ? 0.2 : -0.2);
                        selectedFlyerItem.style.transform = `scale(${Math.min(Math.max(newScale, MIN_SCALE), MAX_SCALE)})`;
                    }
                    updatePropertiesPanel();
                }
            }
            
            // --- Carga Inicial de Datos ---
            async function initializeApp() {
                 try {
                    // FIX: Changed the JSON file to 'productsH.json'
                    const productsResponse = await fetch('productsH.json');
                    data = await productsResponse.json();
                    populateCategorySelector();
                } catch (error) {
                    showMessage("Error al cargar los datos de productos.", 4000);
                }

                try {
                    const flyersResponse = await fetch('flyers.json');
                    if (flyersResponse.ok) {
                        const responseData = await flyersResponse.json();
                        if (Array.isArray(responseData) && responseData.length > 0) {
                            allCuadros = responseData;
                            renderCuadrosSelector();
                            switchCuadro(allCuadros[0].id);
                        } else {
                            createNewCuadro("Cuadro 1");
                        }
                    } else {
                        createNewCuadro("Cuadro 1");
                    }
                } catch (error) {
                    console.error("Error al cargar flyers.json:", error);
                    createNewCuadro("Cuadro 1");
                }
            }
            
            async function loadDesignsFromJson() {
                try {
                    const clipboardText = await navigator.clipboard.readText();
                    const parsedData = JSON.parse(clipboardText);

                    if (Array.isArray(parsedData) && parsedData.length > 0) {
                        allCuadros = parsedData;
                        renderCuadrosSelector();
                        switchCuadro(allCuadros[0].id);
                        showMessage("Diseños cargados desde el portapapeles.", 3000);
                    } else {
                        showMessage("El JSON del portapapeles no es válido o está vacío.", 5000);
                    }
                } catch (e) {
                    console.error("Error al cargar desde el portapapeles:", e);
                    showMessage("Error: El contenido del portapapeles no es un JSON válido.", 5000);
                }
            }

            // --- Event Listeners Globales ---
            addCuadroBtn.addEventListener('click', () => {
                const newCuadroName = prompt("Ingresa el nombre del nuevo cuadro:", `Cuadro ${allCuadros.length + 1}`);
                if (newCuadroName) createNewCuadro(newCuadroName);
            });
            deleteCuadroBtn.addEventListener('click', () => {
                if (allCuadros.length > 1 && confirm(`¿Estás seguro de que quieres eliminar el cuadro "${currentDesign.name}"?`)) {
                    allCuadros = allCuadros.filter(c => c.id !== currentCuadroId);
                    renderCuadrosSelector();
                    switchCuadro(allCuadros[0].id);
                } else if (allCuadros.length <= 1) {
                    showMessage("No puedes eliminar el último cuadro.", 3000);
                }
            });
            cuadroSelector.addEventListener('change', (e) => switchCuadro(e.target.value));
            saveBtn.addEventListener('click', () => {
                saveCurrentDesign();
                const jsonString = JSON.stringify(allCuadros, null, 2);
                navigator.clipboard.writeText(jsonString);
                showMessage("JSON de cuadros copiado al portapapeles. ¡Pégalo en tu archivo flyers.json!", 5000);
            });
            loadBtn.addEventListener('click', loadDesignsFromJson);

            // --- Event Listeners para la Toolbar de Cuadro ---
            toolbarSizeSelector.addEventListener('change', (e) => {
                const [width, height] = e.target.value.split('x').map(Number);
                if (cuadroEl) {
                    cuadroEl.style.width = `${width}px`;
                    cuadroEl.style.height = `${height}px`;
                    currentDesign.width = width;
                    currentDesign.height = height;
                }
            });

            toolbarAddSummaryBtn.addEventListener('click', () => {
                const flyerEl = document.getElementById('flyer');
                const existingElement = addedComponents.find(c => c.isBaseElement && c.id === 'summary-table');
                if (existingElement) {
                    showMessage("El elemento de resumen ya existe.", 3000);
                    return;
                }
                const flyerRect = flyerEl.getBoundingClientRect();
                createComponentElement(baseElementData['summary-table'], flyerRect.width / 2, flyerRect.height / 2);
            });
            toolbarAddPriceBtn.addEventListener('click', () => {
                const flyerEl = document.getElementById('flyer');
                 const existingElement = addedComponents.find(c => c.isBaseElement && c.id === 'final-price-value');
                 if (existingElement) {
                    showMessage("El elemento de precio ya existe.", 3000);
                    return;
                }
                const flyerRect = flyerEl.getBoundingClientRect();
                createComponentElement(baseElementData['final-price-value'], flyerRect.width / 2, flyerRect.height / 2);
            });
            toolbarAddInfoBtn.addEventListener('click', () => {
                const flyerEl = document.getElementById('flyer');
                const existingElement = addedComponents.find(c => c.isBaseElement && c.id === 'final-price-info');
                if (existingElement) {
                    showMessage("El elemento de información ya existe.", 3000);
                    return;
                }
                const flyerRect = flyerEl.getBoundingClientRect();
                createComponentElement(baseElementData['final-price-info'], flyerRect.width / 2, flyerRect.height / 2);
            });
            toolbarClearFlyerBtn.addEventListener('click', () => {
                const flyerEl = document.getElementById('flyer');
                if (!flyerEl) return;
                const componentElements = flyerEl.querySelectorAll('.flyer-item');
                componentElements.forEach(item => {
                    const componentIndex = addedComponents.findIndex(c => c.element === item);
                    if (componentIndex !== -1) {
                        addedComponents.splice(componentIndex, 1);
                    }
                    item.remove();
                });
                selectedFlyerItem = null;
                updateBaseElements();
                updatePropertiesPanel();
                showMessage("Cuadro de diseño limpiado.", 3000);
            });
            
            // Lógica de Selectores
            function populateCategorySelector() {
                if (!data) return;
                categorySelector.innerHTML = '';
                const categories = [{ key: '', name: 'Selecciona una categoría' }];
                for (const key in categoryMap) {
                    if (data[key] && data[key].length > 0) {
                        categories.push({ key: key, name: categoryMap[key].name });
                    }
                }
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.key;
                    option.textContent = cat.name;
                    categorySelector.appendChild(option);
                });
                categorySelector.addEventListener('change', () => populateImageSelector(categorySelector.value));
            }

            function populateImageSelector(categoryKey) {
                if (!data || !categoryKey) { imageSelector.innerHTML = ''; return; }
                imageSelector.innerHTML = '';
                const items = data[categoryKey].filter(item => item.visible !== 0);
                items.forEach(item => {
                    const imgContainer = document.createElement('div');
                    imgContainer.className = 'selector-item p-2 text-center flex flex-col items-center justify-center';
                    imgContainer.draggable = true;
                    imgContainer.dataset.itemId = item.id;
                    imgContainer.dataset.itemName = item.name;
                    imgContainer.dataset.itemPrice = getPrice(item);
                    imgContainer.dataset.itemType = categoryMap[categoryKey].name;
                    imgContainer.innerHTML = `<img src="comps/${item.id}.webp" alt="${item.name}" class="w-16 h-16 object-contain mb-2" onerror="this.onerror=null;this.src='https://placehold.co/64x64/374151/ffffff?text=IMG'">
                        <span class="text-xs text-gray-400">${item.name}</span>
                        <span class="text-xs text-green-400 font-bold">$${getPrice(item).toLocaleString('es-AR')}</span>`;
                    imageSelector.appendChild(imgContainer);
                    imgContainer.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/plain', JSON.stringify({ id: item.id, name: item.name, price: getPrice(item), type: categoryMap[categoryKey].name })); });
                });
            }

            initializeApp();
        });
    </script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const flyerSizeSelector = document.getElementById('flyer-size-selector');
        const cuadro = document.getElementById('cuadro');

        const updateCuadroSize = () => {
          const selectedSize = flyerSizeSelector.value;
          const [width, height] = selectedSize.split('x').map(Number);
          if (cuadro) {
            cuadro.style.width = `${width}px`;
            cuadro.style.height = `${height}px`;
          }
        };

        flyerSizeSelector.addEventListener('change', updateCuadroSize);

        // Initialize the size on page load
        updateCuadroSize();
      });
    </script>
</body>
</html>
