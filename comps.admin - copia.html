<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrador de Vectores de Productos</title>
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ctext y='26' font-size='28' x='3' font-family='Arial'%3E%24%3C/text%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,wght@0,400;0,700;1,400&family=Saira:wght@400;900;1,400&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* General Styles */
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
            color: #e5e7eb; /* text-gray-200 */
        }
        .font-saira-black { font-family: 'Saira', sans-serif; font-weight: 900; }

        /* Input and Textarea Styles */
        .overview-table input,
        .overview-table textarea {
            background: rgba(31,41,55,0.5)!important; /* bg-gray-800/50 */
            font-family: 'Saira', sans-serif;
            font-weight: 600;
            box-shadow: 0 2px 8px 0 rgba(0,0,0,0.10);
            color: #e5e7eb;
            border-radius: 0.375rem;
            border: 1px solid #374151;
            transition: border-color 0.15s, box-shadow 0.15s;
        }
        .overview-table input:focus,
        .overview-table textarea:focus {
            border-color: #6366f1; /* indigo-500 */
            box-shadow: 0 0 0 2px #6366f1;
        }

        /* Shared input style for tables and base details */
        .overview-table input[type="text"],
        .overview-table input[type="number"],
        .overview-table textarea,
        #base-details input, #base-details textarea, #base-details select,
        #bundle-details input, #bundle-details textarea, #bundle-details select,
        #scraping-tools-section select {
            background-color: #1f2937; /* bg-gray-800 */
            border: 1px solid #374151; /* border-gray-700 */
            border-radius: 0.375rem;
            padding: 0.5rem;
            font-size: 0.875rem;
            color: #e5e7eb;
            transition: all 0.15s ease-in-out;
            width: 100%;
        }
        .overview-table input[type="text"]:focus,
        .overview-table input[type="number"]:focus,
        .overview-table textarea:focus,
        #base-details input:focus, #base-details textarea:focus, #base-details select:focus,
        #bundle-details input:focus, #bundle-details textarea:focus, #bundle-details select:focus,
        #scraping-tools-section select:focus {
            border-color: #6366f1; /* indigo-500 */
            box-shadow: 0 0 0 2px #4f46e5;
        }
        .overview-table textarea { min-height: 40px; }


        /* Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out, opacity 0.2s;
            cursor: pointer;
        }
        .btn-primary { background-color: #6366f1; color: #ffffff; }
        .btn-primary:hover { background-color: #4f46e5; }
        .btn-secondary { background-color: #4b5563; color: #ffffff; padding: 0.5rem 1rem; }
        .btn-secondary:hover { background-color: #374151; }
        .btn-danger { background-color: #ef4444; color: #ffffff; }
        .btn-danger:hover { background-color: #dc2626; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Icon and Title Styles */
        .lucide-icon {
            display: inline-block;
            vertical-align: middle;
            width: 1em;
            height: 1em;
            stroke-width: 2;
            stroke: currentColor;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .section-title-admin {
            border-bottom: 3px solid;
            border-image: linear-gradient(to right, #6366f1, #a855f7) 1;
            padding-bottom: 0.5rem;
            display: inline-block;
        }
        
        /* Output and Message Styles */
        #output-code {
            background-color: #1f2937; /* bg-gray-800 */
            border-color: #374151; /* border-gray-700 */
            color: #42d232; /* green-400 */
        }
        #copy-message { color: #42d232; }
        #error-message { color: #ef4444; }
        #warning-message { color: #f59e0b; }

        /* Table Styles */
        .overview-table th, .overview-table td,
        .bundles-table th, .bundles-table td {
            padding: 0.5rem;
            vertical-align: middle;
        }
        .price-wrapper {
            display: flex;
            flex-direction: column;
            min-height: 50px; /* Ensure space for indicators */
            justify-content: center;
        }
        .indicators-container {
            display: flex;
            gap: 0.25rem;
            margin-top: 0.25rem;
            height: 18px; /* Give a fixed height to prevent layout shifts */
        }
        
        .add-row-button-cell {
            text-align: center;
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        .add-row-button {
            background-color: #6366f1;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .add-row-button:hover { background-color: #4f46e5; }

        /* Price Check Highlight Styles */
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 3px 2px rgba(20, 184, 166, 0.3); }
            50% { box-shadow: 0 0 10px 5px rgba(20, 184, 166, 0); }
        }
        .price-scraping {
            animation: pulse-glow 1.5s infinite;
        }
        tr.price-lower { background-color: rgba(34, 197, 94, 0.2); } /* Verde */
        tr.price-higher { background-color: rgba(168, 85, 247, 0.2); } /* Violeta */
        tr.price-same { background-color: rgba(59, 130, 246, 0.15); } /* Azul */
        tr.price-error { background-color: rgba(239, 68, 68, 0.2); } /* Rojo */

        .indicator-badge {
            padding: 0.1rem 0.4rem;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 700;
            color: white;
            opacity: 0;
            animation: fadeIn 0.5s forwards;
            white-space: nowrap;
        }
        .indicator-badge.positive { background-color: #9333ea; }
        .indicator-badge.negative { background-color: #16a34a; }
        .indicator-badge.status { background-color: #dc2626; }
        .indicator-badge.quantity { background-color: #4b5563; }
        @keyframes fadeIn { to { opacity: 1; } }


        /* Image Preview Styles */
        #image-preview {
            max-width: 250px;
            max-height: 250px;
            transition: opacity 0.2s ease-in-out;
        }
        #image-preview img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* Category Navigation Bar Styles */
        .category-navbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            z-index: 50;
            background: linear-gradient(to right, #1f2937 80%, #6366f1 100%);
            border-bottom: 2px solid #6366f1;
            box-shadow: 0 2px 8px 0 rgba(0,0,0,0.25);
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 0.25rem 0.5rem;
            transition: top 0.2s;
        }
        .category-navbar.hidden { display: none; }
        .category-navbar .cat-nav-btn {
            background: none;
            border: none;
            color: #e5e7eb;
            font-weight: 600;
            font-size: 0.9rem;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            transition: background 0.15s, color 0.15s;
            cursor: pointer;
            white-space: nowrap;
            position: relative;
        }
        .category-navbar .cat-nav-btn:not(:last-child)::after {
            content: '|';
            position: absolute;
            right: -0.25rem;
            top: 50%;
            transform: translateY(-50%);
            color: #4b5563;
        }

        .category-navbar .cat-nav-btn.active, .category-navbar .cat-nav-btn:hover {
            background: #6366f1;
            color: #fff;
        }
        .category-navbar-spacer {
            width: 100%;
            transition: height 0.2s;
        }
        
        /* Bases & Bundles Section Styles */
        .management-section {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 1.5rem;
        }
        .list-item {
            cursor: pointer;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
            border: 1px solid #374151;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            min-height: 64px;
        }
        .list-item.active {
            background-color: #6366f1;
            color: white;
            border-color: #4f46e5;
        }
        .list-item:not(.active):hover {
            background-color: #374151;
        }
        .list-item .component-thumbs img {
            height: 48px;
            width: 48px;
            object-fit: cover;
            border-radius: 0.375rem; /* rounded-md */
        }
        
        /* Accordion Styles */
        .accordion-header .lucide-icon {
            transition: transform 0.3s ease-in-out;
        }
        .accordion-header .rotate-180 {
            transform: rotate(180deg);
        }
        .accordion-content {
            transition: max-height 0.3s ease-in-out;
            overflow: hidden;
        }
        
        .ram-qty-btn {
            background-color: #374151;
            border: 1px solid #4b5563;
        }
        .ram-qty-btn.active {
            background-color: #6366f1;
            border-color: #4f46e5;
            color: white;
        }


        @media (max-width: 1024px) {
            .management-section {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 640px) {
            .category-navbar { font-size: 0.95rem; }
        }
    </style>
</head>
<body class="p-4 md:p-8 bg-gray-900 min-h-screen text-gray-200">
    <!-- Image preview element -->
    <div id="image-preview" class="hidden fixed bottom-4 right-4 bg-gray-800 border border-gray-700 rounded-lg shadow-lg z-50 p-2">
        <img src="" alt="Vista Previa" class="max-w-xs max-h-xs object-contain">
    </div>

    <!-- Sticky category navigation bar -->
    <div id="category-navbar" class="category-navbar"></div>
    <div id="category-navbar-spacer" class="category-navbar-spacer"></div>

    <!-- Main container -->
    <div class="mx-auto bg-gray-800 p-6 md:p-8 rounded-xl shadow-lg border border-gray-700" style="width:95%;max-width:1800px;">
        <h1 class="text-3xl font-saira-black text-white mb-6 text-center">Administrador de Vectores de Productos</h1>
        
        <!-- Top Action Buttons -->
        <div id="top-actions" class="flex justify-center items-center gap-4 mb-8">
             <button onclick="reloadDataFromJson()" class="btn btn-secondary">
                <span class="lucide-icon mr-2" data-lucide="refresh-ccw"></span> Recargar de Archivo
            </button>
            <button onclick="resetSessionAndReload()" class="btn btn-secondary border-amber-500/50 hover:bg-amber-600">
                <span class="lucide-icon mr-2" data-lucide="eraser"></span> Restablecer Sesión
            </button>
        </div>

        <!-- Scraping Tools Section -->
        <div id="scraping-tools-section-container" class="mb-8 bg-gray-900 rounded-lg shadow-sm border border-gray-700">
            <h3 id="scraping-accordion-header" class="accordion-header flex justify-between items-center text-xl font-semibold text-gray-100 p-6 cursor-pointer">
                <span>Herramientas de Scraping</span>
                <span class="lucide-icon rotate-180" data-lucide="chevron-down"></span>
            </h3>
            <div id="scraping-accordion-content" class="accordion-content p-6 pt-0">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-start">
                    <div>
                        <label for="scraping-api-select" class="block text-sm font-medium mb-1">API de Scrapeo</label>
                        <select id="scraping-api-select" size="3" class="h-24"></select>
                    </div>
                    <div>
                        <label for="cors-proxy-select" class="block text-sm font-medium mb-1">Proxy CORS</label>
                        <select id="cors-proxy-select" size="3" class="h-24"></select>
                    </div>
                    <div class="flex flex-col items-center pt-6">
                        <button id="check-prices-btn" onclick="checkAllPrices()" class="btn btn-primary bg-teal-500 hover:bg-teal-600 w-full">
                            <span id="check-prices-icon" class="lucide-icon mr-2" data-lucide="scan-line"></span>
                            <span id="check-prices-text">Chequear Precios</span>
                        </button>
                        <label class="flex items-center gap-2 cursor-pointer mt-2">
                            <input type="checkbox" id="check-quantity-toggle" checked class="w-4 h-4 rounded text-indigo-500 bg-gray-700 border-gray-600 focus:ring-indigo-600">
                            <span class="text-xs font-medium">Buscar disponibles</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bases Section (Accordion) -->
        <div id="bases-section-container" class="mb-8 bg-gray-900 rounded-lg shadow-sm border border-gray-700">
            <h3 id="bases-accordion-header" class="accordion-header flex justify-between items-center text-xl font-semibold text-gray-100 p-6 cursor-pointer">
                <span>Bases (CPU + Mother + RAM)</span>
                <span class="lucide-icon" data-lucide="chevron-down"></span>
            </h3>
            <div id="bases-accordion-content" class="accordion-content p-6 pt-0 hidden">
                 <div id="bases-section" class="management-section">
                    <!-- Content generated by JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- Bundles Section (Accordion) -->
        <div id="bundles-section-container" class="mb-8 bg-gray-900 rounded-lg shadow-sm border border-gray-700">
            <h3 id="bundles-accordion-header" class="accordion-header flex justify-between items-center text-xl font-semibold text-gray-100 p-6 cursor-pointer">
                <span>Bundles (Componentes Múltiples)</span>
                <span class="lucide-icon" data-lucide="chevron-down"></span>
            </h3>
            <div id="bundles-accordion-content" class="accordion-content p-6 pt-0 hidden">
                 <div id="bundles-section" class="management-section">
                    <!-- Content generated by JavaScript -->
                </div>
            </div>
        </div>


        <!-- Table View Container -->
        <div id="overview-view" class="tab-content">
            <!-- Content will be generated by JavaScript -->
        </div>

        <!-- Code Generation Section -->
        <section class="mt-10 p-6 bg-gray-900 rounded-lg shadow-inner border border-gray-700">
            <h2 class="text-2xl font-semibold text-gray-100 mb-4 text-center section-title-admin">Generar y Copiar Código de Vectores</h2>
            <textarea id="output-code" rows="15" class="w-full p-4 border border-gray-700 rounded-lg bg-gray-800 text-green-400 font-mono text-sm resize-y" readonly></textarea>
            <div class="flex flex-wrap justify-center items-center mt-4 gap-4">
                <button onclick="generateCode()" class="btn btn-primary">
                    <span class="lucide-icon mr-2" data-lucide="code"></span> Generar Código
                </button>
                <button onclick="copyCode()" class="btn btn-secondary">
                    <span class="lucide-icon mr-2" data-lucide="copy"></span> Copiar Código
                </button>
            </div>
            <div id="message-container" class="fixed bottom-6 left-1/2 -translate-x-1/2 flex flex-col items-center gap-2 z-50"></div>
        </section>
    </div>

<script>
    // --- Data Configuration ---
    const CATEGORY_NAV_LIST = [
      { key: 'bases-section-container', label: 'Bases' }, 
      { key: 'bundles-section-container', label: 'Bundles' }, 
      { key: 'armadasOptions', label: 'Armadas', folder: 'armadas' },
      { key: 'miniPcOptions', label: 'MiniPCs', folder: 'minipc' },
      { key: 'towersOptions', label: 'Torres', folder: 'torres' }, 
      { key: 'comboOptions', label: 'Combos', folder: 'combos' }, 
      { key: 'cpuOptions', label: 'CPU', folder: 'cpus' }, 
      { key: 'motherboardOptions', label: 'Mother', folder: 'moms' }, 
      { key: 'ramOptions', label: 'RAM', folder: 'rams' }, 
      { key: 'gpuOptions', label: 'GPU', folder: 'gpus' }, 
      { key: 'ssdOptions', label: 'SSD', folder: 'discos' }, 
      { key: 'psuOptions', label: 'PSU', folder: 'psus' }, 
      { key: 'monitorOptions', label: 'Monitores', folder: 'monitores' }, 
      { key: 'mouseOptions', label: 'Mouse', folder: 'mouses' }, 
      { key: 'joystickOptions', label: 'Joysticks', folder: 'joysticks' }, 
      { key: 'keyboardOptions', label: 'Teclados', folder: 'teclados' }, 
      { key: 'comboMouseTecladoOptions', label: 'M+T', folder: 'combo-mouse-teclado' }, 
      { key: 'auricularesOptions', label: 'Auris', folder: 'auriculares' }, 
      { key: 'parlantesOptions', label: 'Parlantes', folder: 'parlantes' },
      { key: 'webcamOptions', label: 'Webcams', folder: 'webcams' },
      { key: 'microfonosOptions', label: 'Mics', folder: 'mics' },
      { key: 'wifiOptions', label: 'WiFi', folder: 'wifi' },
      { key: 'arosDeLuzOptions', label: 'Luz', folder: 'luz' }
    ];

    const dataMap = {
        baseOptions: [],
        bundleOptions: [], 
        armadasOptions: [], towersOptions: [], ssdOptions: [], gpuOptions: [], 
        psuOptions: [], motherboardOptions: [], cpuOptions: [], ramOptions: [], comboOptions: [], 
        monitorOptions: [], mouseOptions: [], joystickOptions: [], keyboardOptions: [], 
        comboMouseTecladoOptions: [], auricularesOptions: [], parlantesOptions: [],
        webcamOptions: [], microfonosOptions: [], wifiOptions: [], arosDeLuzOptions: [],
        miniPcOptions: []
    };
    
    let selectedBaseIndex = 0;
    let selectedBundleIndex = 0;
    let draggedBundleComponentIndex = null;

    const SCRAPING_APIS = [
        { id: 'ml-default', name: 'Mercado Libre - Default' }
    ];

 const CORS_PROXIES = [
    { id: 'allorigins', url: 'https://api.allorigins.win/raw?url=' },
    { id: 'corsproxy-io', url: 'https://corsproxy.io/?' },
    { id: 'cors-lol', url: 'https://cors.lol/?' },
];


    // --- Category Navigation ---
    
    function renderCategoryNavbar() {
        const navbar = document.getElementById('category-navbar');
        navbar.innerHTML = CATEGORY_NAV_LIST.map(cat => {
            const targetId = cat.key.includes('Options') ? `table-container-${cat.key}` : cat.key;
            return `<button class="cat-nav-btn" data-cat="${targetId}" onclick="scrollToCategory('${targetId}')">${cat.label}</button>`
        }).join('');
        updateNavbarSpacer();
    }
    
    function updateNavbarSpacer() {
        const navbar = document.getElementById('category-navbar');
        const spacer = document.getElementById('category-navbar-spacer');
        if (navbar && spacer) {
            spacer.style.height = `${navbar.offsetHeight}px`;
        }
    }

    function scrollToCategory(targetId) {
        document.querySelectorAll('.category-navbar .cat-nav-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.cat === targetId);
        });
        
        const categoryDiv = document.getElementById(targetId);
        if(categoryDiv) {
            // Adjust for fixed navbar height
            const navbarHeight = document.getElementById('category-navbar').offsetHeight;
            const elementPosition = categoryDiv.getBoundingClientRect().top;
            const offsetPosition = elementPosition + window.pageYOffset - navbarHeight - 20; // 20px extra space

            window.scrollTo({
                top: offsetPosition,
                behavior: 'smooth'
            });
        }
    }

    // --- Helper & Utility Functions ---

    function getComponentName(type) {
        const keyWithoutOptions = type.replace('Options', '');
        const names = {
            base: 'Base', bundle: 'Bundle', armadas: 'Armada', towers: 'Torre', ssd: 'SSD', gpu: 'GPU', psu: 'PSU',
            motherboard: 'Motherboard', cpu: 'CPU', ram: 'RAM',
            combo: 'Combo', monitor: 'Monitor', mouse: 'Mouse',
            joystick: 'Joystick', keyboard: 'Teclado',
            comboMouseTeclado: 'Combo Mouse y Teclado', auriculares: 'Auricular',
            parlantes: 'Parlante', webcam: 'Webcam', microfonos: 'Mic', wifi: 'WiFi', arosDeLuz: 'Luz', miniPc: 'MiniPC'
        };
        return names[keyWithoutOptions] || 'Componente';
    }
    
    function autofillImagePath(input, categoryKey, index) {
        if (input.value.trim() === '') {
            const categoryInfo = CATEGORY_NAV_LIST.find(cat => cat.key === categoryKey);
            const product = dataMap[categoryKey][index];
            if (categoryInfo && categoryInfo.folder && product && product.id) {
                const newPath = `comps/${categoryInfo.folder}/${product.id}.webp`;
                input.value = newPath;
                updateProduct(categoryKey, index, 'image_url', newPath);
            }
        }
    }

    function showToast(message, type = 'success') {
        const container = document.getElementById('message-container');
        const toast = document.createElement('div');
        const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
        toast.className = `px-4 py-2 rounded-md text-white font-semibold shadow-lg ${bgColor}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }

    function findComponentById(id) {
        // Search in regular components first
        for (const categoryKey in dataMap) {
            if (categoryKey === 'baseOptions' || categoryKey === 'bundleOptions') continue;
            const component = dataMap[categoryKey].find(p => p.id == id);
            if (component) {
                return { component, categoryKey };
            }
        }
        // If not found, search in bases
        const base = dataMap.baseOptions.find(b => b.id == id);
        if (base) {
            return { component: base, categoryKey: 'baseOptions' };
        }
        return null;
    }

    function modifyMercadoLibreLink(urlString) {
        if (!urlString || !urlString.includes('mercadolibre.com')) {
            return urlString;
        }
        try {
            const url = new URL(urlString);
            url.searchParams.set('offer_type', 'OFFICIAL_STORE');
            return url.toString();
        } catch (e) {
            console.error("Invalid URL for modification:", urlString, e);
            return urlString; // Return original if URL is malformed
        }
    }
    
    function copyToClipboard(text) {
        if (!text) return;
        navigator.clipboard.writeText(text).then(function() {
            showToast(`ID "${text}" copiado.`);
        }, function(err) {
            showToast('No se pudo copiar el ID.', 'error');
            console.error('Could not copy text: ', err);
        });
    }

    // --- Data Persistence ---

    function saveDataToSessionStorage() {
        try {
            sessionStorage.setItem('productAdminData', JSON.stringify(dataMap));
        } catch (e) {
            console.error("Error saving to sessionStorage:", e);
            showToast('Error al guardar datos en la sesión.', 'error');
        }
    }

    function loadDataFromSessionStorage() {
        try {
            const storedData = sessionStorage.getItem('productAdminData');
            return storedData ? JSON.parse(storedData) : null;
        } catch (e) {
            console.error("Error loading from sessionStorage:", e);
            sessionStorage.removeItem('productAdminData');
            return null;
        }
    }

    // --- Core Data Operations ---

    function getAllIds() {
        const ids = new Set();
        for (const key in dataMap) {
            dataMap[key].forEach(item => {
                if (item.id) ids.add(item.id);
            });
        }
        return ids;
    }

    function generateUniqueId(existingIds) {
        let newId;
        do {
            newId = Math.floor(Math.random() * 99999) + 1;
        } while (existingIds.has(newId));
        return newId;
    }

    function sanitizeAndAssignDefaults() {
        const existingIds = getAllIds();
        for (const categoryKey in dataMap) {
            if (!Array.isArray(dataMap[categoryKey])) {
                dataMap[categoryKey] = []; // Ensure it's an array if it's not
            }
            dataMap[categoryKey].forEach(item => {
                if (!item.id || item.id.toString().includes('-default')) {
                    const newId = generateUniqueId(existingIds);
                    item.id = newId;
                    existingIds.add(newId);
                }
                if (item.visible === undefined) {
                    item.visible = 1;
                }
                // Specific defaults
                if (categoryKey === 'baseOptions') {
                    if (item.description === undefined) item.description = '';
                    if (item.totalram === undefined) item.totalram = 0;
                }
                if (categoryKey === 'bundleOptions') {
                    if (item.description === undefined) item.description = '';
                }
                if (categoryKey === 'miniPcOptions') {
                    if (item.cpu === undefined) item.cpu = '';
                    if (item.ram === undefined) item.ram = '';
                    if (item.ssd === undefined) item.ssd = '';
                }
                if (categoryKey === 'ramOptions') {
                    if (item.total === undefined) item.total = 0;
                }
            });
        }
    }

    function addProduct(categoryKey, productData) {
        let newProduct;
        if (productData) {
            newProduct = productData;
        } else {
            newProduct = { name: '', price: 0, image_url: '', link: '', visible: 1 };
            if (categoryKey === 'miniPcOptions') {
                newProduct.cpu = '';
                newProduct.ram = '';
                newProduct.ssd = '';
            } else if (categoryKey === 'ramOptions') {
                newProduct.total = 0;
                newProduct.description = '';
            } else {
                newProduct.description = '';
            }
        }
        
        if (!newProduct.id) {
            newProduct.id = generateUniqueId(getAllIds());
        }
        if (newProduct.visible === undefined) {
            newProduct.visible = 1;
        }
        dataMap[categoryKey].push(newProduct);
        renderOverviewTables();
        saveDataToSessionStorage();
    }

    function removeProduct(categoryKey, index) {
        if (!dataMap[categoryKey] || index < 0 || index >= dataMap[categoryKey].length) return;
        dataMap[categoryKey].splice(index, 1);
        renderOverviewTables();
        saveDataToSessionStorage();
    }

    function updateProduct(categoryKey, index, key, value) {
        if (dataMap[categoryKey] && dataMap[categoryKey][index]) {
            dataMap[categoryKey][index][key] = value;
            
            if (key === 'price' || (categoryKey === 'ramOptions' && key === 'total')) {
                updateAllBaseTotals();
                updateAllBundleTotals();
                renderBasesSection();
                renderBundlesSection();
            }

            saveDataToSessionStorage();
        }
    }

    function formatAndUpdatePrice(input, categoryKey, index) {
        let raw = input.value.replace(/[^\d]/g, '');
        if (raw.length > 9) raw = raw.slice(0,9);
        let num = parseInt(raw, 10) || 0;
        input.value = num ? num.toLocaleString('es-AR') : '';
        updateProduct(categoryKey, index, 'price', num);
    }
    
    async function replaceLink(categoryKey, index) {
        try {
            let text = await navigator.clipboard.readText();
            if (typeof text !== 'string' || !text.trim().startsWith('http')) {
                showToast('El portapapeles no contiene un link válido.', 'error');
                return;
            }
            text = modifyMercadoLibreLink(text.trim());
            dataMap[categoryKey][index].link = text;
            saveDataToSessionStorage();
            renderOverviewTables();
            showToast('Link reemplazado con éxito.');
        } catch (err) {
            console.error("Clipboard error:", err);
            showToast('No se pudo acceder al portapapeles.', 'error');
        }
    }
    
    // --- UI Rendering ---

    function showImagePreview(imageUrl) {
        const preview = document.getElementById('image-preview');
        const img = preview.querySelector('img');
        if (imageUrl) {
            img.src = imageUrl;
            preview.classList.remove('hidden');
        }
    }

    function hideImagePreview() {
        document.getElementById('image-preview').classList.add('hidden');
    }

    // --- BUNDLES Section Rendering ---
    function renderBundlesSection() {
        const container = document.getElementById('bundles-section');
        if (!dataMap.bundleOptions) dataMap.bundleOptions = [];
        if (dataMap.bundleOptions.length === 0) {
            dataMap.bundleOptions.push({ id: generateUniqueId(getAllIds()), name: 'Nuevo Bundle', description: '', components: [], total: 0, visible: 1 });
        }
        
        container.innerHTML = `
            <div class="flex flex-col gap-2">
                <div id="bundle-list" class="flex flex-col gap-2 mb-4">
                    ${dataMap.bundleOptions.map((bundle, index) => {
                        const componentImages = (bundle.components || [])
                            .map(compId => {
                                const found = findComponentById(compId);
                                return found ? found.component.image_url : null;
                            })
                            .filter(Boolean);

                        return `
                        <div id="bundle-item-${index}" class="list-item ${index === selectedBundleIndex ? 'active' : ''}" onclick="selectBundle(${index})">
                            <div class="flex-grow">
                                <p class="font-bold truncate">${bundle.name || 'Sin Nombre'}</p>
                                <p class="text-xs opacity-75 truncate">${bundle.id || 'Sin ID'}</p>
                                <p class="font-bold text-lg text-teal-400 mt-1">$${(bundle.total || 0).toLocaleString('es-AR')}</p>
                            </div>
                            <div class="flex-shrink-0 flex items-center gap-1 component-thumbs">
                                ${componentImages.slice(0, 4).map(imgUrl => `
                                    <img src="${imgUrl}" onerror="this.style.display='none'" alt="component thumbnail">
                                `).join('')}
                            </div>
                        </div>
                        `
                    }).join('')}
                </div>
                <div class="flex gap-2">
                    <button onclick="addBundle()" class="btn btn-primary w-full text-sm py-2">
                        <span class="lucide-icon mr-2" data-lucide="plus"></span> Añadir Bundle
                    </button>
                    <button onclick="deleteSelectedBundle()" class="btn btn-danger w-auto px-3 py-2" title="Eliminar Bundle Seleccionado">
                        <span class="lucide-icon" data-lucide="trash-2"></span>
                    </button>
                </div>
            </div>
            <div id="bundle-details" class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                <!-- Details of selected bundle will be rendered here -->
            </div>
        `;
        renderSelectedBundleDetails();
        lucide.createIcons();
    }

    function renderSelectedBundleDetails() {
        const detailsContainer = document.getElementById('bundle-details');
        const bundle = dataMap.bundleOptions[selectedBundleIndex];

        if (!bundle) {
            detailsContainer.innerHTML = '<p>No hay un bundle seleccionado.</p>';
            return;
        }
        
        const baseComponentOptions = `<optgroup label="Bases">
            ${dataMap.baseOptions.map(base => `<option value="${base.id}">${base.name} ($${(base.total || 0).toLocaleString('es-AR')})</option>`).join('')}
        </optgroup>`;

        const allComponentsOptions = CATEGORY_NAV_LIST
            .filter(cat => cat.key.includes('Options') && !['armadasOptions', 'baseOptions', 'bundleOptions'].includes(cat.key))
            .map(cat => {
                const components = dataMap[cat.key];
                if (!components || components.length === 0) return '';
                return `
                    <optgroup label="${cat.label}">
                        ${components.map(comp => `<option value="${comp.id}">${comp.name} ($${(comp.price || 0).toLocaleString('es-AR')})</option>`).join('')}
                    </optgroup>
                `;
            }).join('');

        detailsContainer.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Nombre del Bundle</label>
                    <input type="text" value="${bundle.name || ''}" oninput="updateBundle('name', this.value)" class="w-full">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">ID</label>
                    <div class="w-full p-2 bg-gray-900 rounded-md text-xs font-mono text-gray-400 truncate">${bundle.id}</div>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium mb-1">Descripción</label>
                    <textarea oninput="updateBundle('description', this.value)" class="w-full" rows="2">${bundle.description || ''}</textarea>
                </div>
                 <div class="md:col-span-1">
                    <label class="block text-sm font-medium mb-1">Total del Bundle</label>
                    <div class="w-full p-2 bg-gray-900 rounded-md text-lg font-bold text-teal-400">
                        $${(bundle.total || 0).toLocaleString('es-AR')}
                    </div>
                </div>
                <div class="md:col-span-1 flex items-center justify-center">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" ${bundle.visible ? 'checked' : ''} onchange="updateBundle('visible', this.checked ? 1 : 0)" class="w-5 h-5 rounded text-indigo-500 bg-gray-700 border-gray-600 focus:ring-indigo-600">
                        <span class="font-medium">Visible</span>
                    </label>
                </div>
            </div>
            
            <div class="mb-4">
                <h4 class="font-semibold mb-2">Añadir Componente</h4>
                <div class="flex gap-2">
                    <select id="add-component-select-bundle" class="w-full">
                        <option value="">Seleccionar componente...</option>
                        ${baseComponentOptions}
                        ${allComponentsOptions}
                    </select>
                    <button onclick="addComponentToBundle()" class="btn btn-secondary py-2">Añadir</button>
                </div>
            </div>

            <h4 class="font-semibold mb-2">Componentes en este Bundle</h4>
            <div class="overflow-x-auto">
                <table class="bundles-table w-full text-left text-sm text-gray-400">
                    <thead class="text-xs text-gray-200 uppercase bg-gray-700">
                        <tr>
                            <th scope="col" class="px-4 py-3">Categoría</th>
                            <th scope="col" class="px-6 py-3">Nombre</th>
                            <th scope="col" class="px-6 py-3">Precio</th>
                            <th scope="col" class="px-2 py-3">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${(bundle.components || []).map((compId, index) => {
                            const found = findComponentById(compId);
                            if (!found) {
                                return `<tr class="border-b border-gray-700"><td colspan="4" class="text-red-500 p-2">Componente con ID ${compId} no encontrado.</td></tr>`;
                            }
                            const { component, categoryKey } = found;
                            const price = categoryKey === 'baseOptions' ? component.total : component.price;
                            const linkHref = categoryKey === 'baseOptions' ? '#bases-section-container' : `#row-${categoryKey}-${dataMap[categoryKey].indexOf(component)}`;
                            const linkOnClick = categoryKey === 'baseOptions' ? `scrollToCategory('bases-section-container')` : `scrollToComponentRow('${categoryKey}', ${dataMap[categoryKey].indexOf(component)})`;

                            return `
                                <tr class="border-b border-gray-700 hover:bg-gray-700/50" 
                                    ondragover="onBundleComponentDragOver(event)"
                                    ondrop="onBundleComponentDrop(event, ${index})"
                                    onmouseenter="showImagePreview('${component.image_url || ''}')"
                                    onmouseleave="hideImagePreview()">
                                    <td class="px-4 py-2">${getComponentName(categoryKey)}</td>
                                    <td class="px-6 py-2 font-medium text-white">${component.name}</td>
                                    <td class="px-6 py-2">$${(price || 0).toLocaleString('es-AR')}</td>
                                    <td class="px-2 py-2 text-right">
                                        <div class="flex items-center justify-end">
                                            <a href="${linkHref}" onclick="${linkOnClick}" class="text-blue-400 hover:text-blue-300" title="Ir al componente">
                                                <span class="lucide-icon w-4 h-4" data-lucide="link"></span>
                                            </a>
                                            <button onclick="removeComponentFromBundle(${index})" class="text-red-500 hover:text-red-700 ml-2" title="Eliminar de la base">
                                                <span class="lucide-icon w-4 h-4" data-lucide="trash-2"></span>
                                            </button>
                                            <button draggable="true" ondragstart="onBundleComponentDragStart(event, ${index})" class="text-gray-400 hover:text-indigo-400 ml-2 cursor-move" title="Arrastrar para reordenar">
                                                <span class="lucide-icon w-4 h-4" data-lucide="move"></span>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                        ${(bundle.components || []).length === 0 ? '<tr><td colspan="4" class="text-center p-4">Este bundle está vacío.</td></tr>' : ''}
                    </tbody>
                </table>
            </div>
        `;
        lucide.createIcons();
    }
    
    // --- BUNDLES Data Operations ---
    function calculateBundleTotal(bundle) {
        if (!bundle || !bundle.components) return 0;
        return bundle.components.reduce((sum, compId) => {
            const found = findComponentById(compId);
            if (!found) return sum;
            const priceToAdd = found.component.total !== undefined ? found.component.total : found.component.price;
            return sum + (priceToAdd || 0);
        }, 0);
    }

    function updateAllBundleTotals() {
        dataMap.bundleOptions.forEach(bundle => {
            bundle.total = calculateBundleTotal(bundle);
        });
    }

    function selectBundle(index) {
        selectedBundleIndex = index;
        renderBundlesSection();
    }

    function addBundle() {
        dataMap.bundleOptions.push({
            id: generateUniqueId(getAllIds()),
            name: 'Nuevo Bundle',
            description: '',
            components: [],
            total: 0,
            visible: 1
        });
        selectedBundleIndex = dataMap.bundleOptions.length - 1;
        renderBundlesSection();
        saveDataToSessionStorage();
    }

    function deleteSelectedBundle() {
        if (dataMap.bundleOptions.length <= 1) {
            showToast('No se puede eliminar el último bundle.', 'error');
            return;
        }
        dataMap.bundleOptions.splice(selectedBundleIndex, 1);
        if (selectedBundleIndex >= dataMap.bundleOptions.length) {
            selectedBundleIndex = dataMap.bundleOptions.length - 1;
        }
        renderBundlesSection();
        saveDataToSessionStorage();
    }

    function updateBundle(key, value) {
        const bundle = dataMap.bundleOptions[selectedBundleIndex];
        if (bundle) {
            bundle[key] = value;
            saveDataToSessionStorage();
            
            if (key === 'name' || key === 'id') {
                const bundleItemDiv = document.getElementById(`bundle-item-${selectedBundleIndex}`);
                if (bundleItemDiv) {
                    if (key === 'name') {
                        bundleItemDiv.querySelector('p.font-bold').textContent = value || 'Sin Nombre';
                    }
                }
            }
        }
    }

    function addComponentToBundle() {
        const select = document.getElementById('add-component-select-bundle');
        const componentId = select.value;
        if (componentId && dataMap.bundleOptions[selectedBundleIndex]) {
            if (!dataMap.bundleOptions[selectedBundleIndex].components) {
                dataMap.bundleOptions[selectedBundleIndex].components = [];
            }
            dataMap.bundleOptions[selectedBundleIndex].components.push(componentId);
            updateAllBundleTotals();
            renderBundlesSection();
            saveDataToSessionStorage();
        }
    }

    function removeComponentFromBundle(componentIndex) {
        if (dataMap.bundleOptions[selectedBundleIndex] && dataMap.bundleOptions[selectedBundleIndex].components) {
            dataMap.bundleOptions[selectedBundleIndex].components.splice(componentIndex, 1);
            updateAllBundleTotals();
            renderBundlesSection();
            saveDataToSessionStorage();
        }
    }

    function onBundleComponentDragStart(event, index) {
        draggedBundleComponentIndex = index;
        event.dataTransfer.effectAllowed = 'move';
    }

    function onBundleComponentDragOver(event) {
        event.preventDefault();
        event.dataTransfer.dropEffect = 'move';
    }

    function onBundleComponentDrop(event, targetIndex) {
        event.preventDefault();
        if (draggedBundleComponentIndex !== null && draggedBundleComponentIndex !== targetIndex) {
            const bundle = dataMap.bundleOptions[selectedBundleIndex];
            if (bundle && bundle.components) {
                const moved = bundle.components.splice(draggedBundleComponentIndex, 1)[0];
                bundle.components.splice(targetIndex, 0, moved);
                renderSelectedBundleDetails();
                saveDataToSessionStorage();
            }
        }
        draggedBundleComponentIndex = null;
    }

    // --- NEW BASES SECTION ---
    function renderBasesSection() {
        const container = document.getElementById('bases-section');
        if (!dataMap.baseOptions) dataMap.baseOptions = [];
        if (dataMap.baseOptions.length === 0) {
            dataMap.baseOptions.push({ id: generateUniqueId(getAllIds()), name: 'Nueva Base', cpu: null, mother: null, ram: null, cantRam: 1, total: 0, visible: 1, description: '', totalram: 0 });
        }
        
        container.innerHTML = `
            <div class="flex flex-col gap-2">
                <div id="base-list" class="flex flex-col gap-2 mb-4">
                    ${dataMap.baseOptions.map((base, index) => `
                        <div id="base-item-${index}" class="list-item ${index === selectedBaseIndex ? 'active' : ''}" onclick="selectBase(${index})">
                            <div class="flex-grow">
                                <p class="font-bold truncate">${base.name || 'Sin Nombre'}</p>
                                <p class="text-xs opacity-75 truncate">${base.id || 'Sin ID'}</p>
                                <p class="font-bold text-lg text-teal-400 mt-1">$${(base.total || 0).toLocaleString('es-AR')}</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="flex gap-2">
                    <button onclick="addBase()" class="btn btn-primary w-full text-sm py-2">
                        <span class="lucide-icon mr-2" data-lucide="plus"></span> Añadir Base
                    </button>
                    <button onclick="deleteSelectedBase()" class="btn btn-danger w-auto px-3 py-2" title="Eliminar Base Seleccionada">
                        <span class="lucide-icon" data-lucide="trash-2"></span>
                    </button>
                </div>
            </div>
            <div id="base-details" class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                <!-- Details of selected base will be rendered here -->
            </div>
        `;
        renderSelectedBaseDetails();
        lucide.createIcons();
    }

    function renderSelectedBaseDetails() {
        const detailsContainer = document.getElementById('base-details');
        const base = dataMap.baseOptions[selectedBaseIndex];

        if (!base) {
            detailsContainer.innerHTML = '<p>No hay una base seleccionada.</p>';
            return;
        }
        
        const cpuIndex = dataMap.cpuOptions.findIndex(c => c.id == base.cpu);
        const motherIndex = dataMap.motherboardOptions.findIndex(m => m.id == base.mother);
        const ramIndex = dataMap.ramOptions.findIndex(r => r.id == base.ram);

        const cpuOptions = dataMap.cpuOptions.map(c => `<option value="${c.id}" ${base.cpu == c.id ? 'selected' : ''}>${c.name} ($${(c.price||0).toLocaleString('es-AR')})</option>`).join('');
        const motherOptions = dataMap.motherboardOptions.map(m => `<option value="${m.id}" ${base.mother == m.id ? 'selected' : ''}>${m.name} ($${(m.price||0).toLocaleString('es-AR')})</option>`).join('');
        const ramOptions = dataMap.ramOptions.map(r => `<option value="${r.id}" ${base.ram == r.id ? 'selected' : ''}>${r.name} ($${(r.price||0).toLocaleString('es-AR')})</option>`).join('');

        detailsContainer.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                 <div>
                    <label class="block text-sm font-medium mb-1">Nombre de la Base</label>
                    <input type="text" value="${base.name || ''}" oninput="updateBase('name', this.value)" class="w-full">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">ID</label>
                    <div class="w-full p-2 bg-gray-900 rounded-md text-xs font-mono text-gray-400 truncate">${base.id}</div>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium mb-1">Descripción</label>
                    <textarea oninput="updateBase('description', this.value)" class="w-full" rows="2">${base.description || ''}</textarea>
                </div>
            </div>
            <div class="space-y-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-1">CPU</label>
                    <div class="flex items-center gap-2">
                        <select onchange="updateBase('cpu', this.value)" class="flex-grow">
                            <option value="">Seleccionar CPU...</option>
                            ${cpuOptions}
                        </select>
                        <a href="#row-cpuOptions-${cpuIndex}" onclick="scrollToComponentRow('cpuOptions', ${cpuIndex})" class="${cpuIndex > -1 ? 'inline-flex' : 'hidden'} text-blue-400 hover:text-blue-300" title="Ir al componente">
                             <span class="lucide-icon" data-lucide="link"></span>
                        </a>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Motherboard</label>
                     <div class="flex items-center gap-2">
                        <select onchange="updateBase('mother', this.value)" class="flex-grow">
                            <option value="">Seleccionar Motherboard...</option>
                            ${motherOptions}
                        </select>
                        <a href="#row-motherboardOptions-${motherIndex}" onclick="scrollToComponentRow('motherboardOptions', ${motherIndex})" class="${motherIndex > -1 ? 'inline-flex' : 'hidden'} text-blue-400 hover:text-blue-300" title="Ir al componente">
                             <span class="lucide-icon" data-lucide="link"></span>
                        </a>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div class="col-span-2">
                        <label class="block text-sm font-medium mb-1">RAM</label>
                        <div class="flex items-center gap-2">
                            <select onchange="updateBase('ram', this.value)" class="flex-grow">
                                <option value="">Seleccionar RAM...</option>
                                ${ramOptions}
                            </select>
                             <a href="#row-ramOptions-${ramIndex}" onclick="scrollToComponentRow('ramOptions', ${ramIndex})" class="${ramIndex > -1 ? 'inline-flex' : 'hidden'} text-blue-400 hover:text-blue-300" title="Ir al componente">
                                <span class="lucide-icon" data-lucide="link"></span>
                            </a>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Cantidad</label>
                        <div class="flex items-center justify-between gap-1">
                            ${[1, 2, 3, 4].map(n => `<button class="btn ram-qty-btn w-full text-xs py-2 px-0 ${base.cantRam == n ? 'active' : ''}" onclick="updateBase('cantRam', ${n})">${n}</button>`).join('')}
                        </div>
                    </div>
                </div>
            </div>
             <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                 <div class="md:col-span-1">
                    <label class="block text-sm font-medium mb-1">Total de la Base</label>
                    <div class="w-full p-2 bg-gray-900 rounded-md text-lg font-bold text-teal-400">
                        $${(base.total || 0).toLocaleString('es-AR')}
                    </div>
                </div>
                 <div class="md:col-span-1">
                    <label class="block text-sm font-medium mb-1">Total RAM (GB)</label>
                    <div class="w-full p-2 bg-gray-900 rounded-md text-lg font-bold text-teal-400">
                        ${base.totalram || 0} GB
                    </div>
                </div>
                <div class="md:col-span-2 flex items-center justify-center pt-2">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" ${base.visible ? 'checked' : ''} onchange="updateBase('visible', this.checked ? 1 : 0)" class="w-5 h-5 rounded text-indigo-500 bg-gray-700 border-gray-600 focus:ring-indigo-600">
                        <span class="font-medium">Visible</span>
                    </label>
                </div>
            </div>
        `;
        lucide.createIcons();
    }

    function calculateBaseTotal(base) {
        if (!base) return 0;
        const cpu = dataMap.cpuOptions.find(c => c.id == base.cpu);
        const mother = dataMap.motherboardOptions.find(m => m.id == base.mother);
        const ram = dataMap.ramOptions.find(r => r.id == base.ram);
        const cantRam = base.cantRam || 1;

        const cpuPrice = cpu ? cpu.price || 0 : 0;
        const motherPrice = mother ? mother.price || 0 : 0;
        const ramPrice = ram ? ram.price || 0 : 0;
        
        return cpuPrice + motherPrice + (ramPrice * cantRam);
    }

    function calculateBaseRamTotal(base) {
        if (!base || !base.ram) return 0;
        const ram = dataMap.ramOptions.find(r => r.id == base.ram);
        const cantRam = base.cantRam || 1;
        const ramTotal = ram ? ram.total || 0 : 0;
        return ramTotal * cantRam;
    }

    function updateAllBaseTotals() {
        dataMap.baseOptions.forEach(base => {
            base.total = calculateBaseTotal(base);
            base.totalram = calculateBaseRamTotal(base);
        });
    }

    function selectBase(index) {
        selectedBaseIndex = index;
        renderBasesSection();
    }

    function addBase() {
        dataMap.baseOptions.push({
            id: generateUniqueId(getAllIds()),
            name: 'Nueva Base',
            cpu: null, mother: null, ram: null, cantRam: 1,
            total: 0,
            visible: 1,
            description: '',
            totalram: 0
        });
        selectedBaseIndex = dataMap.baseOptions.length - 1;
        renderBasesSection();
        saveDataToSessionStorage();
    }

    function deleteSelectedBase() {
        if (dataMap.baseOptions.length <= 1) {
            showToast('No se puede eliminar la última base.', 'error');
            return;
        }
        dataMap.baseOptions.splice(selectedBaseIndex, 1);
        if (selectedBaseIndex >= dataMap.baseOptions.length) {
            selectedBaseIndex = dataMap.baseOptions.length - 1;
        }
        renderBasesSection();
        saveDataToSessionStorage();
    }

    function updateBase(key, value) {
        const base = dataMap.baseOptions[selectedBaseIndex];
        if (base) {
            base[key] = value;

            if (key === 'cpu') {
                const cpu = dataMap.cpuOptions.find(c => c.id == value);
                if (cpu) {
                    base.name = cpu.name;
                }
            }

            base.total = calculateBaseTotal(base);
            base.totalram = calculateBaseRamTotal(base);
            saveDataToSessionStorage();
            
            updateAllBundleTotals();

            if (['cpu', 'mother', 'ram', 'cantRam'].includes(key)) {
                renderBasesSection();
                renderBundlesSection();
            } else if (key === 'name') {
                 const baseItemDiv = document.getElementById(`base-item-${selectedBaseIndex}`);
                if (baseItemDiv) {
                    baseItemDiv.querySelector('p.font-bold').textContent = value || 'Sin Nombre';
                }
            }
        }
    }

    function scrollToComponentRow(categoryKey, index) {
        const rowId = `row-${categoryKey}-${index}`;
        const row = document.getElementById(rowId);
        if (row) {
            const navbarHeight = document.getElementById('category-navbar').offsetHeight;
            const elementPosition = row.getBoundingClientRect().top;
            const offsetPosition = elementPosition + window.pageYOffset - navbarHeight - 20;

            window.scrollTo({ top: offsetPosition, behavior: 'smooth' });
            
            row.style.transition = 'background-color 0.5s ease-in-out';
            row.style.backgroundColor = 'rgba(99, 102, 241, 0.5)';
            setTimeout(() => {
                row.style.backgroundColor = '';
            }, 2000);
        }
    }


    function renderOverviewTables() {
        const overviewContainer = document.getElementById('overview-view');
        overviewContainer.innerHTML = '';

        CATEGORY_NAV_LIST.forEach(category => {
            const categoryKey = category.key;
            if (!categoryKey.includes('Options')) return;

            const categoryData = dataMap[categoryKey];
            const readableCategoryName = category.label;
            
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'mb-8 p-6 bg-gray-900 rounded-lg shadow-sm border border-gray-700 category-table-container';
            categoryDiv.id = `table-container-${categoryKey}`;
            categoryDiv.innerHTML = `<h3 class="text-xl font-semibold text-gray-100 mb-4">${readableCategoryName}</h3>`;

            const table = document.createElement('table');
            table.className = 'overview-table w-full text-left text-sm text-gray-400';
            
            let headers = `
                <th scope="col" class="px-2 py-3" style="width: 1%;">ID</th>
                <th scope="col" class="px-2 py-3" style="width: 220px;">Nombre</th>
                <th scope="col" class="px-2 py-3" style="width: 120px; text-align: left;">Precio</th>
                ${categoryKey !== 'towersOptions' && categoryKey !== 'ramOptions' ? '<th scope="col" class="px-2 py-3">Descripción</th>' : ''}
                ${categoryKey === 'ramOptions' ? '<th scope="col" class="px-2 py-3">Descripción</th><th scope="col" class="px-2 py-3">Total (GB)</th>' : ''}
                <th scope="col" class="px-2 py-3" style="width: 200px;">URL Imagen</th>
                <th scope="col" class="px-2 py-3" style="width: 1%;">Visible</th>
                <th scope="col" class="px-1 py-3" style="width:1%;min-width:150px;">Acciones</th>
            `;
            let colspan = 6;
            if (categoryKey !== 'towersOptions') colspan++;
            if (categoryKey === 'ramOptions') colspan++;


            if (categoryKey === 'miniPcOptions') {
                headers = `
                    <th scope="col" class="px-2 py-3" style="width: 1%;">ID</th>
                    <th scope="col" class="px-2 py-3" style="width: 220px;">Nombre</th>
                    <th scope="col" class="px-2 py-3" style="width: 120px; text-align: left;">Precio</th>
                    <th scope="col" class="px-2 py-3">CPU</th>
                    <th scope="col" class="px-2 py-3">RAM</th>
                    <th scope="col" class="px-2 py-3">SSD</th>
                    <th scope="col" class="px-2 py-3" style="width: 200px;">URL Imagen</th>
                    <th scope="col" class="px-2 py-3" style="width: 1%;">Visible</th>
                    <th scope="col" class="px-1 py-3" style="width:1%;min-width:150px;">Acciones</th>
                `;
                colspan = 9;
            }


            table.innerHTML = `
                <thead class="text-xs text-gray-200 uppercase bg-gray-700">
                    <tr>${headers}</tr>
                </thead>
                <tbody>
                    ${(categoryData || []).map((product, index) => {
                        let customColumns;
                        if (categoryKey === 'miniPcOptions') {
                            customColumns = `
                                <td class="px-2 py-2"><input type="text" value="${product.cpu || ''}" oninput="updateProduct('${categoryKey}', ${index}, 'cpu', this.value)" class="w-full"></td>
                                <td class="px-2 py-2"><input type="text" value="${product.ram || ''}" oninput="updateProduct('${categoryKey}', ${index}, 'ram', this.value)" class="w-full"></td>
                                <td class="px-2 py-2"><input type="text" value="${product.ssd || ''}" oninput="updateProduct('${categoryKey}', ${index}, 'ssd', this.value)" class="w-full"></td>
                            `;
                        } else if (categoryKey === 'ramOptions') {
                             customColumns = `
                                <td class="px-2 py-2">
                                    <textarea rows="2" style="min-height:2.5em;max-height:4.5em;" oninput="updateProduct('${categoryKey}', ${index}, 'description', this.value)" class="w-full resize-none">${product.description || ''}</textarea>
                                </td>
                                <td class="px-2 py-2">
                                    <input type="number" value="${product.total || 0}" oninput="updateProduct('${categoryKey}', ${index}, 'total', parseInt(this.value, 10) || 0)" class="w-full">
                                </td>
                            `;
                        } else if (categoryKey !== 'towersOptions') {
                            customColumns = `
                            <td class="px-2 py-2">
                                <textarea rows="2" style="min-height:2.5em;max-height:4.5em;" oninput="updateProduct('${categoryKey}', ${index}, 'description', this.value)" class="w-full resize-none">${product.description || ''}</textarea>
                            </td>`;
                        } else {
                            customColumns = '';
                        }

                        return `
                        <tr id="row-${categoryKey}-${index}" class="border-b border-gray-700 hover:bg-gray-700/50 transition-colors duration-200 ${product.price_status ? 'price-' + product.price_status : ''}" 
                            ondragover="onRowDragOver(event)" 
                            ondrop="onRowDrop(event, '${categoryKey}', ${index})"
                            onmouseenter="showImagePreview('${product.image_url || ''}')"
                            onmouseleave="hideImagePreview()">
                            <td class="px-2 py-2 text-center text-xs text-gray-400 font-mono cursor-pointer hover:text-white" onclick="copyToClipboard('${product.id || ''}')" title="Copiar ID">${product.id || ''}</td>
                            <td class="px-2 py-2 font-medium text-white whitespace-nowrap">
                                <input type="text" value="${product.name || ''}" oninput="updateProduct('${categoryKey}', ${index}, 'name', this.value)" class="w-full">
                            </td>
                            <td class="px-2 py-2 price-cell">
                                <div class="price-wrapper">
                                    <div class="flex items-center gap-1">
                                        <span class="text-gray-400 font-semibold text-lg">$</span>
                                        <input type="text" value="${product.price ? product.price.toLocaleString('es-AR') : ''}" oninput="formatAndUpdatePrice(this, '${categoryKey}', ${index})" class="text-left" style="width: 100px;">
                                    </div>
                                    <div class="indicators-container"></div>
                                </div>
                            </td>
                            ${customColumns}
                            <td class="px-2 py-2">
                                <input type="text" value="${product.image_url || ''}" oninput="updateProduct('${categoryKey}', ${index}, 'image_url', this.value)" onclick="autofillImagePath(this, '${categoryKey}', ${index})" class="w-full text-xs">
                            </td>
                            <td class="px-2 py-2 text-center">
                                <input type="checkbox" ${product.visible ? 'checked' : ''} onchange="updateProduct('${categoryKey}', ${index}, 'visible', this.checked ? 1 : 0)" class="w-5 h-5 rounded text-indigo-500 bg-gray-700 border-gray-600 focus:ring-indigo-600">
                            </td>
                            <td class="px-1 py-2 text-right">
                                <div class="flex flex-col items-end gap-1">
                                    <div class="flex items-center">
                                        <button id="scrape-btn-${categoryKey}-${index}" onclick="checkSingleProduct('${categoryKey}', ${index})" class="text-teal-400 hover:text-teal-200" title="Chequear este producto">
                                            <span class="lucide-icon w-4 h-4" data-lucide="scan-line"></span>
                                        </button>
                                        <button onclick="removeProduct('${categoryKey}', ${index})" class="text-red-500 hover:text-red-700 ml-2" title="Eliminar">
                                            <span class="lucide-icon w-4 h-4" data-lucide="trash-2"></span>
                                        </button>
                                        <button draggable="true" ondragstart="onRowDragStart(event, '${categoryKey}', ${index})" class="text-gray-400 hover:text-indigo-400 ml-2 cursor-move" title="Arrastrar para reordenar">
                                            <span class="lucide-icon w-4 h-4" data-lucide="move"></span>
                                        </button>
                                    </div>
                                    <div class="flex items-center gap-1">
                                        <a href="${product.link || '#'}" target="_blank" class="btn btn-secondary min-w-0 flex items-center justify-center text-xs py-1 px-1">
                                            <span class="lucide-icon mr-1" data-lucide="external-link" style="margin-right:2px;"></span>Visitar
                                        </a>
                                        <button onclick="replaceLink('${categoryKey}', ${index})" class="btn btn-primary text-xs py-1 px-1 ml-1" title="Reemplazar Link desde portapapeles">
                                            <span class="lucide-icon" data-lucide="edit"></span>
                                        </button>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    `}).join('')}
                    <tr>
                        <td colspan="${colspan}" class="add-row-button-cell">
                            <div class="flex justify-center items-center gap-4">
                                <button onclick="addProduct('${categoryKey}')" class="add-row-button">
                                    <span class="lucide-icon mr-2" data-lucide="plus"></span> Añadir ${getComponentName(categoryKey)}
                                </button>
                                <button id="add-from-clipboard-${categoryKey}" onclick="addProductFromClipboard('${categoryKey}')" class="add-row-button bg-sky-600 hover:bg-sky-700">
                                    <span class="lucide-icon mr-2" data-lucide="clipboard-plus"></span> Añadir desde Link
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            `;
            categoryDiv.appendChild(table);
            overviewContainer.appendChild(categoryDiv);
        });
        lucide.createIcons();
    }

    // --- Drag and Drop for Table Rows ---
    let dragSrcIndex = null;
    let dragSrcCategory = null;

    function onRowDragStart(event, categoryKey, index) {
        dragSrcIndex = index;
        dragSrcCategory = categoryKey;
        event.dataTransfer.effectAllowed = 'move';
    }
    function onRowDragOver(event) {
        event.preventDefault();
        event.dataTransfer.dropEffect = 'move';
    }
    function onRowDrop(event, categoryKey, index) {
        event.preventDefault();
        if (dragSrcCategory === categoryKey && dragSrcIndex !== null && dragSrcIndex !== index) {
            const arr = dataMap[categoryKey];
            const moved = arr.splice(dragSrcIndex, 1)[0];
            arr.splice(index, 0, moved);
            renderOverviewTables();
            saveDataToSessionStorage();
        }
        dragSrcIndex = null;
        dragSrcCategory = null;
    }

    // --- Price Checking & Scraping ---
    
async function fetchWithProxyFallback(url) {
    const proxySelect = document.getElementById('cors-proxy-select');
    const selectedProxyId = proxySelect.value;
    const selectedProxy = CORS_PROXIES.find(p => p.id === selectedProxyId);
    
    if (!selectedProxy) throw new Error("Por favor, selecciona un Proxy CORS.");

    const proxyUrl = `${selectedProxy.url}${encodeURIComponent(url)}`;
    const response = await fetch(proxyUrl);

    if (!response.ok) throw new Error(`Proxy ${selectedProxy.id} falló con estado: ${response.status}`);
    return response;
}


    async function scrapeProductData(product, row) {
        const localPrice = product.price;
        row.className = 'border-b border-gray-700 transition-colors duration-200 price-scraping';
        product.price_status = 'scraping'; // Intermediate status
        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
        showImagePreview(product.image_url);
        
        const indicatorsContainer = row.querySelector('.indicators-container');
        indicatorsContainer.innerHTML = '';

        try {
            const response = await fetchWithProxyFallback(product.link);
            const html = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            const buyButton = Array.from(doc.querySelectorAll('.andes-button__content')).find(el => el.textContent.trim() === 'Comprar ahora');
            if (!buyButton) {
                throw new Error('Producto no disponible');
            }
            
            const priceElementContainer = doc.querySelector('.ui-pdp-price__second-line');
            if (!priceElementContainer) throw new Error('Price container not found.');
            
            const priceElement = priceElementContainer.querySelector('.andes-money-amount__fraction');
            if (!priceElement) throw new Error('Price fraction element not found.');

            const priceText = priceElement.textContent;
            const onlinePrice = parseInt(priceText.replace(/\./g, ''), 10);

            if (isNaN(onlinePrice)) throw new Error('Could not parse price.');

            updateProduct(row.id.split('-')[1], parseInt(row.id.split('-')[2]), 'price', onlinePrice);
            const priceInput = row.querySelector('input[oninput*="formatAndUpdatePrice"]');
            if (priceInput) {
                priceInput.value = onlinePrice.toLocaleString('es-AR');
            }
            
            const diff = onlinePrice - localPrice;
            if (diff !== 0) {
                const diffSpan = document.createElement('span');
                diffSpan.className = 'indicator-badge';
                if (diff > 0) {
                    diffSpan.classList.add('positive');
                    diffSpan.textContent = `+${diff.toLocaleString('es-AR')}`;
                } else {
                    diffSpan.classList.add('negative');
                    diffSpan.textContent = `${diff.toLocaleString('es-AR')}`;
                }
                indicatorsContainer.appendChild(diffSpan);
            }

            const checkQuantity = document.getElementById('check-quantity-toggle').checked;
            if (checkQuantity) {
                const quantitySelectors = ['.ui-pdp-buybox__quantity__available', '.ui-pdp-stock-information__available-quantity-message'];
                let quantityText = '';
                for (const selector of quantitySelectors) {
                    const quantityElement = doc.querySelector(selector);
                    if (quantityElement) {
                        quantityText = quantityElement.textContent.trim();
                        break;
                    }
                }

                if (quantityText) {
                    const quantitySpan = document.createElement('span');
                    quantitySpan.className = 'indicator-badge quantity';
                    quantitySpan.textContent = quantityText.replace(/[()]/g, '');

                    const isLastAvailable = quantityText.toLowerCase().includes('¡últim');
                    if (isLastAvailable) {
                         quantitySpan.style.backgroundColor = `hsl(0, 85%, 55%)`; // Red
                    } else if (!quantityText.includes('+') && !quantityText.toLowerCase().includes('más de')) {
                         const availableQuantityMatch = quantityText.match(/(\d+)/);
                         if(availableQuantityMatch && availableQuantityMatch[1]){
                            const availableQuantity = parseInt(availableQuantityMatch[1], 10);
                            if (availableQuantity < 10) {
                                const normalized = (availableQuantity - 1) / 8; // 0 for 1, 1 for 9
                                const hue = 30 - (normalized * 30); // 30 for orange, 0 for red
                                quantitySpan.style.backgroundColor = `hsl(${hue}, 85%, 55%)`;
                            }
                         }
                    }
                    indicatorsContainer.appendChild(quantitySpan);
                }
            }
            
            row.classList.remove('price-scraping');
            if (onlinePrice < localPrice) {
                row.classList.add('price-lower');
                product.price_status = 'lower';
            } else if (onlinePrice > localPrice) {
                row.classList.add('price-higher');
                product.price_status = 'higher';
            } else {
                row.classList.add('price-same');
                product.price_status = 'same';
            }

        } catch (error) {
            console.error(`Error checking price for ${product.name}:`, error);
            showToast(`Error en ${product.name}: ${error.message}`, 'error');
            row.classList.remove('price-scraping');
            row.classList.add('price-error');
            product.price_status = 'error';

            if (error.message === 'Producto no disponible') {
                const statusSpan = document.createElement('span');
                statusSpan.className = 'indicator-badge status';
                statusSpan.textContent = 'No disponible';
                indicatorsContainer.appendChild(statusSpan);
            }
        }
    }

    async function checkSingleProduct(categoryKey, index) {
        const product = dataMap[categoryKey][index];
        const row = document.getElementById(`row-${categoryKey}-${index}`);
        const scrapeBtn = document.getElementById(`scrape-btn-${categoryKey}-${index}`);
        const originalIcon = scrapeBtn.innerHTML;
        
        scrapeBtn.innerHTML = `<svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
        scrapeBtn.disabled = true;

        await scrapeProductData(product, row);
        hideImagePreview();

        scrapeBtn.disabled = false;
        scrapeBtn.innerHTML = originalIcon;
    }

    async function checkAllPrices() {
        const btn = document.getElementById('check-prices-btn');
        const btnText = document.getElementById('check-prices-text');
        const btnIcon = document.getElementById('check-prices-icon');
        
        btn.disabled = true;
        btnText.textContent = 'Chequeando...';
        btnIcon.innerHTML = `<svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;

        // Iterate using the defined order in CATEGORY_NAV_LIST
        for (const category of CATEGORY_NAV_LIST) {
            const categoryKey = category.key;
            // Skip non-component categories
            if (!categoryKey.includes('Options') || categoryKey === 'baseOptions') {
                continue;
            }

            if (dataMap[categoryKey]) {
                for (let i = 0; i < dataMap[categoryKey].length; i++) {
                    const product = dataMap[categoryKey][i];
                    const row = document.getElementById(`row-${categoryKey}-${i}`);
                    if (row && product.link) { // Check if row and link exist
                       await scrapeProductData(product, row);
                       await new Promise(resolve => setTimeout(resolve, 300));
                    }
                }
            }
        }

        hideImagePreview();
        btn.disabled = false;
        btnText.textContent = 'Chequear Precios';
        btnIcon.innerHTML = '';
        lucide.createIcons({
            nodes: [btnIcon],
            attrs: { 'data-lucide': 'scan-line' }
        });
    }

    async function addProductFromClipboard(categoryKey) {
        const btn = document.getElementById(`add-from-clipboard-${categoryKey}`);
        const originalContent = btn.innerHTML;
        btn.innerHTML = `<svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
        btn.disabled = true;

        try {
            let link = await navigator.clipboard.readText();
            if (!link || !link.includes('mercadolibre.com')) {
                throw new Error('El portapapeles no contiene un link válido de Mercado Libre.');
            }
            link = modifyMercadoLibreLink(link.trim());

            const response = await fetchWithProxyFallback(link);
            const html = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');

            const nameElement = doc.querySelector('.ui-pdp-title');
            const name = nameElement ? nameElement.textContent.trim() : 'Nombre no encontrado';
            
            let price = 0;
            try {
                const priceElementContainer = doc.querySelector('.ui-pdp-price__second-line');
                if (!priceElementContainer) throw new Error('Price container not found.');
                const priceElement = priceElementContainer.querySelector('.andes-money-amount__fraction');
                if (!priceElement) throw new Error('Price fraction element not found.');
                const priceText = priceElement.textContent;
                price = parseInt(priceText.replace(/\./g, ''), 10) || 0;
            } catch (priceError) {
                console.warn("Could not scrape price, defaulting to 0:", priceError.message);
                showToast(`No se pudo obtener el precio para ${name}. Se agregó con precio 0.`, 'error');
            }
            
            const newId = generateUniqueId(getAllIds());
            const categoryInfo = CATEGORY_NAV_LIST.find(cat => cat.key === categoryKey);
            let imageUrl = '';
            if (categoryInfo && categoryInfo.folder) {
                imageUrl = `comps/${categoryInfo.folder}/${newId}.webp`;
            }

            const newProduct = {
                id: newId,
                name: name,
                price: price,
                link: link,
                visible: 1
            };

            if (categoryKey === 'miniPcOptions') {
                newProduct.cpu = '';
                newProduct.ram = '';
                newProduct.ssd = '';
            } else {
                newProduct.description = '';
            }

            addProduct(categoryKey, newProduct);
            showToast('Producto añadido desde el link.');

        } catch (error) {
            console.error('Error al añadir desde clipboard:', error);
            showToast(error.message, 'error');
        } finally {
            btn.innerHTML = originalContent;
            btn.disabled = false;
        }
    }

    // --- Code Export ---

    function generateCode() {
        updateAllBaseTotals(); 
        updateAllBundleTotals();
        function getSlugFromImageUrl(imageUrl) {
            if (!imageUrl) return '';
            const parts = imageUrl.split('/');
            const filename = parts[parts.length - 1] || '';
            return filename.replace(/\.(webp|png|jpg|jpeg|gif)$/i, '');
        }

        const exportData = {};
        for (const mapKey in dataMap) {
             if (mapKey === 'baseOptions') {
                exportData[mapKey] = dataMap[mapKey].map(b => ({
                    id: b.id,
                    name: b.name,
                    description: b.description,
                    cpu: b.cpu,
                    mother: b.mother,
                    ram: b.ram,
                    cantRam: b.cantRam,
                    total: b.total || 0,
                    totalram: b.totalram || 0,
                    visible: b.visible !== undefined ? b.visible : 1
                }));
                continue;
             }
             if (mapKey === 'bundleOptions') {
                exportData[mapKey] = dataMap[mapKey].map(b => ({
                    id: b.id,
                    name: b.name,
                    description: b.description,
                    components: b.components || [],
                    total: b.total || 0,
                    visible: b.visible !== undefined ? b.visible : 1
                }));
                continue;
             }
             exportData[mapKey] = dataMap[mapKey].map(p => {
                const { id, name, price, description, image_url, link, visible, cpu, ram, ssd, total } = p;
                let orderedProduct = { id, name, price };

                if (mapKey === 'miniPcOptions') {
                    orderedProduct = { ...orderedProduct, cpu, ram, ssd };
                } else if (mapKey === 'towersOptions') {
                    orderedProduct.slug = getSlugFromImageUrl(image_url);
                } else if (mapKey === 'ramOptions') {
                    orderedProduct.total = total || 0;
                    orderedProduct.description = description;
                } else {
                    if (description !== undefined) {
                        orderedProduct.description = description;
                    }
                }

                orderedProduct.image_url = image_url;
                orderedProduct.link = link;
                orderedProduct.visible = visible !== undefined ? visible : 1;
                
                return orderedProduct;
            });
        }
        
        const code = JSON.stringify(exportData, null, 2);
        document.getElementById('output-code').value = code;
        return code;
    }

    function copyCode() {
        const outputTextArea = document.getElementById('output-code');
        generateCode();
        outputTextArea.select();
        document.execCommand('copy');
        showToast('¡Código copiado al portapapeles!');
    }

    function resetSessionAndReload() {
        sessionStorage.removeItem('productAdminData');
        location.reload();
    }

    async function reloadDataFromJson() {
        try {
            const response = await fetch('products.json?cache_bust=' + new Date().getTime());
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const dataToLoad = await response.json();
            
            for (const key in dataMap) {
                if (dataToLoad.hasOwnProperty(key)) {
                    dataToLoad[key] = dataToLoad[key];
                } else {
                    dataMap[key] = [];
                }
            }
            
            sanitizeAndAssignDefaults();
            updateAllBaseTotals();
            updateAllBundleTotals();
            renderBasesSection();
            renderBundlesSection();
            renderOverviewTables();
            saveDataToSessionStorage();
            showToast('Datos recargados desde products.json');

        } catch (error) {
            console.error("Error reloading from JSON:", error);
            showToast('Error al recargar el archivo products.json.', 'error');
        }
    }
    
    function renderScrapingTools() {
        const apiSelect = document.getElementById('scraping-api-select');
        const proxySelect = document.getElementById('cors-proxy-select');

        apiSelect.innerHTML = SCRAPING_APIS.map(api => `<option value="${api.id}">${api.name}</option>`).join('');
        proxySelect.innerHTML = CORS_PROXIES.map(proxy => `<option value="${proxy.id}">${proxy.id}</option>`).join('');

        const lastProxy = sessionStorage.getItem('lastSuccessfulProxy');
        const lastProxyId = CORS_PROXIES.find(p => p.url === lastProxy)?.id;
        if (lastProxyId) {
            proxySelect.value = lastProxyId;
        }
    }

    // --- Page Initialization ---
    document.addEventListener('DOMContentLoaded', async () => {
        let dataToLoad = null;
        const storedData = loadDataFromSessionStorage();

        if (storedData) {
            dataToLoad = storedData;
            showToast('¡Datos restaurados de la sesión anterior!', 'success');
        } else {
            try {
                const response = await fetch('products.json?cache_bust=' + new Date().getTime());
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                dataToLoad = await response.json();
            } catch (error) {
                console.error('Error loading products.json:', error);
                showToast('No se pudo cargar products.json. Se iniciará con datos vacíos.', 'error');
            }
        }

        if (dataToLoad) {
            for (const key in dataMap) {
                if (dataToLoad.hasOwnProperty(key)) {
                    dataMap[key] = dataToLoad[key];
                }
            }
        }
        
        sanitizeAndAssignDefaults();
        updateAllBaseTotals();
        updateAllBundleTotals();
        renderCategoryNavbar();
        renderBasesSection();
        renderBundlesSection();
        renderOverviewTables();
        renderScrapingTools();
        saveDataToSessionStorage();
        lucide.createIcons();
        
        window.addEventListener('resize', updateNavbarSpacer);

        // Accordion Logic
        document.querySelectorAll('.accordion-header').forEach(header => {
            header.addEventListener('click', () => {
                const content = header.nextElementSibling;
                const icon = header.querySelector('.lucide-icon');
                content.classList.toggle('hidden');
                icon.classList.toggle('rotate-180');
            });
        });
    });

</script>
</body>
</html>
