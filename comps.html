<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrador de Vectores de Productos</title>
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ctext y='26' font-size='28' x='3' font-family='Arial'%3E%24%3C/text%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,wght@0,400;0,700;1,400&family=Saira:wght@400;900;1,400&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- NEW: Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* General Styles */
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
            color: #e5e7eb; /* text-gray-200 */
        }
        .font-saira-black { font-family: 'Saira', sans-serif; font-weight: 900; }

        /* Input and Textarea Styles */
        .overview-table input,
        .overview-table textarea {
            background: rgba(31,41,55,0.5)!important; /* bg-gray-800/50 */
            font-family: 'Saira', sans-serif;
            font-weight: 600;
            box-shadow: 0 2px 8px 0 rgba(0,0,0,0.10);
            color: #e5e7eb;
            border-radius: 0.375rem;
            border: 1px solid #374151;
            transition: border-color 0.15s, box-shadow 0.15s;
        }
        .overview-table input:focus,
        .overview-table textarea:focus {
            border-color: #6366f1; /* indigo-500 */
            box-shadow: 0 0 0 2px #6366f1;
        }

        /* Shared input style for tables and base details */
        .overview-table input[type="text"],
        .overview-table input[type="number"],
        .overview-table textarea,
        #base-details input, #base-details textarea, #base-details select,
        #bundle-details input, #bundle-details textarea, #bundle-details select {
            background-color: #1f2937; /* bg-gray-800 */
            border: 1px solid #374151; /* border-gray-700 */
            border-radius: 0.375rem;
            padding: 0.5rem;
            font-size: 0.875rem;
            color: #e5e7eb;
            transition: all 0.15s ease-in-out;
            width: 100%;
        }
        .overview-table input[type="text"]:focus,
        .overview-table input[type="number"]:focus,
        .overview-table textarea:focus,
        #base-details input:focus, #base-details textarea:focus, #base-details select:focus,
        #bundle-details input:focus, #bundle-details textarea:focus, #bundle-details select:focus {
            border-color: #6366f1; /* indigo-500 */
            box-shadow: 0 0 0 2px #4f46e5;
        }
        .overview-table textarea { min-height: 40px; }


        /* Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out, opacity 0.2s;
            cursor: pointer;
        }
        .btn-primary { background-color: #6366f1; color: #ffffff; }
        .btn-primary:hover { background-color: #4f46e5; }
        .btn-secondary { background-color: #4b5563; color: #ffffff; padding: 0.5rem 1rem; }
        .btn-secondary:hover { background-color: #374151; }
        .btn-danger { background-color: #ef4444; color: #ffffff; }
        .btn-danger:hover { background-color: #dc2626; }
        .btn-success { background-color: #22c55e; color: #ffffff; } 
        .btn-success:hover { background-color: #16a34a; } 
        .btn-info { background-color: #3b82f6; color: #ffffff; }
        .btn-info:hover { background-color: #2563eb; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Icon and Title Styles */
        .lucide-icon {
            display: inline-block;
            vertical-align: middle;
            width: 1em;
            height: 1em;
            stroke-width: 2;
            stroke: currentColor;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .section-title-admin {
            border-bottom: 3px solid;
            border-image: linear-gradient(to right, #6366f1, #a855f7) 1;
            padding-bottom: 0.5rem;
            display: inline-block;
        }
        
        /* Output and Message Styles */
        #output-code {
            background-color: #1f2937; /* bg-gray-800 */
            border-color: #374151; /* border-gray-700 */
            color: #42d232; /* green-400 */
        }

        /* Table Styles */
        .overview-table th, .overview-table td,
        .bundles-table th, .bundles-table td {
            padding: 0.5rem;
            vertical-align: middle;
        }
        
        .add-row-button-cell {
            text-align: center;
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        .add-row-button {
            background-color: #6366f1;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .add-row-button:hover { background-color: #4f46e5; }

        /* Image Preview Styles */
        #image-preview {
            max-width: 250px;
            max-height: 250px;
            transition: opacity 0.2s ease-in-out;
        }
        #image-preview img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* Category Navigation Bar Styles */
        .category-navbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            z-index: 50;
            background: linear-gradient(to right, #1f2937 80%, #6366f1 100%);
            border-bottom: 2px solid #6366f1;
            box-shadow: 0 2px 8px 0 rgba(0,0,0,0.25);
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 0.25rem 0.5rem;
            transition: top 0.2s;
        }
        .category-navbar.hidden { display: none; }
        .category-navbar .cat-nav-btn {
            background: none;
            border: none;
            color: #e5e7eb;
            font-weight: 600;
            font-size: 0.9rem;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            transition: background 0.15s, color 0.15s;
            cursor: pointer;
            white-space: nowrap;
            position: relative;
        }
        .category-navbar .cat-nav-btn:not(:last-child)::after {
            content: '|';
            position: absolute;
            right: -0.25rem;
            top: 50%;
            transform: translateY(-50%);
            color: #4b5563;
        }

        .category-navbar .cat-nav-btn.active, .category-navbar .cat-nav-btn:hover {
            background: #6366f1;
            color: #fff;
        }
        .category-navbar-spacer {
            width: 100%;
            transition: height 0.2s;
        }
        
        /* Bases & Bundles Section Styles */
        .management-section {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 1.5rem;
        }
        .list-item {
            cursor: pointer;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
            border: 1px solid #374151;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            min-height: 64px;
        }
        .list-item.active {
            background-color: #6366f1;
            color: white;
            border-color: #4f46e5;
        }
        .list-item:not(.active):hover {
            background-color: #374151;
        }
        .list-item .component-thumbs img {
            height: 48px;
            width: 48px;
            object-fit: cover;
            border-radius: 0.375rem; /* rounded-md */
        }
        
        /* Accordion Styles */
        .accordion-header .lucide-icon {
            transition: transform 0.3s ease-in-out;
        }
        .accordion-header .rotate-180 {
            transform: rotate(180deg);
        }
        .accordion-content {
            transition: max-height 0.3s ease-in-out;
            overflow: hidden;
        }
        
        .ram-qty-btn {
            background-color: #374151;
            border: 1px solid #4b5563;
        }
        .ram-qty-btn.active {
            background-color: #6366f1;
            border-color: #4f46e5;
            color: white;
        }

        /* MODIFIED: Price Check Popup Styles */
        #price-check-popup, #price-chart-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            backdrop-filter: blur(5px);
        }
        #price-check-popup.hidden, #price-chart-popup.hidden {
            display: none;
        }
        .popup-content {
            background-color: #1f2937; /* bg-gray-800 */
            border: 1px solid #4b5563; /* border-gray-600 */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            width: 90%;
            max-width: 450px; /* Smaller width */
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        /* NEW: Styles for chart popup */
        .popup-content-chart {
            background-color: #1f2937;
            border: 1px solid #4b5563;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            width: 90%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1.5rem;
            background-color: #111827; /* bg-gray-900 */
            border-bottom: 1px solid #374151; /* border-gray-700 */
        }
        .popup-body {
             padding: 1.5rem;
        }
        .popup-body-chart {
            padding: 1.5rem;
            height: 400px; /* Fixed height for the chart */
        }
        /* NEW: Styles for popup input */
        .popup-body input {
            background-color: #374151;
            border: 1px solid #4b5563;
            color: white;
            font-size: 1.25rem;
            font-weight: bold;
            padding: 0.75rem;
            border-radius: 0.5rem;
            text-align: right;
        }
        .popup-body input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 2px #4f46e5;
        }

        /* NEW: Tooltip Styles */
        .price-wrapper {
            position: relative;
        }
        .price-history-tooltip {
            visibility: hidden;
            width: 220px;
            background-color: #111827;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 0;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
            border: 1px solid #374151;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .price-wrapper:hover .price-history-tooltip {
            visibility: visible;
            opacity: 1;
        }
        .tooltip-table {
            width: 100%;
            font-size: 0.8rem;
        }
        .tooltip-table th, .tooltip-table td {
            padding: 4px 8px;
            text-align: left;
        }
        .tooltip-table th {
            border-bottom: 1px solid #374151;
        }
        .tooltip-table tr:nth-child(even) {
            background-color: #1f2937;
        }

        /* MODIFIED: Previous price indicator styles */
        .previous-price-indicator {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            margin-bottom: 4px;
            z-index: 5;
            display: flex;
            gap: 4px;
        }
        .old-price-span, .diff-span {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
        }


        @media (max-width: 1024px) {
            .management-section {
                grid-template-columns: 1fr;
            }
        }
        
        /* MODIFIED: Hide non-visible items on mobile and adjust navbar visibility */
        @media (max-width: 639px) {
            .mobile-hidden-if-not-visible {
                display: none;
            }
             #category-navbar, #category-navbar-spacer {
                display: none;
            }
        }
    </style>
</head>
<body class="p-4 md:p-8 bg-gray-900 min-h-screen text-gray-200">
    <!-- Image preview element -->
    <div id="image-preview" class="hidden fixed bottom-4 right-4 bg-gray-800 border border-gray-700 rounded-lg shadow-lg z-50 p-2">
        <img src="" alt="Vista Previa" class="max-w-xs max-h-xs object-contain">
    </div>

    <!-- MODIFIED: Sticky category navigation bar hidden on mobile -->
    <div id="category-navbar" class="category-navbar"></div>
    <div id="category-navbar-spacer" class="category-navbar-spacer"></div>

    <!-- Main container -->
    <div class="mx-auto bg-gray-800 p-6 md:p-8 rounded-xl shadow-lg border border-gray-700" style="width:95%;max-width:1800px;">
        <h1 class="text-3xl font-saira-black text-white mb-6 text-center">Administrador de Vectores de Productos</h1>
        
        <!-- MODIFIED: Hidden on mobile -->
        <div id="top-actions" class="hidden md:flex justify-center items-center gap-4 mb-8 flex-wrap">
             <button onclick="reloadDataFromJson()" class="btn btn-secondary">
                <span class="lucide-icon mr-2" data-lucide="refresh-ccw"></span> Recargar de Archivo
            </button>
            <button onclick="resetSessionAndReload()" class="btn btn-secondary border-amber-500/50 hover:bg-amber-600">
                <span class="lucide-icon mr-2" data-lucide="eraser"></span> Restablecer Sesión
            </button>
            <button id="price-check-loop-btn" onclick="togglePriceCheckLoop()" class="btn btn-success">
                <span class="lucide-icon mr-2" data-lucide="play-circle"></span>
                <span id="price-check-loop-btn-text">Chequeo en Lote</span>
            </button>
        </div>

        <!-- MODIFIED: Hidden on mobile -->
        <div id="bases-section-container" class="mb-8 bg-gray-900 rounded-lg shadow-sm border border-gray-700 hidden md:block">
            <h3 id="bases-accordion-header" class="accordion-header flex justify-between items-center text-xl font-semibold text-gray-100 p-6 cursor-pointer">
                <span>Bases (CPU + Mother + RAM)</span>
                <span class="lucide-icon" data-lucide="chevron-down"></span>
            </h3>
            <div id="bases-accordion-content" class="accordion-content p-6 pt-0 hidden">
                 <div id="bases-section" class="management-section">
                    <!-- Content generated by JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- MODIFIED: Hidden on mobile -->
        <div id="bundles-section-container" class="mb-8 bg-gray-900 rounded-lg shadow-sm border border-gray-700 hidden md:block">
            <h3 id="bundles-accordion-header" class="accordion-header flex justify-between items-center text-xl font-semibold text-gray-100 p-6 cursor-pointer">
                <span>Bundles (Componentes Múltiples)</span>
                <span class="lucide-icon" data-lucide="chevron-down"></span>
            </h3>
            <div id="bundles-accordion-content" class="accordion-content p-6 pt-0 hidden">
                 <div id="bundles-section" class="management-section">
                    <!-- Content generated by JavaScript -->
                </div>
            </div>
        </div>


        <!-- Table View Container -->
        <div id="overview-view" class="tab-content">
            <!-- Content will be generated by JavaScript -->
        </div>

        <!-- MODIFIED: Hidden on mobile -->
        <section class="mt-10 p-6 bg-gray-900 rounded-lg shadow-inner border border-gray-700 hidden md:block">
            <h2 class="text-2xl font-semibold text-gray-100 mb-4 text-center section-title-admin">Generar y Copiar Código de Vectores</h2>
            <textarea id="output-code" rows="15" class="w-full p-4 border border-gray-700 rounded-lg bg-gray-800 text-green-400 font-mono text-sm resize-y" readonly></textarea>
            <div class="flex flex-wrap justify-center items-center mt-4 gap-4">
                <button onclick="generateCode()" class="btn btn-primary">
                    <span class="lucide-icon mr-2" data-lucide="code"></span> Generar Código Actual
                </button>
                <button onclick="copyCode()" class="btn btn-secondary">
                    <span class="lucide-icon mr-2" data-lucide="copy"></span> Copiar Código Actual
                </button>
                <button onclick="generateHistoryCode()" class="btn btn-info">
                    <span class="lucide-icon mr-2" data-lucide="history"></span> Generar Historial
                </button>
                <button onclick="copyHistoryCode()" class="btn btn-secondary">
                    <span class="lucide-icon mr-2" data-lucide="copy-check"></span> Copiar Historial
                </button>
            </div>
            <div id="message-container" class="fixed bottom-6 left-1/2 -translate-x-1/2 flex flex-col items-center gap-2 z-50"></div>
        </section>
    </div>

    <!-- Price Check Popup -->
    <div id="price-check-popup" class="hidden">
        <div class="popup-content">
            <div class="popup-header">
                <h3 id="popup-title" class="text-lg font-bold text-white">Chequeo de Precio</h3>
                <button onclick="closePriceCheckPopup()" class="text-gray-400 hover:text-white">
                    <span class="lucide-icon w-6 h-6" data-lucide="x"></span>
                </button>
            </div>
            <div class="popup-body">
                <p class="text-center text-gray-300 mb-4">La página del producto se abrió en una nueva pestaña. Por favor, ingrese el nuevo precio a continuación.</p>
                <div class="flex justify-between items-center bg-gray-900 p-4 rounded-lg">
                    <div>
                        <p class="text-sm text-gray-400">Precio Actual</p>
                        <p id="popup-current-price" class="text-2xl font-bold text-teal-400">$0</p>
                    </div>
                    <div class="flex flex-col items-end">
                         <label for="popup-new-price" class="text-sm text-gray-400 mb-1">Nuevo Precio (Enter)</label>
                         <input type="text" id="popup-new-price" placeholder="Ingresar..." onkeydown="handleManualPriceCheck(event)" class="w-40">
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- NEW: Price Chart Popup -->
    <div id="price-chart-popup" class="hidden">
        <div class="popup-content-chart">
            <div class="popup-header">
                <h3 id="chart-popup-title" class="text-lg font-bold text-white">Historial de Precios</h3>
                <button onclick="closePriceChartPopup()" class="text-gray-400 hover:text-white">
                    <span class="lucide-icon w-6 h-6" data-lucide="x"></span>
                </button>
            </div>
            <div class="popup-body-chart">
                <canvas id="price-chart-canvas"></canvas>
            </div>
        </div>
    </div>


<script>
    // --- Data Configuration ---
    const CATEGORY_NAV_LIST = [
      { key: 'bases-section-container', label: 'Bases' }, 
      { key: 'bundles-section-container', label: 'Bundles' }, 
      { key: 'armadasOptions', label: 'Armadas', folder: 'armadas' },
      { key: 'miniPcOptions', label: 'MiniPCs', folder: 'minipc' },
      { key: 'towersOptions', label: 'Torres', folder: 'torres' }, 
      { key: 'comboOptions', label: 'Combos', folder: 'combos' }, 
      { key: 'cpuOptions', label: 'CPU', folder: 'cpus' }, 
      { key: 'motherboardOptions', label: 'Mother', folder: 'moms' }, 
      { key: 'ramOptions', label: 'RAM', folder: 'rams' }, 
      { key: 'gpuOptions', label: 'GPU', folder: 'gpus' }, 
      { key: 'ssdOptions', label: 'SSD', folder: 'discos' }, 
      { key: 'psuOptions', label: 'PSU', folder: 'psus' }, 
      { key: 'monitorOptions', label: 'Monitores', folder: 'monitores' }, 
      { key: 'mouseOptions', label: 'Mouse', folder: 'mouses' }, 
      { key: 'joystickOptions', label: 'Joysticks', folder: 'joysticks' }, 
      { key: 'keyboardOptions', label: 'Teclados', folder: 'teclados' }, 
      { key: 'comboMouseTecladoOptions', label: 'M+T', folder: 'combo-mouse-teclado' }, 
      { key: 'auricularesOptions', label: 'Auris', folder: 'auriculares' }, 
      { key: 'parlantesOptions', label: 'Parlantes', folder: 'parlantes' },
      { key: 'webcamOptions', label: 'Webcams', folder: 'webcams' },
      { key: 'microfonosOptions', label: 'Mics', folder: 'mics' },
      { key: 'wifiOptions', label: 'WiFi', folder: 'wifi' },
      { key: 'arosDeLuzOptions', label: 'Luz', folder: 'luz' }
    ];

    const dataMap = {
        baseOptions: [],
        bundleOptions: [], 
        armadasOptions: [], towersOptions: [], ssdOptions: [], gpuOptions: [], 
        psuOptions: [], motherboardOptions: [], cpuOptions: [], ramOptions: [], comboOptions: [], 
        monitorOptions: [], mouseOptions: [], joystickOptions: [], keyboardOptions: [], 
        comboMouseTecladoOptions: [], auricularesOptions: [], parlantesOptions: [],
        webcamOptions: [], microfonosOptions: [], wifiOptions: [], arosDeLuzOptions: [],
        miniPcOptions: []
    };
    
    let selectedBaseIndex = 0;
    let selectedBundleIndex = 0;
    let draggedBundleComponentIndex = null;

    // Price Check Loop State
    let priceCheckQueue = [];
    let currentQueueIndex = 0;
    let isLoopRunning = false;
    
    // NEW: Chart instance variable
    let priceChartInstance = null;

    // --- Category Navigation ---
    
    function renderCategoryNavbar() {
        const navbar = document.getElementById('category-navbar');
        navbar.innerHTML = CATEGORY_NAV_LIST.map(cat => {
            const targetId = cat.key.includes('Options') ? `table-container-${cat.key}` : cat.key;
            return `<button class="cat-nav-btn" data-cat="${targetId}" onclick="scrollToCategory('${targetId}')">${cat.label}</button>`
        }).join('');
        updateNavbarSpacer();
    }
    
    function updateNavbarSpacer() {
        const navbar = document.getElementById('category-navbar');
        const spacer = document.getElementById('category-navbar-spacer');
        if (navbar && spacer) {
            spacer.style.height = `${navbar.offsetHeight}px`;
        }
    }

    function scrollToCategory(targetId) {
        document.querySelectorAll('.category-navbar .cat-nav-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.cat === targetId);
        });
        
        const categoryDiv = document.getElementById(targetId);
        if(categoryDiv) {
            const navbarHeight = document.getElementById('category-navbar').offsetHeight;
            const elementPosition = categoryDiv.getBoundingClientRect().top;
            const offsetPosition = elementPosition + window.pageYOffset - navbarHeight - 20;

            window.scrollTo({
                top: offsetPosition,
                behavior: 'smooth'
            });
        }
    }

    // --- Helper & Utility Functions ---

    // MODIFIED: formatTimestamp to use 24-hour format
    function formatTimestamp(isoString) {
        if (!isoString) return 'Nunca actualizado';
        try {
            const date = new Date(isoString);
            const options = {
                year: '2-digit', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit',
                hour12: false
            };
            return new Intl.DateTimeFormat('es-AR', options).format(date);
        } catch (e) {
            return 'Fecha inválida';
        }
    }

    function getComponentName(type) {
        const keyWithoutOptions = type.replace('Options', '');
        const names = {
            base: 'Base', bundle: 'Bundle', armadas: 'Armada', towers: 'Torre', ssd: 'SSD', gpu: 'GPU', psu: 'PSU',
            motherboard: 'Motherboard', cpu: 'CPU', ram: 'RAM',
            combo: 'Combo', monitor: 'Monitor', mouse: 'Mouse',
            joystick: 'Joystick', keyboard: 'Teclado',
            comboMouseTeclado: 'Combo Mouse y Teclado', auriculares: 'Auricular',
            parlantes: 'Parlante', webcam: 'Webcam', microfonos: 'Mic', wifi: 'WiFi', arosDeLuz: 'Luz', miniPc: 'MiniPC'
        };
        return names[keyWithoutOptions] || 'Componente';
    }
    
    function autofillImagePath(input, categoryKey, index) {
        if (input.value.trim() === '') {
            const categoryInfo = CATEGORY_NAV_LIST.find(cat => cat.key === categoryKey);
            const product = dataMap[categoryKey][index];
            if (categoryInfo && categoryInfo.folder && product && product.id) {
                const newPath = `comps/${categoryInfo.folder}/${product.id}.webp`;
                input.value = newPath;
                updateProduct(categoryKey, index, 'image_url', newPath);
            }
        }
    }

    function showToast(message, type = 'success') {
        const container = document.getElementById('message-container');
        const toast = document.createElement('div');
        const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
        toast.className = `px-4 py-2 rounded-md text-white font-semibold shadow-lg ${bgColor}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }

    function findComponentById(id) {
        for (const categoryKey in dataMap) {
            if (categoryKey === 'baseOptions' || categoryKey === 'bundleOptions') continue;
            const component = dataMap[categoryKey].find(p => p.id == id);
            if (component) {
                return { component, categoryKey };
            }
        }
        const base = dataMap.baseOptions.find(b => b.id == id);
        if (base) {
            return { component: base, categoryKey: 'baseOptions' };
        }
        return null;
    }

    function modifyMercadoLibreLink(urlString) {
        if (!urlString || !urlString.includes('mercadolibre.com')) {
            return urlString;
        }
        try {
            const url = new URL(urlString);
            url.searchParams.set('offer_type', 'OFFICIAL_STORE');
            return url.toString();
        } catch (e) {
            console.error("Invalid URL for modification:", urlString, e);
            return urlString;
        }
    }
    
    function copyToClipboard(text) {
        if (!text) return;
        navigator.clipboard.writeText(text).then(function() {
            showToast(`ID "${text}" copiado.`);
        }, function(err) {
            showToast('No se pudo copiar el ID.', 'error');
            console.error('Could not copy text: ', err);
        });
    }

    // --- Data Persistence ---

    function saveDataToSessionStorage() {
        try {
            sessionStorage.setItem('productAdminData', JSON.stringify(dataMap));
        } catch (e) {
            console.error("Error saving to sessionStorage:", e);
            showToast('Error al guardar datos en la sesión.', 'error');
        }
    }

    function loadDataFromSessionStorage() {
        try {
            const storedData = sessionStorage.getItem('productAdminData');
            return storedData ? JSON.parse(storedData) : null;
        } catch (e) {
            console.error("Error loading from sessionStorage:", e);
            sessionStorage.removeItem('productAdminData');
            return null;
        }
    }

    // --- Core Data Operations ---

    function getAllIds() {
        const ids = new Set();
        for (const key in dataMap) {
            dataMap[key].forEach(item => {
                if (item.id) ids.add(item.id);
            });
        }
        return ids;
    }

    function generateUniqueId(existingIds) {
        let newId;
        do {
            newId = Math.floor(Math.random() * 99999) + 1;
        } while (existingIds.has(newId));
        return newId;
    }

    // MODIFIED: Sanitize and handle price history
    function sanitizeAndAssignDefaults() {
        const existingIds = getAllIds();
        for (const categoryKey in dataMap) {
            if (!Array.isArray(dataMap[categoryKey])) {
                dataMap[categoryKey] = [];
            }
            dataMap[categoryKey].forEach(item => {
                if (!item.id || item.id.toString().includes('-default')) {
                    const newId = generateUniqueId(existingIds);
                    item.id = newId;
                    existingIds.add(newId);
                }
                if (item.visible === undefined) {
                    item.visible = 1;
                }

                // --- Price History Logic ---
                if (item.prices && Array.isArray(item.prices) && item.prices.length > 0) {
                    item.price = item.prices[0].value;
                    item.lastUpd = item.prices[0].date;
                } else if (typeof item.price === 'number') {
                    item.prices = [{
                        value: item.price,
                        date: item.lastUpd || new Date(0).toISOString()
                    }];
                } else {
                    item.price = 0;
                    item.prices = [];
                }
                // --- End Price History Logic ---

                if (categoryKey === 'baseOptions') {
                    if (item.description === undefined) item.description = '';
                    if (item.totalram === undefined) item.totalram = 0;
                }
                if (categoryKey === 'bundleOptions') {
                    if (item.description === undefined) item.description = '';
                }
                if (categoryKey === 'miniPcOptions') {
                    if (item.cpu === undefined) item.cpu = '';
                    if (item.ram === undefined) item.ram = '';
                    if (item.ssd === undefined) item.ssd = '';
                }
                if (categoryKey === 'ramOptions') {
                    if (item.total === undefined) item.total = 0;
                }
                // NEW: Ensure towers have a description field
                if (categoryKey === 'towersOptions' && item.description === undefined) {
                    item.description = '';
                }
            });
        }
    }

    function addProduct(categoryKey, productData) {
        let newProduct;
        if (productData) {
            newProduct = productData;
        } else {
            newProduct = { name: '', price: 0, image_url: '', link: '', visible: 1 };
            if (categoryKey === 'miniPcOptions') {
                newProduct.cpu = '';
                newProduct.ram = '';
                newProduct.ssd = '';
            } else if (categoryKey === 'ramOptions') {
                newProduct.total = 0;
                newProduct.description = '';
            } else {
                newProduct.description = '';
            }
        }
        
        if (!newProduct.id) {
            newProduct.id = generateUniqueId(getAllIds());
        }
        if (newProduct.visible === undefined) {
            newProduct.visible = 1;
        }
        // Initialize price history for new products
        newProduct.prices = [{ value: newProduct.price, date: new Date().toISOString() }];
        newProduct.lastUpd = newProduct.prices[0].date;

        dataMap[categoryKey].push(newProduct);
        renderOverviewTables();
        saveDataToSessionStorage();
    }

    function removeProduct(categoryKey, index) {
        if (!dataMap[categoryKey] || index < 0 || index >= dataMap[categoryKey].length) return;
        dataMap[categoryKey].splice(index, 1);
        renderOverviewTables();
        saveDataToSessionStorage();
    }

    // MODIFIED: updateProduct to handle price history
    function updateProduct(categoryKey, index, key, value) {
        if (dataMap[categoryKey] && dataMap[categoryKey][index]) {
            const product = dataMap[categoryKey][index];
            
            if (key === 'price') {
                const newTimestamp = new Date().toISOString();
                const newPrice = value;

                product.price = newPrice;
                product.lastUpd = newTimestamp;

                if (!Array.isArray(product.prices)) {
                    product.prices = [];
                }
                product.prices.unshift({ value: newPrice, date: newTimestamp });
                
                // Update tooltip dynamically
                const tableRow = document.getElementById(`row-${categoryKey}-${index}`);
                if (tableRow) {
                    const tooltip = tableRow.querySelector('.price-history-tooltip');
                    if (tooltip) {
                        tooltip.innerHTML = generateTooltipTable(product.prices);
                    }
                }
            } else {
                product[key] = value;
            }
            
            if (key === 'price' || (categoryKey === 'ramOptions' && key === 'total')) {
                updateAllBaseTotals();
                updateAllBundleTotals();
                renderBasesSection();
                renderBundlesSection();
            }

            saveDataToSessionStorage();
        }
    }

    // BUG FIX: Separated formatting from data update logic
    function formatPriceInput(input) {
        // This function will only format the display value without saving anything.
        let raw = input.value.replace(/[^\d]/g, '');
        let num = parseInt(raw, 10);
        input.value = isNaN(num) ? '' : num.toLocaleString('es-AR');
    }
    
    // NEW HELPER: Centralized logic for applying visual feedback on price change
    function applyPriceChangeVisuals(tableRow, oldPrice, newPrice) {
        const diff = newPrice - oldPrice;
        let highlightColor = 'rgba(2, 132, 199, 0.3)'; // Blue for no change
        let diffColor = '';

        if (diff < 0) {
            highlightColor = 'rgba(34, 197, 94, 0.3)'; // Green
            diffColor = 'rgba(34, 197, 94, 1)';
        } else if (diff > 0) {
            highlightColor = 'rgba(139, 92, 246, 0.3)'; // Violet
            diffColor = 'rgba(139, 92, 246, 1)';
        }

        tableRow.style.backgroundColor = highlightColor;

        const priceWrapper = tableRow.querySelector('.price-wrapper');
        if (priceWrapper) {
            const existingIndicator = priceWrapper.querySelector('.previous-price-indicator');
            if (existingIndicator) existingIndicator.remove();

            if (diff !== 0) {
                const indicatorContainer = document.createElement('div');
                indicatorContainer.className = 'previous-price-indicator';

                const oldPriceSpan = document.createElement('span');
                oldPriceSpan.className = 'old-price-span';
                oldPriceSpan.style.backgroundColor = '#4b5563'; // Gray-600
                oldPriceSpan.textContent = `$${oldPrice.toLocaleString('es-AR')}`;

                const diffSpan = document.createElement('span');
                diffSpan.className = 'diff-span';
                diffSpan.style.backgroundColor = diffColor;
                const diffAmount = Math.round(diff / 1000);
                diffSpan.textContent = diffAmount > 0 ? `+${diffAmount}k` : `${diffAmount}k`;
                
                indicatorContainer.appendChild(oldPriceSpan);
                indicatorContainer.appendChild(diffSpan);
                priceWrapper.appendChild(indicatorContainer);
            }
        }
    }

    function updatePriceFromInput(input, categoryKey, index) {
        // This function commits the final value to the data model.
        let raw = input.value.replace(/[^\d]/g, '');
        let newPrice = parseInt(raw, 10) || 0;
        const product = dataMap[categoryKey][index];
        const oldPrice = product.price;

        if (oldPrice !== newPrice) {
            updateProduct(categoryKey, index, 'price', newPrice);
            const tableRow = document.getElementById(`row-${categoryKey}-${index}`);
            applyPriceChangeVisuals(tableRow, oldPrice, newPrice);
        }
    }
    
    async function replaceLink(categoryKey, index) {
        try {
            let text = await navigator.clipboard.readText();
            if (typeof text !== 'string' || !text.trim().startsWith('http')) {
                showToast('El portapapeles no contiene un link válido.', 'error');
                return;
            }
            text = modifyMercadoLibreLink(text.trim());
            dataMap[categoryKey][index].link = text;
            saveDataToSessionStorage();
            renderOverviewTables();
            showToast('Link reemplazado con éxito.');
        } catch (err) {
            console.error("Clipboard error:", err);
            showToast('No se pudo acceder al portapapeles.', 'error');
        }
    }
    
    // --- UI Rendering ---

    function showImagePreview(imageUrl) {
        const preview = document.getElementById('image-preview');
        const img = preview.querySelector('img');
        if (imageUrl) {
            img.src = imageUrl;
            preview.classList.remove('hidden');
        }
    }

    function hideImagePreview() {
        document.getElementById('image-preview').classList.add('hidden');
    }

    // --- BUNDLES Section Rendering ---
    function renderBundlesSection() {
        const container = document.getElementById('bundles-section');
        if (!dataMap.bundleOptions) dataMap.bundleOptions = [];
        if (dataMap.bundleOptions.length === 0) {
            dataMap.bundleOptions.push({ id: generateUniqueId(getAllIds()), name: 'Nuevo Bundle', description: '', components: [], total: 0, visible: 1 });
        }
        
        container.innerHTML = `
            <div class="flex flex-col gap-2">
                <div id="bundle-list" class="flex flex-col gap-2 mb-4">
                    ${dataMap.bundleOptions.map((bundle, index) => {
                        const componentImages = (bundle.components || [])
                            .map(compId => {
                                const found = findComponentById(compId);
                                return found ? found.component.image_url : null;
                            })
                            .filter(Boolean);

                        return `
                        <div id="bundle-item-${index}" class="list-item ${index === selectedBundleIndex ? 'active' : ''}" onclick="selectBundle(${index})">
                            <div class="flex-grow">
                                <p class="font-bold truncate">${bundle.name || 'Sin Nombre'}</p>
                                <p class="text-xs opacity-75 truncate">${bundle.id || 'Sin ID'}</p>
                                <p class="font-bold text-lg text-teal-400 mt-1">$${(bundle.total || 0).toLocaleString('es-AR')}</p>
                            </div>
                            <div class="flex-shrink-0 flex items-center gap-1 component-thumbs">
                                ${componentImages.slice(0, 4).map(imgUrl => `
                                    <img src="${imgUrl}" onerror="this.style.display='none'" alt="component thumbnail">
                                `).join('')}
                            </div>
                        </div>
                        `
                    }).join('')}
                </div>
                <div class="flex gap-2">
                    <button onclick="addBundle()" class="btn btn-primary w-full text-sm py-2">
                        <span class="lucide-icon mr-2" data-lucide="plus"></span> Añadir Bundle
                    </button>
                    <button onclick="deleteSelectedBundle()" class="btn btn-danger w-auto px-3 py-2" title="Eliminar Bundle Seleccionado">
                        <span class="lucide-icon" data-lucide="trash-2"></span>
                    </button>
                </div>
            </div>
            <div id="bundle-details" class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                <!-- Details of selected bundle will be rendered here -->
            </div>
        `;
        renderSelectedBundleDetails();
        lucide.createIcons();
    }

    function renderSelectedBundleDetails() {
        const detailsContainer = document.getElementById('bundle-details');
        const bundle = dataMap.bundleOptions[selectedBundleIndex];

        if (!bundle) {
            detailsContainer.innerHTML = '<p>No hay un bundle seleccionado.</p>';
            return;
        }
        
        const baseComponentOptions = `<optgroup label="Bases">
            ${dataMap.baseOptions.map(base => `<option value="${base.id}">${base.name} ($${(base.total || 0).toLocaleString('es-AR')})</option>`).join('')}
        </optgroup>`;

        const allComponentsOptions = CATEGORY_NAV_LIST
            .filter(cat => cat.key.includes('Options') && !['armadasOptions', 'baseOptions', 'bundleOptions'].includes(cat.key))
            .map(cat => {
                const components = dataMap[cat.key];
                if (!components || components.length === 0) return '';
                return `
                    <optgroup label="${cat.label}">
                        ${components.map(comp => `<option value="${comp.id}">${comp.name} ($${(comp.price || 0).toLocaleString('es-AR')})</option>`).join('')}
                    </optgroup>
                `;
            }).join('');

        detailsContainer.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Nombre del Bundle</label>
                    <input type="text" value="${bundle.name || ''}" oninput="updateBundle('name', this.value)" class="w-full">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">ID</label>
                    <div class="w-full p-2 bg-gray-900 rounded-md text-xs font-mono text-gray-400 truncate">${bundle.id}</div>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium mb-1">Descripción</label>
                    <textarea oninput="updateBundle('description', this.value)" class="w-full" rows="2">${bundle.description || ''}</textarea>
                </div>
                 <div class="md:col-span-1">
                    <label class="block text-sm font-medium mb-1">Total del Bundle</label>
                    <div class="w-full p-2 bg-gray-900 rounded-md text-lg font-bold text-teal-400">
                        $${(bundle.total || 0).toLocaleString('es-AR')}
                    </div>
                </div>
                <div class="md:col-span-1 flex items-center justify-center">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" ${bundle.visible ? 'checked' : ''} onchange="updateBundle('visible', this.checked ? 1 : 0)" class="w-5 h-5 rounded text-indigo-500 bg-gray-700 border-gray-600 focus:ring-indigo-600">
                        <span class="font-medium">Visible</span>
                    </label>
                </div>
            </div>
            
            <div class="mb-4">
                <h4 class="font-semibold mb-2">Añadir Componente</h4>
                <div class="flex gap-2">
                    <select id="add-component-select-bundle" class="w-full">
                        <option value="">Seleccionar componente...</option>
                        ${baseComponentOptions}
                        ${allComponentsOptions}
                    </select>
                    <button onclick="addComponentToBundle()" class="btn btn-secondary py-2">Añadir</button>
                </div>
            </div>

            <h4 class="font-semibold mb-2">Componentes en este Bundle</h4>
            <div class="overflow-x-auto">
                <table class="bundles-table w-full text-left text-sm text-gray-400">
                    <thead class="text-xs text-gray-200 uppercase bg-gray-700">
                        <tr>
                            <th scope="col" class="px-4 py-3">Categoría</th>
                            <th scope="col" class="px-6 py-3">Nombre</th>
                            <th scope="col" class="px-6 py-3">Precio</th>
                            <th scope="col" class="px-2 py-3">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${(bundle.components || []).map((compId, index) => {
                            const found = findComponentById(compId);
                            if (!found) {
                                return `<tr class="border-b border-gray-700"><td colspan="4" class="text-red-500 p-2">Componente con ID ${compId} no encontrado.</td></tr>`;
                            }
                            const { component, categoryKey } = found;
                            const price = categoryKey === 'baseOptions' ? component.total : component.price;
                            const linkHref = categoryKey === 'baseOptions' ? '#bases-section-container' : `#row-${categoryKey}-${dataMap[categoryKey].indexOf(component)}`;
                            const linkOnClick = categoryKey === 'baseOptions' ? `scrollToCategory('bases-section-container')` : `scrollToComponentRow('${categoryKey}', ${dataMap[categoryKey].indexOf(component)})`;

                            return `
                                <tr class="border-b border-gray-700 hover:bg-gray-700/50" 
                                    ondragover="onBundleComponentDragOver(event)"
                                    ondrop="onBundleComponentDrop(event, ${index})"
                                    onmouseenter="showImagePreview('${component.image_url || ''}')"
                                    onmouseleave="hideImagePreview()">
                                    <td class="px-4 py-2">${getComponentName(categoryKey)}</td>
                                    <td class="px-6 py-2 font-medium text-white">${component.name}</td>
                                    <td class="px-6 py-2">$${(price || 0).toLocaleString('es-AR')}</td>
                                    <td class="px-2 py-2 text-right">
                                        <div class="flex items-center justify-end">
                                            <a href="${linkHref}" onclick="${linkOnClick}" class="text-blue-400 hover:text-blue-300" title="Ir al componente">
                                                <span class="lucide-icon w-4 h-4" data-lucide="link"></span>
                                            </a>
                                            <button onclick="removeComponentFromBundle(${index})" class="text-red-500 hover:text-red-700 ml-2" title="Eliminar de la base">
                                                <span class="lucide-icon w-4 h-4" data-lucide="trash-2"></span>
                                            </button>
                                            <button draggable="true" ondragstart="onBundleComponentDragStart(event, ${index})" class="text-gray-400 hover:text-indigo-400 ml-2 cursor-move" title="Arrastrar para reordenar">
                                                <span class="lucide-icon w-4 h-4" data-lucide="move"></span>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                        ${(bundle.components || []).length === 0 ? '<tr><td colspan="4" class="text-center p-4">Este bundle está vacío.</td></tr>' : ''}
                    </tbody>
                </table>
            </div>
        `;
        lucide.createIcons();
    }
    
    // --- BUNDLES Data Operations ---
    function calculateBundleTotal(bundle) {
        if (!bundle || !bundle.components) return 0;
        return bundle.components.reduce((sum, compId) => {
            const found = findComponentById(compId);
            if (!found) return sum;
            const priceToAdd = found.component.total !== undefined ? found.component.total : found.component.price;
            return sum + (priceToAdd || 0);
        }, 0);
    }

    function updateAllBundleTotals() {
        dataMap.bundleOptions.forEach(bundle => {
            bundle.total = calculateBundleTotal(bundle);
        });
    }

    function selectBundle(index) {
        selectedBundleIndex = index;
        renderBundlesSection();
    }

    function addBundle() {
        dataMap.bundleOptions.push({
            id: generateUniqueId(getAllIds()),
            name: 'Nuevo Bundle',
            description: '',
            components: [],
            total: 0,
            visible: 1
        });
        selectedBundleIndex = dataMap.bundleOptions.length - 1;
        renderBundlesSection();
        saveDataToSessionStorage();
    }

    function deleteSelectedBundle() {
        if (dataMap.bundleOptions.length <= 1) {
            showToast('No se puede eliminar el último bundle.', 'error');
            return;
        }
        dataMap.bundleOptions.splice(selectedBundleIndex, 1);
        if (selectedBundleIndex >= dataMap.bundleOptions.length) {
            selectedBundleIndex = dataMap.bundleOptions.length - 1;
        }
        renderBundlesSection();
        saveDataToSessionStorage();
    }

    function updateBundle(key, value) {
        const bundle = dataMap.bundleOptions[selectedBundleIndex];
        if (bundle) {
            bundle[key] = value;
            saveDataToSessionStorage();
            
            if (key === 'name' || key === 'id') {
                const bundleItemDiv = document.getElementById(`bundle-item-${selectedBundleIndex}`);
                if (bundleItemDiv) {
                    if (key === 'name') {
                        bundleItemDiv.querySelector('p.font-bold').textContent = value || 'Sin Nombre';
                    }
                }
            }
        }
    }

    function addComponentToBundle() {
        const select = document.getElementById('add-component-select-bundle');
        const componentId = select.value;
        if (componentId && dataMap.bundleOptions[selectedBundleIndex]) {
            if (!dataMap.bundleOptions[selectedBundleIndex].components) {
                dataMap.bundleOptions[selectedBundleIndex].components = [];
            }
            dataMap.bundleOptions[selectedBundleIndex].components.push(componentId);
            updateAllBundleTotals();
            renderBundlesSection();
            saveDataToSessionStorage();
        }
    }

    function removeComponentFromBundle(componentIndex) {
        if (dataMap.bundleOptions[selectedBundleIndex] && dataMap.bundleOptions[selectedBundleIndex].components) {
            dataMap.bundleOptions[selectedBundleIndex].components.splice(componentIndex, 1);
            updateAllBundleTotals();
            renderBundlesSection();
            saveDataToSessionStorage();
        }
    }

    function onBundleComponentDragStart(event, index) {
        draggedBundleComponentIndex = index;
        event.dataTransfer.effectAllowed = 'move';
    }

    function onBundleComponentDragOver(event) {
        event.preventDefault();
        event.dataTransfer.dropEffect = 'move';
    }

    function onBundleComponentDrop(event, targetIndex) {
        event.preventDefault();
        if (draggedBundleComponentIndex !== null && draggedBundleComponentIndex !== targetIndex) {
            const bundle = dataMap.bundleOptions[selectedBundleIndex];
            if (bundle && bundle.components) {
                const moved = bundle.components.splice(draggedBundleComponentIndex, 1)[0];
                bundle.components.splice(targetIndex, 0, moved);
                renderSelectedBundleDetails();
                saveDataToSessionStorage();
            }
        }
        draggedBundleComponentIndex = null;
    }

    // --- NEW BASES SECTION ---
    function renderBasesSection() {
        const container = document.getElementById('bases-section');
        if (!dataMap.baseOptions) dataMap.baseOptions = [];
        if (dataMap.baseOptions.length === 0) {
            dataMap.baseOptions.push({ id: generateUniqueId(getAllIds()), name: 'Nueva Base', cpu: null, mother: null, ram: null, cantRam: 1, total: 0, visible: 1, description: '', totalram: 0 });
        }
        
        container.innerHTML = `
            <div class="flex flex-col gap-2">
                <div id="base-list" class="flex flex-col gap-2 mb-4">
                    ${dataMap.baseOptions.map((base, index) => `
                        <div id="base-item-${index}" class="list-item ${index === selectedBaseIndex ? 'active' : ''}" onclick="selectBase(${index})">
                            <div class="flex-grow">
                                <p class="font-bold truncate">${base.name || 'Sin Nombre'}</p>
                                <p class="text-xs opacity-75 truncate">${base.id || 'Sin ID'}</p>
                                <p class="font-bold text-lg text-teal-400 mt-1">$${(base.total || 0).toLocaleString('es-AR')}</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="flex gap-2">
                    <button onclick="addBase()" class="btn btn-primary w-full text-sm py-2">
                        <span class="lucide-icon mr-2" data-lucide="plus"></span> Añadir Base
                    </button>
                    <button onclick="deleteSelectedBase()" class="btn btn-danger w-auto px-3 py-2" title="Eliminar Base Seleccionada">
                        <span class="lucide-icon" data-lucide="trash-2"></span>
                    </button>
                </div>
            </div>
            <div id="base-details" class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                <!-- Details of selected base will be rendered here -->
            </div>
        `;
        renderSelectedBaseDetails();
        lucide.createIcons();
    }

    function renderSelectedBaseDetails() {
        const detailsContainer = document.getElementById('base-details');
        const base = dataMap.baseOptions[selectedBaseIndex];

        if (!base) {
            detailsContainer.innerHTML = '<p>No hay una base seleccionada.</p>';
            return;
        }
        
        const cpuIndex = dataMap.cpuOptions.findIndex(c => c.id == base.cpu);
        const motherIndex = dataMap.motherboardOptions.findIndex(m => m.id == base.mother);
        const ramIndex = dataMap.ramOptions.findIndex(r => r.id == base.ram);

        const cpuOptions = dataMap.cpuOptions.map(c => `<option value="${c.id}" ${base.cpu == c.id ? 'selected' : ''}>${c.name} ($${(c.price||0).toLocaleString('es-AR')})</option>`).join('');
        const motherOptions = dataMap.motherboardOptions.map(m => `<option value="${m.id}" ${base.mother == m.id ? 'selected' : ''}>${m.name} ($${(m.price||0).toLocaleString('es-AR')})</option>`).join('');
        const ramOptions = dataMap.ramOptions.map(r => `<option value="${r.id}" ${base.ram == r.id ? 'selected' : ''}>${r.name} ($${(r.price||0).toLocaleString('es-AR')})</option>`).join('');

        detailsContainer.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                 <div>
                    <label class="block text-sm font-medium mb-1">Nombre de la Base</label>
                    <input type="text" value="${base.name || ''}" oninput="updateBase('name', this.value)" class="w-full">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">ID</label>
                    <div class="w-full p-2 bg-gray-900 rounded-md text-xs font-mono text-gray-400 truncate">${base.id}</div>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium mb-1">Descripción</label>
                    <textarea oninput="updateBase('description', this.value)" class="w-full" rows="2">${base.description || ''}</textarea>
                </div>
            </div>
            <div class="space-y-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-1">CPU</label>
                    <div class="flex items-center gap-2">
                        <select onchange="updateBase('cpu', this.value)" class="flex-grow">
                            <option value="">Seleccionar CPU...</option>
                            ${cpuOptions}
                        </select>
                        <a href="#row-cpuOptions-${cpuIndex}" onclick="scrollToComponentRow('cpuOptions', ${cpuIndex})" class="${cpuIndex > -1 ? 'inline-flex' : 'hidden'} text-blue-400 hover:text-blue-300" title="Ir al componente">
                             <span class="lucide-icon" data-lucide="link"></span>
                        </a>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Motherboard</label>
                     <div class="flex items-center gap-2">
                        <select onchange="updateBase('mother', this.value)" class="flex-grow">
                            <option value="">Seleccionar Motherboard...</option>
                            ${motherOptions}
                        </select>
                        <a href="#row-motherboardOptions-${motherIndex}" onclick="scrollToComponentRow('motherboardOptions', ${motherIndex})" class="${motherIndex > -1 ? 'inline-flex' : 'hidden'} text-blue-400 hover:text-blue-300" title="Ir al componente">
                             <span class="lucide-icon" data-lucide="link"></span>
                        </a>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div class="col-span-2">
                        <label class="block text-sm font-medium mb-1">RAM</label>
                        <div class="flex items-center gap-2">
                            <select onchange="updateBase('ram', this.value)" class="flex-grow">
                                <option value="">Seleccionar RAM...</option>
                                ${ramOptions}
                            </select>
                             <a href="#row-ramOptions-${ramIndex}" onclick="scrollToComponentRow('ramOptions', ${ramIndex})" class="${ramIndex > -1 ? 'inline-flex' : 'hidden'} text-blue-400 hover:text-blue-300" title="Ir al componente">
                                <span class="lucide-icon" data-lucide="link"></span>
                            </a>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Cantidad</label>
                        <div class="flex items-center justify-between gap-1">
                            ${[1, 2, 3, 4].map(n => `<button class="btn ram-qty-btn w-full text-xs py-2 px-0 ${base.cantRam == n ? 'active' : ''}" onclick="updateBase('cantRam', ${n})">${n}</button>`).join('')}
                        </div>
                    </div>
                </div>
            </div>
             <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                 <div class="md:col-span-1">
                    <label class="block text-sm font-medium mb-1">Total de la Base</label>
                    <div class="w-full p-2 bg-gray-900 rounded-md text-lg font-bold text-teal-400">
                        $${(base.total || 0).toLocaleString('es-AR')}
                    </div>
                </div>
                 <div class="md:col-span-1">
                    <label class="block text-sm font-medium mb-1">Total RAM (GB)</label>
                    <div class="w-full p-2 bg-gray-900 rounded-md text-lg font-bold text-teal-400">
                        ${base.totalram || 0} GB
                    </div>
                </div>
                <div class="md:col-span-2 flex items-center justify-center pt-2">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" ${base.visible ? 'checked' : ''} onchange="updateBase('visible', this.checked ? 1 : 0)" class="w-5 h-5 rounded text-indigo-500 bg-gray-700 border-gray-600 focus:ring-indigo-600">
                        <span class="font-medium">Visible</span>
                    </label>
                </div>
            </div>
        `;
        lucide.createIcons();
    }

    function calculateBaseTotal(base) {
        if (!base) return 0;
        const cpu = dataMap.cpuOptions.find(c => c.id == base.cpu);
        const mother = dataMap.motherboardOptions.find(m => m.id == base.mother);
        const ram = dataMap.ramOptions.find(r => r.id == base.ram);
        const cantRam = base.cantRam || 1;

        const cpuPrice = cpu ? cpu.price || 0 : 0;
        const motherPrice = mother ? mother.price || 0 : 0;
        const ramPrice = ram ? ram.price || 0 : 0;
        
        return cpuPrice + motherPrice + (ramPrice * cantRam);
    }

    function calculateBaseRamTotal(base) {
        if (!base || !base.ram) return 0;
        const ram = dataMap.ramOptions.find(r => r.id == base.ram);
        const cantRam = base.cantRam || 1;
        const ramTotal = ram ? ram.total || 0 : 0;
        return ramTotal * cantRam;
    }

    function updateAllBaseTotals() {
        dataMap.baseOptions.forEach(base => {
            base.total = calculateBaseTotal(base);
            base.totalram = calculateBaseRamTotal(base);
        });
    }

    function selectBase(index) {
        selectedBaseIndex = index;
        renderBasesSection();
    }

    function addBase() {
        dataMap.baseOptions.push({
            id: generateUniqueId(getAllIds()),
            name: 'Nueva Base',
            cpu: null, mother: null, ram: null, cantRam: 1,
            total: 0,
            visible: 1,
            description: '',
            totalram: 0
        });
        selectedBaseIndex = dataMap.baseOptions.length - 1;
        renderBasesSection();
        saveDataToSessionStorage();
    }

    function deleteSelectedBase() {
        if (dataMap.baseOptions.length <= 1) {
            showToast('No se puede eliminar la última base.', 'error');
            return;
        }
        dataMap.baseOptions.splice(selectedBaseIndex, 1);
        if (selectedBaseIndex >= dataMap.baseOptions.length) {
            selectedBaseIndex = dataMap.baseOptions.length - 1;
        }
        renderBasesSection();
        saveDataToSessionStorage();
    }

    function updateBase(key, value) {
        const base = dataMap.baseOptions[selectedBaseIndex];
        if (base) {
            base[key] = value;

            if (key === 'cpu') {
                const cpu = dataMap.cpuOptions.find(c => c.id == value);
                if (cpu) {
                    base.name = cpu.name;
                }
            }

            base.total = calculateBaseTotal(base);
            base.totalram = calculateBaseRamTotal(base);
            saveDataToSessionStorage();
            
            updateAllBundleTotals();

            if (['cpu', 'mother', 'ram', 'cantRam'].includes(key)) {
                renderBasesSection();
                renderBundlesSection();
            } else if (key === 'name') {
                 const baseItemDiv = document.getElementById(`base-item-${selectedBaseIndex}`);
                if (baseItemDiv) {
                    baseItemDiv.querySelector('p.font-bold').textContent = value || 'Sin Nombre';
                }
            }
        }
    }

    function scrollToComponentRow(categoryKey, index) {
        const rowId = `row-${categoryKey}-${index}`;
        const row = document.getElementById(rowId);
        if (row) {
            const navbarHeight = document.getElementById('category-navbar').offsetHeight;
            const elementPosition = row.getBoundingClientRect().top;
            const offsetPosition = elementPosition + window.pageYOffset - navbarHeight - 20;

            window.scrollTo({ top: offsetPosition, behavior: 'smooth' });
            
            row.style.transition = 'background-color 0.5s ease-in-out';
            row.style.backgroundColor = 'rgba(99, 102, 241, 0.5)';
            setTimeout(() => {
                row.style.backgroundColor = '';
            }, 2000);
        }
    }

    // NEW: Function to generate the HTML for the tooltip table
    function generateTooltipTable(prices) {
        if (!prices || prices.length === 0) {
            return '<span>Sin historial de precios.</span>';
        }
        const recentPrices = prices.slice(0, 7);
        let tableHTML = '<table class="tooltip-table"><thead><tr><th>Fecha</th><th>Precio</th></tr></thead><tbody>';
        recentPrices.forEach(p => {
            tableHTML += `<tr><td>${formatTimestamp(p.date)}</td><td>$${p.value.toLocaleString('es-AR')}</td></tr>`;
        });
        tableHTML += '</tbody></table>';
        return tableHTML;
    }

    function renderOverviewTables() {
        const overviewContainer = document.getElementById('overview-view');
        overviewContainer.innerHTML = '';

        CATEGORY_NAV_LIST.forEach(category => {
            const categoryKey = category.key;
            if (!categoryKey.includes('Options')) return;

            const categoryData = dataMap[categoryKey];
            const readableCategoryName = category.label;
            
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'mb-8 p-6 bg-gray-900 rounded-lg shadow-sm border border-gray-700 category-table-container';
            categoryDiv.id = `table-container-${categoryKey}`;
            categoryDiv.innerHTML = `<h3 class="text-xl font-semibold text-gray-100 mb-4">${readableCategoryName}</h3>`;

            const table = document.createElement('table');
            table.className = 'overview-table w-full text-left text-sm text-gray-400';
            
            let headers = `
                <th scope="col" class="px-2 py-3 hidden md:table-cell" style="width: 1%;">ID</th>
                <th scope="col" class="px-2 py-3" style="width: 240px;">Nombre</th>
                <th scope="col" class="px-2 py-3 text-left" style="width: 120px;">Precio</th>
                <th scope="col" class="px-2 py-3 hidden md:table-cell">Descripción</th>
                <th scope="col" class="px-2 py-3 hidden md:table-cell" style="width: 1%;">Visible</th>
                <th scope="col" class="px-1 py-3 hidden md:table-cell" style="width:1%;min-width:150px;">Acciones</th>
            `;
            if (categoryKey === 'ramOptions') {
                headers = `
                    <th scope="col" class="px-2 py-3 hidden md:table-cell" style="width: 1%;">ID</th>
                    <th scope="col" class="px-2 py-3" style="width: 240px;">Nombre</th>
                    <th scope="col" class="px-2 py-3 text-left" style="width: 120px;">Precio</th>
                    <th scope="col" class="px-2 py-3 hidden md:table-cell">Descripción</th>
                    <th scope="col" class="px-2 py-3 hidden md:table-cell">Total (GB)</th>
                    <th scope="col" class="px-2 py-3 hidden md:table-cell" style="width: 1%;">Visible</th>
                    <th scope="col" class="px-1 py-3 hidden md:table-cell" style="width:1%;min-width:150px;">Acciones</th>
                `;
            } else if (categoryKey === 'miniPcOptions') {
                headers = `
                    <th scope="col" class="px-2 py-3 hidden md:table-cell" style="width: 1%;">ID</th>
                    <th scope="col" class="px-2 py-3" style="width: 240px;">Nombre</th>
                    <th scope="col" class="px-2 py-3 text-left" style="width: 120px;">Precio</th>
                    <th scope="col" class="px-2 py-3 hidden md:table-cell">CPU</th>
                    <th scope="col" class="px-2 py-3 hidden md:table-cell">RAM</th>
                    <th scope="col" class="px-2 py-3 hidden md:table-cell">SSD</th>
                    <th scope="col" class="px-2 py-3 hidden md:table-cell" style="width: 1%;">Visible</th>
                    <th scope="col" class="px-1 py-3 hidden md:table-cell" style="width:1%;min-width:150px;">Acciones</th>
                `;
            }
            
            let colspan = 6;
            if (categoryKey === 'ramOptions') {
                colspan = 7;
            } else if (categoryKey === 'miniPcOptions') {
                colspan = 8;
            }


            table.innerHTML = `
                <thead class="text-xs text-gray-200 uppercase bg-gray-700">
                    <tr>${headers}</tr>
                </thead>
                <tbody>
                    ${(categoryData || []).map((product, index) => {
                        let customColumns;
                        if (categoryKey === 'miniPcOptions') {
                            customColumns = `
                                <td class="px-2 py-2 hidden md:table-cell"><input type="text" value="${product.cpu || ''}" oninput="updateProduct('${categoryKey}', ${index}, 'cpu', this.value)" class="w-full"></td>
                                <td class="px-2 py-2 hidden md:table-cell"><input type="text" value="${product.ram || ''}" oninput="updateProduct('${categoryKey}', ${index}, 'ram', this.value)" class="w-full"></td>
                                <td class="px-2 py-2 hidden md:table-cell"><input type="text" value="${product.ssd || ''}" oninput="updateProduct('${categoryKey}', ${index}, 'ssd', this.value)" class="w-full"></td>
                            `;
                        } else if (categoryKey === 'ramOptions') {
                             customColumns = `
                                <td class="px-2 py-2 hidden md:table-cell">
                                    <textarea rows="2" style="min-height:2.5em;max-height:4.5em;" oninput="updateProduct('${categoryKey}', ${index}, 'description', this.value)" class="w-full resize-none">${product.description || ''}</textarea>
                                </td>
                                <td class="px-2 py-2 hidden md:table-cell">
                                    <input type="number" value="${product.total || 0}" oninput="updateProduct('${categoryKey}', ${index}, 'total', parseInt(this.value, 10) || 0)" class="w-full">
                                </td>
                            `;
                        } else {
                            customColumns = `
                            <td class="px-2 py-2 hidden md:table-cell">
                                <textarea rows="2" style="min-height:2.5em;max-height:4.5em;" oninput="updateProduct('${categoryKey}', ${index}, 'description', this.value)" class="w-full resize-none">${product.description || ''}</textarea>
                            </td>`;
                        }

                        const priceCheckButton = product.link ? `
                            <button onclick="openPriceCheckPopup('${categoryKey}', ${index})" class="text-teal-400 hover:text-teal-300" title="Chequear Precio Manualmente">
                                <span class="lucide-icon w-4 h-4" data-lucide="dollar-sign"></span>
                            </button>
                        ` : '';
                        
                        const tooltipTableHTML = generateTooltipTable(product.prices);
                        
                        // NEW: Chart button
                        const chartButton = (product.prices && product.prices.length > 1) ? `
                            <button onclick="openPriceChartPopup('${categoryKey}', ${index})" class="text-indigo-400 hover:text-indigo-300 ml-2" title="Ver Historial de Precios">
                                <span class="lucide-icon w-4 h-4" data-lucide="line-chart"></span>
                            </button>
                        ` : '';

                        return `
                        <tr id="row-${categoryKey}-${index}" class="border-b border-gray-700 hover:bg-gray-700/50 transition-colors duration-200 ${!product.visible ? 'mobile-hidden-if-not-visible' : ''}" 
                            ondragover="onRowDragOver(event)" 
                            ondrop="onRowDrop(event, '${categoryKey}', ${index})"
                            onmouseenter="showImagePreview('${product.image_url || ''}')"
                            onmouseleave="hideImagePreview()">
                            <td class="px-2 py-2 text-center text-xs text-gray-400 font-mono cursor-pointer hover:text-white hidden md:table-cell" onclick="copyToClipboard('${product.id || ''}')" title="Copiar ID">${product.id || ''}</td>
                            <td class="px-2 py-2 font-medium text-white whitespace-nowrap">
                                <input type="text" value="${product.name || ''}" oninput="updateProduct('${categoryKey}', ${index}, 'name', this.value)" class="w-full">
                            </td>
                            <td class="px-2 py-2 price-cell">
                                <div class="price-wrapper">
                                    <div class="flex items-center gap-1">
                                        <span class="text-gray-400 font-semibold text-lg">$</span>
                                        <input type="text" value="${product.price ? product.price.toLocaleString('es-AR') : ''}" 
                                            oninput="formatPriceInput(this)"
                                            onchange="updatePriceFromInput(this, '${categoryKey}', ${index})"
                                            onkeydown="if(event.key === 'Enter'){ event.preventDefault(); this.blur(); }"
                                            class="text-left" style="width: 100px;">
                                    </div>
                                    <div class="price-history-tooltip">${tooltipTableHTML}</div>
                                </div>
                            </td>
                            ${customColumns}
                            <td class="px-2 py-2 text-center hidden md:table-cell">
                                <input type="checkbox" ${product.visible ? 'checked' : ''} onchange="updateProduct('${categoryKey}', ${index}, 'visible', this.checked ? 1 : 0)" class="w-5 h-5 rounded text-indigo-500 bg-gray-700 border-gray-600 focus:ring-indigo-600">
                            </td>
                            <td class="px-1 py-2 text-right hidden md:table-cell">
                                <div class="flex flex-col items-end gap-1">
                                    <div class="flex items-center">
                                        ${priceCheckButton}
                                        ${chartButton}
                                        <button onclick="removeProduct('${categoryKey}', ${index})" class="text-red-500 hover:text-red-700 ml-2" title="Eliminar">
                                            <span class="lucide-icon w-4 h-4" data-lucide="trash-2"></span>
                                        </button>
                                        <button draggable="true" ondragstart="onRowDragStart(event, '${categoryKey}', ${index})" class="text-gray-400 hover:text-indigo-400 ml-2 cursor-move" title="Arrastrar para reordenar">
                                            <span class="lucide-icon w-4 h-4" data-lucide="move"></span>
                                        </button>
                                    </div>
                                    <div class="flex items-center gap-1">
                                        <a href="${product.link || '#'}" target="_blank" class="btn btn-secondary min-w-0 flex items-center justify-center text-xs py-1 px-1">
                                            <span class="lucide-icon mr-1" data-lucide="external-link" style="margin-right:2px;"></span>Visitar
                                        </a>
                                        <button onclick="replaceLink('${categoryKey}', ${index})" class="btn btn-primary text-xs py-1 px-1 ml-1" title="Reemplazar Link desde portapapeles">
                                            <span class="lucide-icon" data-lucide="edit"></span>
                                        </button>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    `}).join('')}
                    <tr class="hidden md:table-row">
                        <td colspan="${colspan}" class="add-row-button-cell">
                             <div class="flex justify-end items-center gap-4">
                                <button onclick="addProduct('${categoryKey}')" class="add-row-button">
                                    <span class="lucide-icon mr-2" data-lucide="plus"></span>Añadir
                                </button>
                                <button id="add-from-clipboard-${categoryKey}" onclick="addProductFromClipboard('${categoryKey}')" class="add-row-button bg-sky-600 hover:bg-sky-700">
                                    <span class="lucide-icon mr-2" data-lucide="clipboard-plus"></span>Añadir Link
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            `;
            categoryDiv.appendChild(table);
            overviewContainer.appendChild(categoryDiv);
        });
        lucide.createIcons();
    }

    // --- Drag and Drop for Table Rows ---
    let dragSrcIndex = null;
    let dragSrcCategory = null;

    function onRowDragStart(event, categoryKey, index) {
        dragSrcIndex = index;
        dragSrcCategory = categoryKey;
        event.dataTransfer.effectAllowed = 'move';
    }
    function onRowDragOver(event) {
        event.preventDefault();
        event.dataTransfer.dropEffect = 'move';
    }
    function onRowDrop(event, categoryKey, index) {
        event.preventDefault();
        if (dragSrcCategory === categoryKey && dragSrcIndex !== null && dragSrcIndex !== index) {
            const arr = dataMap[categoryKey];
            const moved = arr.splice(dragSrcIndex, 1)[0];
            arr.splice(index, 0, moved);
            renderOverviewTables();
            saveDataToSessionStorage();
        }
        dragSrcIndex = null;
        dragSrcCategory = null;
    }

    // --- Add Product from Clipboard (Modified) ---
    async function addProductFromClipboard(categoryKey) {
        const btn = document.getElementById(`add-from-clipboard-${categoryKey}`);
        const originalContent = btn.innerHTML;
        btn.innerHTML = `<svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
        btn.disabled = true;

        try {
            let link = await navigator.clipboard.readText();
            if (!link || !link.trim().startsWith('http')) {
                throw new Error('El portapapeles no contiene un link válido.');
            }
            link = modifyMercadoLibreLink(link.trim());
            
            const newId = generateUniqueId(getAllIds());
            const categoryInfo = CATEGORY_NAV_LIST.find(cat => cat.key === categoryKey);
            let imageUrl = '';
            if (categoryInfo && categoryInfo.folder) {
                imageUrl = `comps/${categoryInfo.folder}/${newId}.webp`;
            }

            const newProduct = {
                id: newId,
                name: 'Nuevo Producto desde Link',
                price: 0,
                link: link,
                visible: 1,
                image_url: imageUrl
            };

            if (categoryKey === 'miniPcOptions') {
                newProduct.cpu = '';
                newProduct.ram = '';
                newProduct.ssd = '';
            } else {
                newProduct.description = '';
            }

            addProduct(categoryKey, newProduct);
            showToast('Producto añadido desde el link.');

        } catch (error) {
            console.error('Error al añadir desde clipboard:', error);
            showToast(error.message, 'error');
        } finally {
            btn.innerHTML = originalContent;
            btn.disabled = false;
            lucide.createIcons({
                nodes: [btn.querySelector('.lucide-icon')],
            });
        }
    }

    // --- MODIFIED: Price Check Popup & Loop Logic (No iframe) ---

    function openPriceCheckPopup(categoryKey, index, isFromLoop = false) {
        const product = dataMap[categoryKey][index];
        if (!product || !product.link) return;

        // Open product link in a new tab
        window.open(product.link, '_blank');

        const popup = document.getElementById('price-check-popup');
        const title = document.getElementById('popup-title');
        const currentPriceEl = document.getElementById('popup-current-price');
        const newPriceInput = document.getElementById('popup-new-price');
        
        title.textContent = `Chequeando: ${product.name}`;
        currentPriceEl.textContent = `$${(product.price || 0).toLocaleString('es-AR')}`;
        
        newPriceInput.value = '';
        newPriceInput.dataset.categoryKey = categoryKey;
        newPriceInput.dataset.index = index;
        newPriceInput.dataset.isFromLoop = isFromLoop; 

        popup.classList.remove('hidden');
        newPriceInput.focus();
    }

    function closePriceCheckPopup() {
        if (isLoopRunning) {
            pausePriceCheckLoop();
        }
        const popup = document.getElementById('price-check-popup');
        popup.classList.add('hidden');
    }

    // --- MODIFIED: handleManualPriceCheck to show previous price ---
    function handleManualPriceCheck(event) {
        if (event.key !== 'Enter') return;

        const input = event.target;
        const { categoryKey, index, isFromLoop } = input.dataset;
        const product = dataMap[categoryKey][index];
        const oldPrice = product.price || 0;
        let newPrice;

        if (!input.value.trim()) {
            newPrice = oldPrice; // If empty, price is unchanged
        } else {
            const rawValue = input.value.replace(/[^\d]/g, '');
            newPrice = parseInt(rawValue, 10);
        }

        if (isNaN(newPrice) || !product) {
            showToast('Por favor, ingrese un precio válido.', 'error');
            return;
        }

        updateProduct(categoryKey, index, 'price', newPrice); 
        
        const tableRow = document.getElementById(`row-${categoryKey}-${index}`);
        const priceInputInTable = tableRow.querySelector('.price-cell input');
        if(priceInputInTable) {
            priceInputInTable.value = newPrice.toLocaleString('es-AR');
        }
        
        applyPriceChangeVisuals(tableRow, oldPrice, newPrice); // REPLACED LOGIC

        showToast(`Precio de "${product.name}" actualizado a $${newPrice.toLocaleString('es-AR')}.`);
        
        const popup = document.getElementById('price-check-popup');
        popup.classList.add('hidden'); 

        if (isFromLoop === 'true') {
            currentQueueIndex++;
            sessionStorage.setItem('priceCheckQueueIndex', currentQueueIndex);
            setTimeout(processNextInQueue, 1000); 
        }
    }

    // --- NEW: Price Chart Popup Logic ---
    function openPriceChartPopup(categoryKey, index) {
        const product = dataMap[categoryKey][index];
        if (!product || !product.prices || product.prices.length === 0) {
            showToast('No hay historial de precios para este producto.', 'error');
            return;
        }

        const popup = document.getElementById('price-chart-popup');
        const title = document.getElementById('chart-popup-title');
        title.textContent = `Historial de: ${product.name}`;

        const historicalData = [...product.prices]
            .filter(p => p.value > 0)
            .reverse();

        const labels = historicalData.map(p => formatTimestamp(p.date).split(',')[0]);
        const data = historicalData.map(p => p.value);

        popup.classList.remove('hidden');
        lucide.createIcons();

        const ctx = document.getElementById('price-chart-canvas').getContext('2d');
        
        if (priceChartInstance) {
            priceChartInstance.destroy();
        }

        priceChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Precio',
                    data: data,
                    borderColor: 'rgba(139, 92, 246, 1)',
                    backgroundColor: 'rgba(139, 92, 246, 0.2)',
                    borderWidth: 2,
                    tension: 0.1,
                    fill: true,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        ticks: { color: '#e5e7eb' },
                        grid: { color: 'rgba(55, 65, 81, 0.5)' }
                    },
                    x: {
                         ticks: { color: '#e5e7eb' },
                         grid: { display: false }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = 'Precio: ';
                                if (context.parsed.y !== null) {
                                    label += new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

    function closePriceChartPopup() {
        const popup = document.getElementById('price-chart-popup');
        popup.classList.add('hidden');
        if (priceChartInstance) {
            priceChartInstance.destroy();
            priceChartInstance = null;
        }
    }


    function buildPriceCheckQueue() {
        priceCheckQueue = [];
        const twoHoursInMs = 2 * 60 * 60 * 1000;
        const twoHoursAgo = new Date(Date.now() - twoHoursInMs);

        CATEGORY_NAV_LIST.forEach(category => {
            const categoryKey = category.key;
            if (!categoryKey.includes('Options')) return;
            
            (dataMap[categoryKey] || []).forEach((product, index) => {
                if (product.visible && product.link) {
                    if (!product.lastUpd || new Date(product.lastUpd) < twoHoursAgo) {
                        priceCheckQueue.push({ categoryKey, index });
                    }
                }
            });
        });
    }


    function togglePriceCheckLoop() {
        if (isLoopRunning) {
            pausePriceCheckLoop();
        } else {
            startPriceCheckLoop();
        }
    }

    function startPriceCheckLoop() {
        isLoopRunning = true;
        updateLoopButtonUI(true);

        buildPriceCheckQueue(); 
        currentQueueIndex = parseInt(sessionStorage.getItem('priceCheckQueueIndex') || '0', 10);
        
        if(currentQueueIndex >= priceCheckQueue.length) {
            currentQueueIndex = 0;
            sessionStorage.setItem('priceCheckQueueIndex', '0');
        }
        
        if (priceCheckQueue.length === 0) {
            showToast('No hay productos para chequear (visibles, con link y no actualizados en las últimas 2hs).', 'error');
            resetPriceCheckLoop();
            return;
        }

        processNextInQueue();
    }

    function pausePriceCheckLoop() {
        isLoopRunning = false;
        updateLoopButtonUI(false);
        showToast('Chequeo en lote pausado.');
    }
    
    function resetPriceCheckLoop() {
        isLoopRunning = false;
        priceCheckQueue = [];
        currentQueueIndex = 0;
        sessionStorage.removeItem('priceCheckQueueIndex');
        updateLoopButtonUI(false);
    }

    function processNextInQueue() {
        if (!isLoopRunning) return;

        if (currentQueueIndex >= priceCheckQueue.length) {
            showToast('¡Chequeo en lote completado!', 'success');
            resetPriceCheckLoop();
            return;
        }

        const item = priceCheckQueue[currentQueueIndex];
        updateLoopButtonUI(true, `(${currentQueueIndex + 1}/${priceCheckQueue.length})`);
        scrollToComponentRow(item.categoryKey, item.index);
        
        setTimeout(() => {
            openPriceCheckPopup(item.categoryKey, item.index, true);
        }, 200);
    }
    
    function updateLoopButtonUI(isRunning, progressText = '') {
        const btn = document.getElementById('price-check-loop-btn');
        const btnText = document.getElementById('price-check-loop-btn-text');
        const icon = btn.querySelector('.lucide-icon');

        if (isRunning) {
            btnText.textContent = `Pausar Chequeo ${progressText}`;
            icon.setAttribute('data-lucide', 'pause-circle');
        } else {
            if (currentQueueIndex > 0 && currentQueueIndex < priceCheckQueue.length) {
                 btnText.textContent = `Continuar Chequeo (${currentQueueIndex}/${priceCheckQueue.length})`;
            } else {
                 btnText.textContent = 'Chequeo en Lote';
            }
            icon.setAttribute('data-lucide', 'play-circle');
        }
        lucide.createIcons({nodes: [icon]});
    }

    // --- Code Export ---

    function generateCode() {
        const exportData = JSON.parse(JSON.stringify(dataMap));
        for (const mapKey in exportData) {
            if (mapKey.includes('Options')) {
                exportData[mapKey].forEach(p => {
                    // Set the price to the most recent one
                    p.price = p.prices && p.prices.length > 0 ? p.prices[0].value : 0;
                    // Remove the prices array for the current price JSON
                    delete p.prices;
                });
            }
        }
        
        const code = JSON.stringify(exportData, null, 2);
        document.getElementById('output-code').value = code;
        return code;
    }

    function copyCode() {
        const outputTextArea = document.getElementById('output-code');
        generateCode();
        outputTextArea.select();
        document.execCommand('copy');
        showToast('¡Código Actual copiado al portapapeles!');
    }

    // NEW: Function to generate JSON with price history
    function generateHistoryCode() {
        const exportData = JSON.parse(JSON.stringify(dataMap));
        for (const mapKey in exportData) {
             if (mapKey.includes('Options')) {
                exportData[mapKey].forEach(p => {
                    // Remove the transient 'price' property, keeping the 'prices' array
                    delete p.price;
                    delete p.lastUpd; // Also remove transient lastUpd
                });
            }
        }

        const code = JSON.stringify(exportData, null, 2);
        document.getElementById('output-code').value = code;
        return code;
    }

    // NEW: Function to copy the history JSON
    function copyHistoryCode() {
        const outputTextArea = document.getElementById('output-code');
        generateHistoryCode();
        outputTextArea.select();
        document.execCommand('copy');
        showToast('¡Historial de precios copiado al portapapeles!');
    }


    function resetSessionAndReload() {
        sessionStorage.removeItem('productAdminData');
        sessionStorage.removeItem('priceCheckQueueIndex'); 
        location.reload();
    }

    // MODIFIED: Load from productsH.json
    async function reloadDataFromJson() {
        try {
            const response = await fetch('productsH.json?cache_bust=' + new Date().getTime());
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const dataToLoad = await response.json();
            
            for (const key in dataMap) {
                if (dataToLoad.hasOwnProperty(key)) {
                    dataMap[key] = dataToLoad[key];
                } else {
                    dataMap[key] = [];
                }
            }
            
            sanitizeAndAssignDefaults();
            updateAllBaseTotals();
            updateAllBundleTotals();
            renderBasesSection();
            renderBundlesSection();
            renderOverviewTables();
            saveDataToSessionStorage();
            showToast('Datos recargados desde productsH.json');

        } catch (error) {
            console.error("Error reloading from JSON:", error);
            showToast('Error al recargar el archivo productsH.json.', 'error');
        }
    }
    
    // --- Page Initialization ---
    document.addEventListener('DOMContentLoaded', async () => {
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                if (!document.getElementById('price-check-popup').classList.contains('hidden')) {
                    closePriceCheckPopup();
                }
                if (!document.getElementById('price-chart-popup').classList.contains('hidden')) {
                    closePriceChartPopup();
                }
            }
        });

        let dataToLoad = null;
        const storedData = loadDataFromSessionStorage();

        if (storedData) {
            dataToLoad = storedData;
            showToast('¡Datos restaurados de la sesión anterior!', 'success');
        } else {
            try {
                // MODIFIED: Load from productsH.json by default
                const response = await fetch('productsH.json?cache_bust=' + new Date().getTime());
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                dataToLoad = await response.json();
            } catch (error) {
                console.error('Error loading productsH.json:', error);
                showToast('No se pudo cargar productsH.json. Se iniciará con datos vacíos.', 'error');
            }
        }

        if (dataToLoad) {
            for (const key in dataMap) {
                if (dataToLoad.hasOwnProperty(key)) {
                    dataMap[key] = dataToLoad[key];
                }
            }
        }
        
        sanitizeAndAssignDefaults();
        updateAllBaseTotals();
        updateAllBundleTotals();
        renderCategoryNavbar();
        renderBasesSection();
        renderBundlesSection();
        renderOverviewTables();
        saveDataToSessionStorage();
        lucide.createIcons();
        
        buildPriceCheckQueue(); 
        currentQueueIndex = parseInt(sessionStorage.getItem('priceCheckQueueIndex') || '0', 10);
        if (currentQueueIndex > 0 && currentQueueIndex < priceCheckQueue.length) {
            updateLoopButtonUI(false); 
        }
        
        window.addEventListener('resize', updateNavbarSpacer);

        // Accordion Logic
        document.querySelectorAll('.accordion-header').forEach(header => {
            header.addEventListener('click', () => {
                const content = header.nextElementSibling;
                const icon = header.querySelector('.lucide-icon');
                content.classList.toggle('hidden');
                icon.classList.toggle('rotate-180');
            });
        });
    });

</script>
</body>
</html>

